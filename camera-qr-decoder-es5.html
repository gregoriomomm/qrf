<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Camera QR Decoder</title>
</head>
<body>
    <h1>Simple Camera QR Code Reader</h1>
    
    <select id="cameraSelect">
        <option value="">Select Camera</option>
    </select>
    
    <button onclick="startCamera()">Start Camera</button>
    <button onclick="stopCamera()">Stop Camera</button>
    
    <div>
        <video id="video" width="320" height="240" autoplay></video>
    </div>
    
    <div id="result">No QR code detected</div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        var html5QrCode;
        var currentStream;
        
        // Initialize camera list
        function initCameraList() {
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                // First request camera permission to get proper device labels
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Stop the stream immediately - we just needed permission
                        stream.getTracks().forEach(function(track) {
                            track.stop();
                        });
                        
                        // Now enumerate devices with proper labels
                        return navigator.mediaDevices.enumerateDevices();
                    })
                    .then(function(devices) {
                        var videoDevices = devices.filter(function(device) {
                            return device.kind === 'videoinput';
                        });
                        
                        var select = document.getElementById('cameraSelect');
                        select.innerHTML = '<option value="">Select Camera</option>';
                        
                        videoDevices.forEach(function(device, index) {
                            var option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = device.label || 'Camera ' + (index + 1);
                            select.appendChild(option);
                        });
                        
                        if (videoDevices.length === 1) {
                            select.value = videoDevices[0].deviceId;
                        }
                        
                        console.log('Found ' + videoDevices.length + ' cameras');
                    })
                    .catch(function(err) {
                        console.error('Error getting cameras:', err);
                        // Fallback - try without permission request
                        navigator.mediaDevices.enumerateDevices()
                            .then(function(devices) {
                                var videoDevices = devices.filter(function(device) {
                                    return device.kind === 'videoinput';
                                });
                                
                                var select = document.getElementById('cameraSelect');
                                select.innerHTML = '<option value="">Select Camera</option>';
                                
                                videoDevices.forEach(function(device, index) {
                                    var option = document.createElement('option');
                                    option.value = device.deviceId || 'camera' + index;
                                    option.textContent = 'Camera ' + (index + 1);
                                    select.appendChild(option);
                                });
                            })
                            .catch(function(err2) {
                                console.error('Fallback enumeration failed:', err2);
                            });
                    });
            } else {
                alert('Camera access not supported in this browser');
            }
        }
        
        function startCamera() {
            var cameraSelect = document.getElementById('cameraSelect');
            var cameraId = cameraSelect.value;
            
            if (!cameraId) {
                alert('Please select a camera first');
                return;
            }
            
            var config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode = new Html5Qrcode("video");
            
            html5QrCode.start(
                cameraId,
                config,
                function(decodedText, decodedResult) {
                    document.getElementById('result').innerHTML = 'QR Code: ' + decodedText;
                },
                function(errorMessage) {
                    // Handle scan failure, usually better to ignore
                }
            ).then(function() {
                console.log('Camera started');
            }).catch(function(err) {
                console.error('Error starting camera:', err);
                alert('Error starting camera: ' + err);
            });
        }
        
        function stopCamera() {
            if (html5QrCode) {
                html5QrCode.stop().then(function() {
                    console.log('Camera stopped');
                }).catch(function(err) {
                    console.error('Error stopping camera:', err);
                });
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initCameraList();
        });
    </script>
</body>
</html>