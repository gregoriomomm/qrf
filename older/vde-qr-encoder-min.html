<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>QR File Transfer - Optimized Encoder</title><script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script><style>#qrDisplay,.panel{padding:20px;background:#fff}.control-label,.countdown-display,.info-label,.value-display,button{font-weight:700}*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;line-height:1.5;background:#f5f5f5;color:#333;max-width:1200px;margin:0 auto;padding:20px}h1{margin:20px 0;color:#2563eb}.container{display:flex;flex-wrap:wrap;gap:20px}.panel{border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);flex:1;min-width:300px}.control-panel{display:flex;flex-direction:column;gap:15px}.control-group,.display-container{flex-direction:column;display:flex}.control-group{gap:8px}button{padding:12px;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-top:10px;transition:background .2s}button:hover{background:#1d4ed8}button:disabled{background:#94a3b8;cursor:not-allowed}.display-container{align-items:center;justify-content:center}#qrDisplay{position:relative;margin:0 auto 20px;border:1px solid #ddd;border-radius:8px;max-width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}.progress-container{width:100%;background:#e5e7eb;border-radius:4px;overflow:hidden;height:10px;margin-top:15px}.progress-bar{height:100%;background:#2563eb;width:0;transition:width .3s}.file-info,.metadata-info{background:#f0f9ff;border-radius:8px}.file-info{margin-top:20px;padding:15px;border-left:4px solid #2563eb}.metadata-info{margin-top:10px;padding:10px;border-left:4px solid #1d4ed8}.info-row{display:flex;justify-content:space-between;margin-bottom:8px}.info-label{color:#1e40af}.fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:1000;display:flex;justify-content:center;align-items:center;flex-direction:column}.exit-button,.fullscreen-counter{top:20px;color:#fff;position:absolute}.fullscreen .qr-container{display:flex;justify-content:center;align-items:center;width:80vmin;height:80vmin;position:relative}.fullscreen-qr{width:100%;height:100%;object-fit:contain;max-width:95vh;max-height:95vh}.fullscreen-progress{position:absolute;bottom:50px;width:80%;max-width:400px}.fullscreen-counter{left:20px;background:rgba(0,0,0,.5);padding:10px;border-radius:4px;font-weight:700;font-size:16px;z-index:10}.exit-button{right:20px;background:#ef4444;border:none;width:40px;height:40px;border-radius:20px;font-size:20px;cursor:pointer}.countdown-display{font-size:120px;color:#1890ff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-shadow:0 0 10px rgba(24,144,255,.5);z-index:100;display:none;background:rgba(0,0,0,.4);width:200px;height:200px;border-radius:50%;line-height:200px;text-align:center}.file-input-label,input[type=range]{background:#e5e7eb;border-radius:4px}.fullscreen .countdown-display{width:250px;height:250px;line-height:250px;font-size:150px;background:rgba(0,0,0,.6)}input[type=range]{width:100%;height:8px;appearance:none;outline:0}input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;background:#2563eb;border-radius:50%;cursor:pointer}.slider-labels{display:flex;justify-content:space-between;font-size:12px;color:#6b7280;margin-top:5px}.value-display{color:#2563eb;margin-left:auto}.file-input-container{position:relative;overflow:hidden;display:inline-block;width:100%}.file-input-label{padding:12px;color:#333;cursor:pointer;display:block;text-align:center;transition:background .2s}.file-input-label:hover,.preset-button:hover{background:#d1d5db}.file-input-container input[type=file]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}.control-switch{display:flex;align-items:center;cursor:pointer;user-select:none;margin:10px 0}.control-switch input[type=checkbox]{margin-right:8px;width:16px;height:16px}.switch-label{font-weight:500}.action-button{background-color:#16a34a;width:100%;padding:14px;font-size:16px}.guide-label,.tooltip:hover::after{position:absolute;color:#fff;font-size:12px}.action-button:hover{background-color:#15803d}.alignment-guide{position:absolute;border:3px dashed rgba(59,130,246,.7);pointer-events:none;display:none}#qrDisplay.show-guides .alignment-guide{display:block}.guide-label{background:rgba(0,0,0,.6);padding:2px 6px;border-radius:4px;pointer-events:none}.preset-button,.tooltip{background:#e5e7eb;text-align:center}.qr-image{transition:opacity .15s ease-out}.preset-selector{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}.preset-button{padding:8px 12px;color:#333;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;flex:1;min-width:120px;transition:.2s}.preset-button.active{background:#2563eb;color:#fff;border-color:#2563eb}.tooltip{position:relative;display:inline-block;margin-left:5px;width:16px;height:16px;color:#6b7280;border-radius:50%;line-height:16px;font-size:11px;font-weight:700;cursor:help}.tooltip:hover::after{content:attr(data-tooltip);top:-5px;left:100%;transform:translateY(-100%);background:rgba(55,65,81,.9);padding:5px 10px;border-radius:4px;width:200px;font-weight:400;z-index:10;line-height:1.4}.handshake-notice{margin-top:20px;padding:10px;background:rgba(245,158,11,.1);border-left:3px solid #f59e0b;border-radius:3px;font-size:13px;color:#92400e}@media (max-width:768px){.container{flex-direction:column}.handshake-notice,.preset-selector{font-size:11px}.preset-button{padding:6px 8px;min-width:90px}.control-label{font-size:14px}h1{font-size:20px;margin:10px 0}.panel{padding:15px}.slider-labels{font-size:10px}.countdown-display{width:150px;height:150px;line-height:150px;font-size:90px}}</style></head><body><h1>QR Code File Encoder</h1><div class="container"><div class="panel control-panel"><div class="control-group"><label class="control-label">Select File</label><div class="file-input-container"><label class="file-input-label"><span id="fileLabel">Choose a file</span> <input type="file" id="fileInput"></label></div></div><div class="control-group"><label class="control-label">Performance Presets</label><div class="preset-selector"><button id="fastPreset" class="preset-button">Fast Transfer</button> <button id="reliablePreset" class="preset-button active">Reliable</button> <button id="mobilePreset" class="preset-button">Mobile Optimized</button></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Presets automatically configure optimal settings for your use case</div></div><div class="control-group"><div class="control-label">QR Size <span class="value-display" id="sizeValue">500px</span> <span class="tooltip" data-tooltip="Size of the QR code in pixels. Larger QR codes are easier to scan but may not fit on screen.">?</span></div><input type="range" id="sizeSlider" min="200" max="800" value="500"><div class="slider-labels"><span>Smaller</span> <span>Larger</span></div></div><div class="control-group"><div class="control-label">Display Speed <span class="value-display" id="speedValue">10 FPS</span> <span class="tooltip" data-tooltip="Frames per second. Higher values transfer data faster, but may be harder to scan.">?</span></div><input type="range" id="speedSlider" min="1" max="30" value="10"><div class="slider-labels"><span>Slower</span> <span>Faster</span></div></div><div class="control-group"><div class="control-label">Chunk Size <span class="value-display" id="chunkValue">500 chars</span> <span class="tooltip" data-tooltip="Size of each data chunk. Larger chunks transfer faster but may be harder to scan.">?</span></div><input type="range" id="chunkSlider" min="100" max="1000" step="50" value="500"><div class="slider-labels"><span>Smaller chunks</span> <span>Larger chunks</span></div></div><div class="control-group"><div class="control-label">Redundancy <span class="value-display" id="redundancyValue">60%</span> <span class="tooltip" data-tooltip="Extra data to ensure successful transfer. Higher values improve reliability but increase transfer time.">?</span></div><input type="range" id="redundancySlider" min="20" max="200" step="10" value="60"><div class="slider-labels"><span>Less</span> <span>More</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">For 30% missed frames, use 60-70% redundancy<br>For 50% missed frames, use 100-120% redundancy</div></div><div class="control-group"><div class="control-label">Error Correction Level <span class="tooltip" data-tooltip="QR code error correction level. Higher levels are more reliable but create larger, more complex QR codes.">?</span></div><div style="display: flex; justify-content: space-between; margin-top: 5px;"><select id="errorCorrectionSelect" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d1d5db;"><option value="H">High (30% recovery)</option><option value="M">Medium (15% recovery)</option><option value="L">Low (7% recovery)</option></select></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Higher correction = more reliable but larger QR codes</div></div><div class="control-group"><div class="control-label">Max Combined Chunks <span class="value-display" id="maxDegreeValue">2</span> <span class="tooltip" data-tooltip="Maximum number of chunks to combine in a single QR code. Lower is safer for reliable scanning.">?</span></div><input type="range" id="maxDegreeSlider" min="1" max="4" step="1" value="2"><div class="slider-labels"><span>Safer (1)</span> <span>Denser (4)</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Recommend 1-2 for highest reliability; 3-4 only for perfect conditions</div></div><div class="control-group"><div class="control-label">Countdown Before Start <span class="value-display" id="countdownValue">10s</span> <span class="tooltip" data-tooltip="Time to prepare before QR codes start displaying.">?</span></div><input type="range" id="countdownSlider" min="0" max="30" value="10"><div class="slider-labels"><span>None</span> <span>30s</span></div></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="fullscreenCheckbox" checked="checked"> <span class="switch-label">Start in Fullscreen Mode (Recommended)</span></label></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="showGuidesCheckbox"> <span class="switch-label">Show Scanner Alignment Guides</span></label></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="enableTransitionsCheckbox" checked="checked"> <span class="switch-label">Enable Smooth Transitions</span> <span class="tooltip" data-tooltip="Enables subtle transitions between QR codes to improve scanning reliability.">?</span></label><div style="font-size: 12px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Always on for best results; disable only for older devices</div></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="highDensityCheckbox"> <span class="switch-label">High Density Mode</span> <span class="tooltip" data-tooltip="Increases QR code data capacity but requires enhanced scanner capabilities.">?</span></label><div style="font-size: 12px; color: #6b7280; margin-top: 5px; margin-left: 24px;">WARNING: Only enable if using the enhanced parallel processing decoder</div></div><div class="control-group"><button id="generateAndStartBtn" class="action-button" disabled="disabled">Generate & Start Display</button><div style="display: flex; gap: 10px; margin-top: 5px;"><button id="generateBtn" disabled="disabled">Generate QR Codes</button> <button id="stopBtn" disabled="disabled" style="flex: 1; background: #dc2626;">Stop</button></div><div style="display: flex; gap: 10px; margin-top: 5px;"><button id="startBtn" disabled="disabled" style="flex: 1;">Start Display</button> <button id="fullscreenBtn" disabled="disabled" style="flex: 1; background: #4b5563;">Fullscreen</button></div></div><div class="handshake-notice"><strong>Handshake Mode</strong>: The first frame contains special setup data that helps the decoder optimize for your specific transfer. Make sure to scan this frame.</div></div><div class="panel"><div class="display-container"><div id="frameCounter" style="margin-bottom: 10px; font-weight: bold;">Frame: 0 / 0</div><div id="qrDisplay" style="width: 500px; height: 500px; display: flex; align-items: center; justify-content: center;"><div class="alignment-guide" style="width: 90%; height: 90%; top: 5%; left: 5%;"></div><div class="alignment-guide" style="width: 70%; height: 70%; top: 15%; left: 15%;"></div><div class="guide-label" style="top: 2%; left: 50%; transform: translateX(-50%);">Keep QR code within this area</div><div style="color: #6b7280;">QR code will appear here</div><div id="countdownDisplay" class="countdown-display"></div></div><div class="progress-container"><div class="progress-bar" id="progressBar"></div></div></div><div id="fileInfo" class="file-info" style="display: none;"><h3 style="margin-bottom: 10px;">File Information</h3><div class="info-row"><div class="info-label">File Name:</div><div id="fileName">-</div></div><div class="info-row"><div class="info-label">File Size:</div><div id="fileSize">-</div></div><div class="info-row"><div class="info-label">Chunks:</div><div id="chunksCount">-</div></div><div class="info-row"><div class="info-label">Packets:</div><div id="packetsCount">-</div></div><div class="info-row"><div class="info-label">Redundancy Level:</div><div id="redundancyLevel">-</div></div><div class="info-row"><div class="info-label">Transfer Time:</div><div id="transferTime">-</div></div><div class="info-row"><div class="info-label">Optimal Distance:</div><div id="optimalDistance">-</div></div><div class="info-row high-density-indicator" style="display: none;"><div class="info-label" style="color: #b91c1c;">High Density Mode:</div><div style="color: #b91c1c; font-weight: bold;">Active</div></div></div><div id="metadataInfo" class="metadata-info" style="display: none;"><h3 style="margin-bottom: 10px;">Transmission Details</h3><div id="qrCodeInfo" style="margin-bottom: 10px;"><div style="font-weight: bold; color: #1e40af;">Current Frame Type:</div><div id="frameType">-</div></div><div id="currentChunkInfo" style="margin-bottom: 10px; display: none;"><div style="font-weight: bold; color: #1e40af;">Current Chunk:</div><div id="chunkId">-</div></div><div id="transmissionStats" style="margin-top: 10px;"><div style="font-weight: bold; color: #1e40af;">Transmission Stats:</div><div>Elapsed Time: <span id="elapsedTime">0s</span></div><div>Avg Speed: <span id="transmissionSpeed">-</span></div></div></div></div></div><div id="fullscreenDisplay" class="fullscreen" style="display: none;"><div class="qr-container"><img id="fullscreenQR" class="fullscreen-qr" src="" alt="QR Code"><div id="fsCountdownDisplay" class="countdown-display"></div></div><div class="fullscreen-counter" id="fullscreenCounter">Frame: 0 / 0</div><div class="fullscreen-progress progress-container"><div class="progress-bar" id="fullscreenProgressBar"></div></div><button class="exit-button" id="exitFullscreenBtn">&times;</button></div><script>const DEFAULT_QR_CONTENT_SIZE=2500,HIGH_DENSITY_QR_CONTENT_SIZE=4e3;let MAX_QR_CONTENT_SIZE=2500;const fileInput=document.getElementById("fileInput"),fileLabel=document.getElementById("fileLabel"),speedSlider=document.getElementById("speedSlider"),sizeSlider=document.getElementById("sizeSlider"),chunkSlider=document.getElementById("chunkSlider"),redundancySlider=document.getElementById("redundancySlider"),countdownSlider=document.getElementById("countdownSlider"),maxDegreeSlider=document.getElementById("maxDegreeSlider"),speedValue=document.getElementById("speedValue"),sizeValue=document.getElementById("sizeValue"),chunkValue=document.getElementById("chunkValue"),redundancyValue=document.getElementById("redundancyValue"),maxDegreeValue=document.getElementById("maxDegreeValue"),countdownValue=document.getElementById("countdownValue"),errorCorrectionSelect=document.getElementById("errorCorrectionSelect"),fullscreenCheckbox=document.getElementById("fullscreenCheckbox"),showGuidesCheckbox=document.getElementById("showGuidesCheckbox"),enableTransitionsCheckbox=document.getElementById("enableTransitionsCheckbox"),highDensityCheckbox=document.getElementById("highDensityCheckbox"),generateAndStartBtn=document.getElementById("generateAndStartBtn"),generateBtn=document.getElementById("generateBtn"),startBtn=document.getElementById("startBtn"),stopBtn=document.getElementById("stopBtn"),fullscreenBtn=document.getElementById("fullscreenBtn"),qrDisplay=document.getElementById("qrDisplay"),progressBar=document.getElementById("progressBar"),frameCounter=document.getElementById("frameCounter"),fileInfo=document.getElementById("fileInfo"),metadataInfo=document.getElementById("metadataInfo"),frameType=document.getElementById("frameType"),chunkId=document.getElementById("chunkId"),currentChunkInfo=document.getElementById("currentChunkInfo"),elapsedTime=document.getElementById("elapsedTime"),transmissionSpeed=document.getElementById("transmissionSpeed"),fileName=document.getElementById("fileName"),fileSize=document.getElementById("fileSize"),chunksCount=document.getElementById("chunksCount"),packetsCount=document.getElementById("packetsCount"),redundancyLevel=document.getElementById("redundancyLevel"),transferTime=document.getElementById("transferTime"),optimalDistance=document.getElementById("optimalDistance"),fullscreenDisplay=document.getElementById("fullscreenDisplay"),fullscreenQR=document.getElementById("fullscreenQR"),fullscreenCounter=document.getElementById("fullscreenCounter"),fullscreenProgressBar=document.getElementById("fullscreenProgressBar"),exitFullscreenBtn=document.getElementById("exitFullscreenBtn"),countdownDisplay=document.getElementById("countdownDisplay"),fsCountdownDisplay=document.getElementById("fsCountdownDisplay"),fastPreset=document.getElementById("fastPreset"),reliablePreset=document.getElementById("reliablePreset"),mobilePreset=document.getElementById("mobilePreset");let fileContent=null,fileNameText="",fileSizeBytes=0,chunks=[],fountainPackets=[],displayInterval=null,currentFrame=0,totalFrames=0,isPlaying=!1,isFullscreen=!1,qrSize=500,startTime=null,transmissionTimer=null,countdownTimer=null,countdownSeconds=10;function applyPreset(e){switch(fastPreset.classList.remove("active"),reliablePreset.classList.remove("active"),mobilePreset.classList.remove("active"),e){case"fast":fastPreset.classList.add("active"),speedSlider.value=12,chunkSlider.value=600,redundancySlider.value=50,maxDegreeSlider.value=2,errorCorrectionSelect.value="M",enableTransitionsCheckbox.checked=!0;break;case"reliable":reliablePreset.classList.add("active"),speedSlider.value=10,chunkSlider.value=500,redundancySlider.value=80,maxDegreeSlider.value=2,errorCorrectionSelect.value="H",enableTransitionsCheckbox.checked=!0;break;case"mobile":mobilePreset.classList.add("active"),speedSlider.value=8,chunkSlider.value=400,redundancySlider.value=100,maxDegreeSlider.value=1,errorCorrectionSelect.value="H",sizeSlider.value=600,qrSize=600,qrDisplay.style.width=`${qrSize}px`,qrDisplay.style.height=`${qrSize}px`,sizeValue.textContent=`${qrSize}px`,enableTransitionsCheckbox.checked=!0}speedValue.textContent=`${speedSlider.value} FPS`,chunkValue.textContent=`${chunkSlider.value} chars`,redundancyValue.textContent=`${redundancySlider.value}%`,maxDegreeValue.textContent=maxDegreeSlider.value}function calculateOptimalSettings(e){return e<5e4?{fps:8,chunkSize:450,redundancy:20,distance:"20-25cm",preset:"fast"}:e<5e5?{fps:5,chunkSize:450,redundancy:40,distance:"25-30cm",preset:"reliable"}:{fps:5,chunkSize:400,redundancy:100,distance:"25-30cm",preset:"mobile"}}function applyOptimalSettings(){if(!fileInput.files.length)return;const e=calculateOptimalSettings(fileSizeBytes);speedSlider.value=e.fps,speedValue.textContent=`${e.fps} FPS`,chunkSlider.value=e.chunkSize,chunkValue.textContent=`${e.chunkSize} chars`,redundancySlider.value=e.redundancy,redundancyValue.textContent=`${e.redundancy}%`,optimalDistance.textContent=e.distance,applyPreset(e.preset)}async function generateQRCodes(){if(!fileInput.files.length)return;const e=fileInput.files[0],t=parseInt(chunkSlider.value),n=parseInt(redundancySlider.value),a=await readFileAsBase64(e);fileContent=a.split(",")[1],chunks=chunkFile(fileContent,t);const s=new SystematicLTEncoder(chunks);s.maxSafeDegree=parseInt(maxDegreeSlider.value),fountainPackets=[s.generateMetadataPacket()];const i=s.calculateTotalPackets();for(let e=1;e<i;e++)fountainPackets.push(s.generatePacket());if(chunks.length>0){const e=s.createSystematicPacket(0);e.p=s.packetCounter,fountainPackets.push(e)}const l=fountainPackets.filter((e=>!1===e.systematic&&void 0===e.metaString)).length,r=fountainPackets.filter((e=>!0===e.systematic)).length,c=Math.ceil(chunks.length*(n/100));if(l<c){const e=c-l;for(let t=0;t<e;t++)s.systematicPhase=!1,fountainPackets.push(s.createLTPacket())}totalFrames=fountainPackets.length,frameCounter.textContent=`Frame: 0 / ${totalFrames}`,fileName.textContent=fileNameText,fileSize.textContent=formatFileSize(fileSizeBytes),chunksCount.textContent=chunks.length,packetsCount.textContent=fountainPackets.length,redundancyLevel.textContent=`${n}% (${Math.round(100*(fountainPackets.length/chunks.length-1))}% effective)`,transferTime.textContent=`~${Math.ceil(totalFrames/parseInt(speedSlider.value))} seconds`,optimalDistance.textContent=calculateOptimalSettings(fileSizeBytes).distance;const d=r,o=l+(fountainPackets.length-d-l-1);if(document.getElementById("phaseInfo"))document.getElementById("phaseDetails").innerHTML=`\n                    <div>Systematic: ${d} packets</div>\n                    <div>Fountain: ${o} packets</div>\n                `;else{const e=document.createElement("div");e.id="phaseInfo",e.className="info-row",e.innerHTML=`\n                    <div class="info-label">Encoding Phases:</div>\n                    <div id="phaseDetails">\n                        <div>Systematic: ${d} packets</div>\n                        <div>Fountain: ${o} packets</div>\n                    </div>\n                `,document.getElementById("fileInfo").appendChild(e)}if(!document.getElementById("ltParams")&&fountainPackets.length>0){const e=document.createElement("div");e.id="ltParams",e.className="info-row",e.innerHTML=`\n                    <div class="info-label">LT Parameters:</div>\n                    <div id="ltDetails">\n                        <div>c: ${s.c.toFixed(2)}</div>\n                        <div>δ: ${s.delta.toFixed(2)}</div>\n                    </div>\n                `,document.getElementById("fileInfo").appendChild(e)}return fileInfo.style.display="block",fountainPackets.length>0&&(await generateQRCodeForFrame(0),currentFrame=0),!0}function startCountdown(){let e=countdownSeconds;countdownDisplay.textContent=e,countdownDisplay.style.display="block",fsCountdownDisplay.textContent=e,fsCountdownDisplay.style.display=isFullscreen?"block":"none",null===qrDisplay.querySelector(".countdown-display")&&qrDisplay.appendChild(countdownDisplay),startBtn.disabled=!0,countdownTimer=setInterval((()=>{e--,e<=0?(clearInterval(countdownTimer),countdownDisplay.style.display="none",fsCountdownDisplay.style.display="none",startPlaying()):(countdownDisplay.textContent=e,fsCountdownDisplay.textContent=e)}),1e3)}function startPlaying(){isPlaying=!0,startBtn.disabled=!0,stopBtn.disabled=!1,currentFrame=0,startTime=Date.now(),metadataInfo.style.display="block",transmissionTimer=setInterval(updateTransmissionStats,1e3);const e=1e3/parseInt(speedSlider.value);displayInterval=setInterval((async()=>{if(currentFrame=(currentFrame+1)%totalFrames,await generateQRCodeForFrame(currentFrame),updateProgress(),enableTransitionsCheckbox.checked){const e=qrDisplay.querySelector("img");e&&e.classList.add("qr-image"),isFullscreen&&fullscreenQR&&fullscreenQR.classList.add("qr-image")}}),e)}function stopPlaying(){countdownTimer&&(clearInterval(countdownTimer),countdownTimer=null,countdownDisplay.style.display="none",isFullscreen&&(fsCountdownDisplay.style.display="none")),displayInterval&&(clearInterval(displayInterval),displayInterval=null),transmissionTimer&&(clearInterval(transmissionTimer),transmissionTimer=null),isPlaying=!1,startBtn.disabled=!1,stopBtn.disabled=!0}function enterFullscreenMode(){isFullscreen=!0,fullscreenDisplay.style.display="flex",isPlaying&&stopPlaying(),currentFrame>=0&&fountainPackets.length>0&&generateQRCodeForFrame(currentFrame,!0)}function updateTransmissionStats(){if(!isPlaying||!startTime)return;const e=(Date.now()-startTime)/1e3,t=formatTime(e);elapsedTime.textContent=t;const n=fileSizeBytes*Math.min(currentFrame/totalFrames,1)/e;transmissionSpeed.textContent=`${formatFileSize(n)}/s`}function formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}async function generateQRCodeForFrame(e,t=!1){try{if(!fountainPackets[e])return;const n=fountainPackets[e];let a;0===e&&n.metaString?a=n.metaString:n.dataString&&(a=n.dataString);const s={errorCorrectionLevel:errorCorrectionSelect.value,margin:1,width:t?Math.min(.7*window.innerWidth,.7*window.innerHeight):qrSize,color:{dark:"#000000",light:"#FFFFFF"}},i=await new Promise(((e,t)=>{QRCode.toDataURL(a,s,((n,a)=>{n?t(n):e(a)}))}));if((t||isFullscreen)&&(fullscreenQR.src=i,fullscreenCounter.textContent=`Frame: ${e+1} / ${totalFrames}`,enableTransitionsCheckbox.checked&&fullscreenQR.classList.add("qr-image"),"block"===countdownDisplay.style.display?(fsCountdownDisplay.style.display="block",fsCountdownDisplay.textContent=countdownDisplay.textContent):fsCountdownDisplay.style.display="none"),qrDisplay.innerHTML=`<img src="${i}" alt="QR Code" style="max-width: 100%; max-height: 100%;">`,enableTransitionsCheckbox.checked){const e=qrDisplay.querySelector("img");e&&e.classList.add("qr-image")}if(showGuidesCheckbox.checked){const e=document.createElement("div");e.className="alignment-guide",e.style="width: 90%; height: 90%; top: 5%; left: 5%;";const t=document.createElement("div");t.className="alignment-guide",t.style="width: 70%; height: 70%; top: 15%; left: 15%;";const n=document.createElement("div");n.className="guide-label",n.style="top: 2%; left: 50%; transform: translateX(-50%);",n.textContent="Keep QR code within this area",qrDisplay.appendChild(e),qrDisplay.appendChild(t),qrDisplay.appendChild(n),showGuidesCheckbox.checked&&qrDisplay.classList.add("show-guides")}"block"===countdownDisplay.style.display&&qrDisplay.appendChild(countdownDisplay),frameCounter.textContent=`Frame: ${e+1} / ${totalFrames}`,updateFrameMetadata(e);const l=(e+1)/totalFrames*100;progressBar.style.width=`${l}%`,fullscreenProgressBar.style.width=`${l}%`}catch(e){console.error("Error generating QR code:",e)}}function updateFrameMetadata(e){const t=fountainPackets[e];if(!t)return;let n,a="";if(0===e){if(n="Handshake (Setup Data)",currentChunkInfo.style.display="none",t.metaString){a=` (${t.metaString.length} bytes)`}}else{const e=t.dataString.split(":");if(e.length>=6){const s=e[1],i=e[5];n=`Data Packet (Degree: ${i})`,currentChunkInfo.style.display="block",chunkId.textContent=`${s} (contains ${i} chunk${i>1?"s":""})`,a=` (${t.dataString.length} bytes)`}}frameType.textContent=n+a}function updateProgress(){const e=(currentFrame+1)/totalFrames*100;progressBar.style.width=`${e}%`,isFullscreen&&(fullscreenProgressBar.style.width=`${e}%`)}function readFileAsBase64(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=n,a.readAsDataURL(e)}))}function chunkFile(e,t){const n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}function formatFileSize(e){return e<1024?e+" bytes":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}speedSlider.addEventListener("input",(()=>{const e=speedSlider.value;speedValue.textContent=`${e} FPS`})),sizeSlider.addEventListener("input",(()=>{qrSize=parseInt(sizeSlider.value),sizeValue.textContent=`${qrSize}px`,qrDisplay.style.width=`${qrSize}px`,qrDisplay.style.height=`${qrSize}px`})),chunkSlider.addEventListener("input",(()=>{const e=chunkSlider.value;chunkValue.textContent=`${e} chars`})),redundancySlider.addEventListener("input",(()=>{const e=redundancySlider.value;redundancyValue.textContent=`${e}%`})),countdownSlider.addEventListener("input",(()=>{countdownSeconds=parseInt(countdownSlider.value),countdownValue.textContent=countdownSeconds>0?`${countdownSeconds}s`:"None"})),maxDegreeSlider.addEventListener("input",(()=>{const e=maxDegreeSlider.value;maxDegreeValue.textContent=e})),showGuidesCheckbox.addEventListener("change",(()=>{showGuidesCheckbox.checked?qrDisplay.classList.add("show-guides"):qrDisplay.classList.remove("show-guides")})),highDensityCheckbox.addEventListener("change",(()=>{highDensityCheckbox.checked?(MAX_QR_CONTENT_SIZE=4e3,document.querySelectorAll(".high-density-indicator").forEach((e=>{e.style.display="block"}))):(MAX_QR_CONTENT_SIZE=2500,document.querySelectorAll(".high-density-indicator").forEach((e=>{e.style.display="none"}))),chunks&&chunks.length>0&&(generateBtn.disabled=!1)})),fastPreset.addEventListener("click",(()=>{applyPreset("fast")})),reliablePreset.addEventListener("click",(()=>{applyPreset("reliable")})),mobilePreset.addEventListener("click",(()=>{applyPreset("mobile")})),fileInput.addEventListener("change",(()=>{if(fileInput.files.length>0){const e=fileInput.files[0];fileNameText=e.name,fileSizeBytes=e.size,fileLabel.textContent=fileNameText,fileName.textContent=fileNameText,generateBtn.disabled=!1,generateAndStartBtn.disabled=!1,displayInterval&&(clearInterval(displayInterval),displayInterval=null),isPlaying=!1,startBtn.disabled=!0,stopBtn.disabled=!0,fullscreenBtn.disabled=!0,applyOptimalSettings()}})),generateAndStartBtn.addEventListener("click",(async()=>{if(fileInput.files.length){generateAndStartBtn.disabled=!0,generateAndStartBtn.textContent="Generating...";try{await generateQRCodes(),fullscreenCheckbox.checked?(enterFullscreenMode(),startPlaying()):startPlaying()}catch(e){alert("Error: "+e.message)}finally{generateAndStartBtn.textContent="Generate & Start Display",generateAndStartBtn.disabled=!1}}})),generateBtn.addEventListener("click",(async()=>{if(fileInput.files.length){generateBtn.disabled=!0,generateBtn.textContent="Generating...";try{await generateQRCodes(),startBtn.disabled=!1,fullscreenBtn.disabled=!1}catch(e){alert("Error generating QR codes: "+e.message)}finally{generateBtn.textContent="Generate QR Codes",generateBtn.disabled=!1}}})),startBtn.addEventListener("click",(()=>{0!==fountainPackets.length&&(countdownSeconds>0?startCountdown():startPlaying())})),stopBtn.addEventListener("click",(()=>{stopPlaying()})),fullscreenBtn.addEventListener("click",(()=>{enterFullscreenMode(),countdownSeconds>0?startCountdown():startPlaying()})),exitFullscreenBtn.addEventListener("click",(()=>{isFullscreen=!1,fullscreenDisplay.style.display="none",stopPlaying()}));class SystematicLTEncoder{constructor(e,t=Date.now()){this.originalChunks=e,this.numChunks=e.length,this.seedBase=t,this.packetCounter=0,this.avgChunkSize=this.calculateAverageChunkSize(),this.systematicPhase=!0,this.currentSystematicIndex=0,this.maxSafeDegree=this.calculateMaxSafeDegree(),this.c=.03,this.delta=.5}calculateAverageChunkSize(){let e=0;const t=Math.min(10,this.numChunks);for(let n=0;n<t;n++)e+=this.originalChunks[n].length;return Math.ceil(e/t)}calculateMaxSafeDegree(){if(maxDegreeSlider){const e=parseInt(maxDegreeSlider.value);if(!isNaN(e)&&e>0)return e}const e=Math.floor(.9*MAX_QR_CONTENT_SIZE)-150,t=Math.floor(e/(this.avgChunkSize+5)),n=Math.min(Math.max(8,Math.ceil(Math.sqrt(this.numChunks))),this.numChunks);return Math.max(1,Math.min(t,n,20))}calculateTotalPackets(){let e;e=this.maxSafeDegree>=2?Math.ceil(this.numChunks/2):this.numChunks;const t=parseInt(document.getElementById("redundancySlider").value)/100;return e+Math.ceil(this.numChunks*t)+(this.maxSafeDegree>=2?Math.ceil(.1*this.numChunks):0)}generatePacket(){if(this.systematicPhase){document.getElementById("highDensityCheckbox").checked;if(this.maxSafeDegree>=2&&this.currentSystematicIndex<this.numChunks&&this.numChunks-1-this.currentSystematicIndex>=0){const e=this.createDualSystematicPacket(this.currentSystematicIndex,this.numChunks-1-this.currentSystematicIndex);return this.currentSystematicIndex++,this.currentSystematicIndex>=this.numChunks&&(this.systematicPhase=!1),e}{const e=this.createSystematicPacket(this.currentSystematicIndex);return this.currentSystematicIndex++,this.currentSystematicIndex>=this.numChunks&&(this.systematicPhase=!1),e}}return this.createLTPacket()}createSystematicPacket(e){const t=this.originalChunks[e],n=this.seedBase+this.packetCounter,a=`${e}:${t}`,s={format:"compact",dataString:`D:${this.packetCounter}:${n}:${this.seedBase}:${this.numChunks}:1:${a}`,s:n,d:1,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!0};return this.checkAndHandlePacketSize(s),s}createDualSystematicPacket(e,t){const n=this.originalChunks[e],a=this.originalChunks[t],s=this.seedBase+this.packetCounter,i=`${e}:${n}|${t}:${a}`,l={format:"compact",dataString:`D:${this.packetCounter}:${s}:${this.seedBase}:${this.numChunks}:1:${i}`,s:s,d:1,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!0};return this.checkAndHandlePacketSize(l),l}createLTPacket(){const e=this.seedBase+this.packetCounter,t=this.createPRNG(e),n=this.getRobustSolitonDegree(t),a=this.selectChunksLT(n,t),s=this.combineChunks(a),i={format:"compact",dataString:`D:${this.packetCounter}:${e}:${this.seedBase}:${this.numChunks}:${n}:${s}`,s:e,d:n,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!1};return this.checkAndHandlePacketSize(i),i}checkAndHandlePacketSize(e){const t=document.getElementById("highDensityCheckbox").checked?4e3:2500;e.dataString.length>.9*t&&this.truncatePacket(e,.9*t)}truncatePacket(e,t){const n=e.dataString.split(":",6).slice(0,6).join(":"),a=n.length+1,s=t-a,i=e.dataString.substring(a),l=i.length,r=i.substring(0,s);e.dataString=`${n}:${r}`,e.truncated=!0,e.dataString=`${e.dataString}:t:${l}`}createPRNG(e){let t=e;return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}}getRobustSolitonDegree(e){if(this.numChunks<=1)return 1;const t=this.c,n=this.delta,a=t*Math.log(this.numChunks/n)*Math.sqrt(this.numChunks),s=Math.min(this.maxSafeDegree,this.numChunks),i=e();let l=0;if(l+=1/this.numChunks+a/this.numChunks,i<l)return 1;for(let e=2;e<=s;e++){let t=1/(e*(e-1)),s=0;if(e<=Math.floor(this.numChunks/a)?s=a/(e*this.numChunks):e===Math.floor(this.numChunks/a)&&(s=a*Math.log(a/n)/this.numChunks),l+=t+s,i<l)return e}return s}selectChunksLT(e,t){const n=[],a=Math.min(e,this.numChunks);for(;n.length<a;){const e=Math.floor(t()*this.numChunks);n.includes(e)||n.push(e)}return n}combineChunks(e){return 0===e.length?"":e.map((e=>`${e}:${this.originalChunks[e]}`)).join("|")}generateMetadataPacket(){const e=document.getElementById("fileName").textContent,t=document.getElementById("fileSize").textContent,n=fileInput.files[0].type,a=parseInt(document.getElementById("speedSlider").value),s=parseInt(document.getElementById("maxDegreeSlider").value),i=parseInt(document.getElementById("chunkSlider").value),l=parseInt(document.getElementById("redundancySlider").value),r=document.getElementById("highDensityCheckbox").checked?1:0,c=document.getElementById("errorCorrectionSelect").value,d=`${e}:${t}:${this.numChunks}`,o=this.simpleChecksum(d),u=`${this.c}:${this.delta}`;return{format:"compact",metaString:`M:3.0:${encodeURIComponent(e)}:${encodeURIComponent(n)}:${t}:${this.numChunks}:${this.calculateTotalPackets()}:${s}:${r}:${a}:${i}:${l}:${c}:${o}:${u}`,s:this.seedBase,p:this.packetCounter++,n:this.numChunks,b:this.seedBase}}simpleChecksum(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36).substring(0,6)}}</script></body></html>