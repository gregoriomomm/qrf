<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Unified QR Code Decoder</title><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script><style>@keyframes yellowBlink{0%{background-color:#e5e7eb}20%,80%{background-color:#facc15}to{background-color:#bfdbfe}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes pulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}*{margin:0;padding:0;box-sizing:border-box}.control-label{display:flex;justify-content:space-between;align-items:center;font-weight:700;margin-bottom:5px}input[type=range]{width:100%;height:8px;background:#e5e7eb;border-radius:4px;appearance:none;outline:0}input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;background:var(--primary-color);border-radius:50%;cursor:pointer}.slider-labels{display:flex;justify-content:space-between;font-size:12px;color:#6b7280;margin-top:5px}.value-display{font-weight:700;color:var(--primary-color);margin-left:5px}:root{--primary-color:#2563eb;--secondary-color:#1d4ed8;--success-color:#16a34a;--warning-color:#f59e0b;--danger-color:#dc2626;--light-color:#f8fafc;--dark-color:#0f172a;--gray-color:#64748b;--border-color:#e2e8f0}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.5;color:var(--dark-color);background-color:#f5f5f5;overflow-x:hidden;max-width:100%}h1,h2,h3{color:var(--primary-color);margin-bottom:1rem}.container{width:100%;max-width:1200px;margin:0 auto;padding:20px;box-sizing:border-box;display:flex;flex-wrap:wrap;gap:20px}.panel,.video-container{overflow:hidden;border-radius:8px}.panel{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px;flex:1;min-width:300px;margin-bottom:20px}.video-container{position:relative;background:#000;max-width:100%;height:400px;display:flex;justify-content:center;align-items:center}#uploadedVideo,#video{position:relative;width:100%;height:100%;max-height:400px;object-fit:contain;background:#000}#canvas,#debugCanvas,#videoCanvas,#videoDebugCanvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;z-index:5;opacity:.8}#debugCanvas,#videoCanvas,#videoDebugCanvas{display:none}.debug-view{margin-top:20px;display:flex;flex-direction:column;gap:10px}.debug-view-canvas{width:100%;max-height:300px;border:1px solid #ddd;background:#000}.debug-controls{display:flex;gap:10px;flex-wrap:wrap}.debug-button{padding:8px;font-size:12px;background:#64748b;color:#fff;border:0;border-radius:4px;cursor:pointer}#canvas{display:none}.control-group,.controls{display:flex;flex-direction:column}.controls{gap:15px;margin-top:20px}.control-group{gap:8px}.control-group label{font-weight:700;color:var(--dark-color)}button,input,select{padding:10px;border-radius:4px;border:1px solid var(--border-color);font-size:14px}button{background:var(--primary-color);color:#fff;border:0;font-weight:700;cursor:pointer;transition:background .2s}button:hover{background:var(--secondary-color)}button:disabled{background:var(--gray-color);cursor:not-allowed}button.danger{background:var(--danger-color)}button.danger:hover{background:#b91c1c}.status-badge.active,button.success{background:var(--success-color)}button.success:hover{background:#15803d}.status-badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:700}.status-badge.active{color:#fff}.status-badge.inactive{background:var(--gray-color);color:#fff}.status-badge.warning{background:var(--warning-color);color:#fff}.status-badge.error{background:var(--danger-color);color:#fff}.status-badge.systematic-phase{background:var(--primary-color);color:#fff}.status-badge.fountain-phase{background:var(--success-color);color:#fff}.chunk.systematic{background:var(--primary-color)}.chunk.fountain{background:var(--success-color)}.info-panel{margin-top:20px;padding:15px;background:#f0f9ff;border-radius:8px;border-left:4px solid var(--primary-color)}.info-row{display:flex;justify-content:space-between;margin-bottom:8px}.info-label{font-weight:700;color:var(--secondary-color)}.error-stats{margin:10px 0 15px;padding:10px;background:rgba(255,235,235,.5);border-radius:6px}.error-stat{color:#d32f2f}.progress-container{width:100%;height:20px;background:#e5e7eb;border-radius:4px;overflow:hidden;margin:15px 0;position:relative;z-index:1}.progress-bar{height:100%;background:var(--primary-color);transition:width .3s;width:0;position:relative;z-index:2}.grid-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(20px,1fr));gap:4px;margin-top:15px}.grid-item{aspect-ratio:1/1;border-radius:4px;background:#e5e7eb;transition:background-color .3s ease}.grid-item.received{background:#bfdbfe}.grid-item.processed{background:var(--success-color)}.grid-item.just-read{animation:yellowBlink 1.5s ease}.file-input-container{position:relative;overflow:hidden;display:inline-block;width:100%}.file-input-label{padding:12px;background:#e5e7eb;color:var(--dark-color);border-radius:4px;cursor:pointer;display:block;text-align:center;transition:background .2s}.file-input-label:hover{background:#d1d5db}.file-input-container input[type=file]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}.switch-container{display:flex;align-items:center;gap:8px;margin-bottom:10px;cursor:pointer;overflow:hidden}.switch input,.switch-container input{opacity:0;width:0;height:0}.switch{position:relative;display:inline-block;width:46px;height:24px;z-index:3}.slider,.slider:before{position:absolute;transition:.4s}.slider{cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;border-radius:24px;z-index:1;pointer-events:none}.slider:before{content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;z-index:2;border-radius:50%}input:checked+.slider{background-color:var(--primary-color)}input:checked+.slider:before{transform:translateX(22px)}.label-text{font-size:14px}.tooltip{position:relative;display:inline-block;margin-left:5px;width:16px;height:16px;background:#e5e7eb;color:var(--gray-color);border-radius:50%;text-align:center;line-height:16px;font-size:11px;font-weight:700;cursor:help}.tooltip:hover::after{content:attr(data-tooltip);position:absolute;top:-5px;left:100%;transform:translateY(-100%);background:rgba(55,65,81,.9);color:#fff;padding:5px 10px;border-radius:4px;width:200px;font-weight:400;font-size:12px;z-index:10;line-height:1.4}.notification{position:fixed;bottom:20px;right:20px;padding:15px 20px;background:var(--primary-color);color:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.2);max-width:300px;transform:translateY(100px);opacity:0;transition:transform .3s,opacity .3s;z-index:1000}.notification.show{transform:translateY(0);opacity:1}.notification.success{background:var(--success-color)}.notification.error{background:var(--danger-color)}.stats-container{display:flex;gap:10px;margin-top:10px;margin-bottom:15px;flex-wrap:wrap}.error-tracking-container{margin-top:5px;border-left:3px solid var(--danger-color);background-color:rgba(220,38,38,.05);padding:10px;border-radius:4px}.stat-box{flex:1;min-width:120px;background:#fff;padding:10px;border-radius:8px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,.1)}.error-stat .stat-value{color:var(--danger-color);font-size:20px}.stat-value{font-size:24px;font-weight:700;color:var(--primary-color)}.stat-label{font-size:12px;color:var(--gray-color)}@media (max-width:768px){.container{flex-direction:column}.video-container{aspect-ratio:4/3}.panel{min-width:100%}.stats-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.error-tracking-container,.stat-box{padding:8px}.stat-box{min-width:120px}.stat-value{font-size:20px}.error-stat .stat-value{font-size:18px}.tab-content{padding:10px}}@media (max-width:480px){.stats-container{grid-template-columns:repeat(2,1fr)}.stat-box{padding:6px}.stat-value{font-size:18px}.stat-label{font-size:10px}}@media (max-width:768px){.stat-box{min-width:120px}.stats-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.tab-content{padding:10px}}.overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:10;pointer-events:none}.overlay-content{background:#fff;padding:20px;border-radius:8px;text-align:center;max-width:80%}.overlay.hidden{display:none}.tab-container{margin-bottom:20px}.tab-buttons{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:15px}.tab-button{padding:10px 15px;background:0 0;border:0;border-bottom:3px solid transparent;color:var(--gray-color);cursor:pointer;font-weight:700}.tab-button.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}.tab-content{display:none;width:100%;height:auto;transition:opacity .3s ease;opacity:0}.tab-content.active{display:block;opacity:1}.tab-content .video-container{margin-bottom:20px}.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--primary-color);animation:spin 1s ease-in-out infinite;margin:20px auto}.pulse-animation{animation:pulse 1.5s infinite}.grid-item.placeholder{background:#f0f0f0;color:#666;font-style:italic}.stat-box{transition:background-color .3s}.stat-box.highlight{background-color:rgba(37,99,235,.1)}.debug-options{background:#f8fafe;border:1px solid #e2e8f0}.debug-panel-container{max-height:300px;overflow-y:auto;margin-top:20px;border:1px solid var(--border-color);border-radius:4px;background:#f8f8f8;font-family:monospace;font-size:12px}.debug-panel-header{padding:10px 12px;background-color:#eaeaea;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}@media (max-width:768px){.debug-panel-header{flex-direction:column;align-items:flex-start}.log-level-controls{margin-left:0;width:100%;justify-content:space-between}}.debug-panel-header h3{margin:0;font-size:14px;color:#333}.log-level-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:#f0f0f0;padding:8px;border-radius:4px;margin-left:10px}#clearLogsBtn,.log-level-button,.log-level-controls label{border-radius:3px;font-size:12px;cursor:pointer}.log-level-controls label{display:flex;align-items:center;gap:5px;color:#555;padding:2px 6px;background:rgba(255,255,255,.7)}.log-level-controls label:hover{background:#fff}.log-level-controls input[type=checkbox]{margin:0;width:14px;height:14px}.log-level-button{padding:5px 10px;background:#e5e7eb;color:#374151;border:0;border-radius:4px;transition:background .2s,color .2s}.log-level-button:hover{background:#d1d5db}.log-level-button.active{background:var(--primary-color);color:#fff}#clearLogsBtn{background-color:#e0e0e0;color:#333;border:1px solid #ccc;padding:2px 8px}#clearLogsBtn:hover{background-color:#d0d0d0}.debug-panel{font-family:monospace;font-size:12px;padding:10px;height:auto;max-height:none;background:#f8f8f8}.debug-entry{margin-bottom:5px;padding-bottom:5px;border-bottom:1px dashed #ddd}.debug-entry.verbose{color:#6b7280}.debug-entry.info{color:var(--primary-color)}.debug-entry.error{color:var(--danger-color)}.debug-entry.warning{color:var(--warning-color)}.debug-entry.success{color:var(--success-color)}.download-button{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:15px;margin-top:20px;background:var(--success-color);color:#fff;border:0;border-radius:4px;font-weight:700;cursor:pointer;transition:background .2s}.download-button:hover{background:#15803d}.download-button:disabled{background:var(--gray-color);cursor:not-allowed}.download-button svg{width:18px;height:18px}.debug-options{margin-top:15px;padding:12px;background-color:#f8fafc;border-radius:6px;border:1px solid var(--border-color)}.debug-options .control-group{margin-bottom:0}.debug-options .debug-button{margin-top:10px;background-color:var(--primary-color);color:#fff;padding:8px 12px;font-size:13px;transition:background-color .2s}.debug-options .debug-button:hover{background-color:var(--secondary-color)}span.slider:not(.switch *){display:none!important}</style></head><body><h1>Unified QR Code Decoder</h1><div class="container"><div class="panel"><div class="tab-container"><div class="tab-buttons"><button class="tab-button active" data-tab="camera-tab">Camera</button> <button class="tab-button" data-tab="video-tab">Video Upload</button> <button class="tab-button" data-tab="settings-tab">Settings</button></div><div class="tab-content active" id="camera-tab"><div class="control-group"><label for="cameraSelect">Select Camera</label> <select id="cameraSelect" disabled="disabled"><option value="">Loading cameras...</option></select></div><div class="video-container"><video id="video" playsinline autoplay muted></video><canvas id="canvas"></canvas><canvas id="debugCanvas"></canvas><div id="cameraOverlay" class="overlay"><div class="overlay-content"><h3>Camera Inactive</h3><p>Click "Start Camera" to begin scanning</p></div></div></div><div class="controls"><button id="startCameraBtn" class="success">Start Camera</button> <button id="fullscreenBtn" class="success">Fullscreen Camera</button> <button id="stopCameraBtn" class="danger" disabled="disabled">Stop Camera</button></div></div><div class="tab-content" id="video-tab"><div class="control-group"><label>Upload Video File</label><div class="file-input-container"><label class="file-input-label"><span id="videoFileLabel">Choose a video file</span> <input type="file" id="videoFileInput" accept="video/*"></label></div></div><div class="video-container"><video id="uploadedVideo" playsinline controls></video><canvas id="videoCanvas"></canvas><canvas id="videoDebugCanvas"></canvas><div id="videoOverlay" class="overlay"><div class="overlay-content"><h3>No Video Selected</h3><p>Upload a video file to begin</p></div></div></div><div class="debug-view" id="debugView" style="display: none;"><h3>Debug View</h3><canvas id="processedCanvas" class="debug-view-canvas"></canvas><div class="debug-controls"><button class="debug-button" id="saveFrameBtn">Save Current Frame</button> <button class="debug-button" id="detectMainThreadBtn">Try Detect in Main Thread</button> <button class="debug-button" id="cycleProcessingBtn">Cycle Processing Methods</button></div></div><div class="controls"><button id="startProcessingBtn" disabled="disabled">Start Processing</button> <button id="stopProcessingBtn" class="danger" disabled="disabled">Stop Processing</button></div></div><div class="tab-content" id="settings-tab"><div class="control-group"><div class="switch-container"><label class="switch"><input type="checkbox" id="highDensitySwitch" checked="checked"> <span class="slider"></span></label> <span>High Density Mode</span> <span class="tooltip" data-tooltip="Enable for complex QR codes with higher data capacity. May require more processing power.">?</span></div></div><div class="control-group"><div class="switch-container"><label class="switch"><input type="checkbox" id="debugModeSwitch" checked="checked"> <span class="slider"></span></label> <span>Debug Mode</span> <span class="tooltip" data-tooltip="Show additional debugging information and visualizations.">?</span></div></div><div class="control-group"><div class="switch-container"><label class="switch"><input type="checkbox" id="showDebugCanvasSwitch" checked="checked"> <span class="slider"></span></label> <span>Show Debug View</span> <span class="tooltip" data-tooltip="Show processed frames with visual debugging.">?</span></div></div><div class="control-group"><div class="switch-container"><label class="switch"><input type="checkbox" id="showScanOverlaySwitch" checked="checked"> <span class="slider"></span></label> <span>Show Scan Overlay</span> <span class="tooltip" data-tooltip="Highlight detected QR codes in the camera view.">?</span></div></div><div class="control-group"><div class="control-label">Worker Threads <span class="value-display" id="workerCountValue">4</span> <span class="tooltip" data-tooltip="Number of parallel processing threads. Higher values use more CPU but may improve decoding speed significantly. For modern devices, 8-16 workers can provide the best performance.">?</span></div><input type="range" id="workerCountSlider" min="1" max="16" value="4" step="1"><div class="slider-labels"><span>1 (Low CPU)</span> <span>16 (Maximum Performance)</span></div></div><div class="control-group"><div class="control-label">Scan Rate <span class="value-display" id="scanRateValue">30 FPS</span> <span class="tooltip" data-tooltip="How many frames per second to analyze. Higher values improve detection but increase CPU usage.">?</span></div><input type="range" id="scanRateSlider" min="5" max="120" value="30" step="5"><div class="slider-labels"><span>5 FPS (Low CPU)</span> <span>120 FPS (High Performance)</span></div></div><div class="control-group"><label for="imageProcessingSelect">Image Processing</label> <select id="imageProcessingSelect"><option value="none">None</option><option value="contrast">Enhance Contrast</option><option value="bw">Black & White</option><option value="invert">Invert Colors</option><option value="adaptive" selected="selected">Adaptive (Recommended)</option><option value="aggressive">Aggressive</option></select> <span class="tooltip" data-tooltip="Apply image processing to improve QR code detection.">?</span></div><div class="control-group"><label for="scaleFactorSelect">Scale Factor</label> <select id="scaleFactorSelect"><option value="1" selected="selected">No Scaling</option><option value="0.75">Downscale to 75%</option><option value="0.5">Downscale to 50%</option><option value="0.25">Downscale to 25%</option><option value="1.25">Upscale to 125%</option><option value="1.5">Upscale to 150%</option><option value="2">Upscale to 200%</option></select> <span class="tooltip" data-tooltip="Scale image before processing: downscale to improve detection of distant QR codes, upscale to enhance small QR codes.">?</span></div><div class="control-group"><button id="captureFrameBtn">Capture Current Frame</button></div><div class="control-group"><button id="saveChunksBtn">Save Chunks Manifest</button></div><div class="control-group"><button id="resetSettingsBtn">Reset to Defaults</button></div></div></div></div><div class="panel"><h2>Decoding Status</h2><div class="stats-container"><div class="stat-box"><div class="stat-value" id="framesProcessed">0</div><div class="stat-label">Frames Processed:</div></div><div class="stat-box"><div class="stat-value" id="qrCodesDetected">0</div><div class="stat-label">Unique QR Codes Detected:</div></div><div class="stat-box"><div class="stat-value" id="chunksRecovered">0%</div><div class="stat-label">Chunks Recovery Progress:</div></div><div class="stat-box"><div class="stat-value" id="successRate">0%</div><div class="stat-label">QR Code/Frame Rate:</div></div></div><h4>Error Tracking</h4><div class="error-stats"><div class="info-row error-stat"><div class="info-label">Not Readable:</div><div id="notReadableQR">0</div></div><div class="info-row error-stat"><div class="info-label">Invalid Format:</div><div id="invalidFormatQR">0</div></div><div class="info-row error-stat"><div class="info-label">Failed Integrity:</div><div id="failedIntegrityQR">0</div></div></div><div id="decodingProgress" class="progress-container"><div id="progressBar" class="progress-bar"></div></div><div id="chunkGrid" class="grid-container"></div><div id="fileInfo" class="info-panel" style="display: none;"><h3>File Information</h3><div class="info-row"><div class="info-label">File Name:</div><div id="fileName">-</div></div><div class="info-row"><div class="info-label">File Type:</div><div id="fileType">-</div></div><div class="info-row"><div class="info-label">File Size:</div><div id="fileSize">-</div></div><div class="info-row"><div class="info-label">Total Chunks:</div><div id="totalChunks">-</div></div><div class="info-row"><div class="info-label">Chunks Recovered:</div><div id="recoveredChunks">-</div></div><div class="info-row"><div class="info-label">Recovery Progress:</div><div id="recoveryProgress">-</div></div><h3>LT Code Statistics</h3><div class="info-row"><div class="info-label">Current Phase:</div><div><span id="currentPhase" class="status-badge systematic-phase">Systematic Phase: 0/0 chunks</span></div></div><div class="info-row"><div class="info-label">Systematic Packets:</div><div id="systematicPackets">0</div></div><div class="info-row"><div class="info-label">Fountain Packets:</div><div id="fountainPackets">0</div></div><div class="info-row"><div class="info-label">Decoding Efficiency:</div><div id="decodingEfficiency">0%</div></div><button id="downloadFileBtn" class="download-button" disabled="disabled"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download File</button><div class="debug-options"><div class="control-group"><div class="control-row"><label class="switch-container"><input type="checkbox" id="saveChunksManifestSwitch" checked="checked"> <span class="slider"></span> <span class="label-text">Save Chunks Manifest</span> <span class="tooltip" data-tooltip="Enable to save a manifest file with metadata about decoded chunks">?</span></label></div><button id="fileManifestSaveBtn" class="debug-button">Save Manifest Now</button></div></div></div><div id="decodingStatus" class="info-panel"><h3>Status</h3><div class="info-row"><div class="info-label">Camera:</div><div><span id="cameraStatus" class="status-badge inactive">Inactive</span></div></div><div class="info-row"><div class="info-label">Processing:</div><div><span id="processingStatus" class="status-badge inactive">Inactive</span></div></div><div class="info-row"><div class="info-label">Decoding:</div><div><span id="decodingStatusBadge" class="status-badge inactive">Inactive</span></div></div><div class="info-row"><div class="info-label">High Density Mode:</div><div><span id="highDensityStatus" class="status-badge inactive">Disabled</span></div></div><div class="info-row"><div class="info-label">Workers:</div><div id="workerStatus">0 active</div></div><div class="info-row"><div class="info-label">Last Frame:</div><div id="lastFrameTime">-</div></div><h3>QR Code Statistics</h3><div class="stats-container"><div class="stat-box"><div class="stat-value" id="qrTotalDetected">0</div><div class="stat-label">Total Detected</div></div><div class="stat-box"><div class="stat-value" id="qrUniqueChunks">0</div><div class="stat-label">Unique Chunks</div></div><div class="stat-box"><div class="stat-value" id="qrDuplicates">0</div><div class="stat-label">Duplicates</div></div><div class="stat-box"><div class="stat-value" id="qrInvalidFormat">0</div><div class="stat-label">Invalid Format</div></div></div><div class="stats-container"><div class="stat-box"><div class="stat-value" id="qrMetadataChunks">0</div><div class="stat-label">Metadata Chunks</div></div><div class="stat-box"><div class="stat-value" id="qrDataChunks">0</div><div class="stat-label">Data Chunks</div></div></div><h4>Error Tracking</h4><div class="stats-container error-tracking-container"><div class="stat-box error-stat"><div class="stat-value" id="qrNotReadable">0</div><div class="stat-label">Not Readable</div></div><div class="stat-box error-stat"><div class="stat-value" id="qrInvalidFormatErr">0</div><div class="stat-label">Invalid Format</div></div><div class="stat-box error-stat"><div class="stat-value" id="qrFailedIntegrity">0</div><div class="stat-label">Failed Integrity</div></div><div class="stat-box error-stat"><div class="stat-value" id="qrNotCorrectable">0</div><div class="stat-label">Not Correctable</div></div></div><div class="info-row"><div class="info-label">QR Rate:</div><div id="qrDetectionRate">0 per second</div></div><div class="info-row"><div class="info-label">Last Unique:</div><div id="lastUniqueTime">-</div></div><button id="resetDecoderBtn" class="danger" style="margin-top: 15px; width: 100%;">Reset Decoder</button></div><div id="debugPanelContainer" class="debug-panel-container" style="display: none;"><div class="debug-panel-header"><h3>Debug Console</h3><div class="log-level-controls"><label><input type="checkbox" id="logLevelVerbose" checked="checked"> Verbose</label> <label><input type="checkbox" id="logLevelInfo" checked="checked"> Info</label> <label><input type="checkbox" id="logLevelWarning" checked="checked"> Warnings</label> <label><input type="checkbox" id="logLevelError" checked="checked"> Errors</label> <label><input type="checkbox" id="logLevelSuccess" checked="checked"> Success</label> <button id="clearLogsBtn" title="Clear logs">Clear</button></div></div><div id="debugPanel" class="debug-panel"><div class="debug-entry">Debug information will appear here when debug mode is enabled</div></div></div></div></div><div id="notification" class="notification">Notification message</div><script id="workerScript" type="javascript/worker">let jsQR=null,isLibraryLoaded=!1,pendingTasks=[];function processPendingTasks(){for(;pendingTasks.length>0;){processTask(pendingTasks.shift().data)}}function processTask(t){const{id:o,imageData:e,highDensityMode:a}=t;try{if("function"!=typeof jsQR)throw new Error("jsQR library not available");if(!(e&&e.data&&e.width&&e.height))throw new Error("Invalid image data");const t=new Uint8ClampedArray(e.data.buffer),s={inversionAttempts:a?"attemptBoth":"dontInvert",canOverwriteImage:!0,greyScaleWeights:{red:.3,green:.59,blue:.11}},i=jsQR(t,e.width,e.height,s);if(i){let t=null;try{i.location&&i.location.topLeft&&"number"==typeof i.location.topLeft.x&&"number"==typeof i.location.topLeft.y&&i.location.topRight&&"number"==typeof i.location.topRight.x&&"number"==typeof i.location.topRight.y&&i.location.bottomLeft&&"number"==typeof i.location.bottomLeft.x&&"number"==typeof i.location.bottomLeft.y&&i.location.bottomRight&&"number"==typeof i.location.bottomRight.x&&"number"==typeof i.location.bottomRight.y?t={topLeft:{x:Math.round(i.location.topLeft.x),y:Math.round(i.location.topLeft.y)},topRight:{x:Math.round(i.location.topRight.x),y:Math.round(i.location.topRight.y)},bottomLeft:{x:Math.round(i.location.bottomLeft.x),y:Math.round(i.location.bottomLeft.y)},bottomRight:{x:Math.round(i.location.bottomRight.x),y:Math.round(i.location.bottomRight.y)}}:console.log("QR location data invalid or incomplete, sending null location")}catch(t){console.error("Error sanitizing location data:",t)}self.postMessage({id:o,success:!0,data:i.data,location:t})}else self.postMessage({id:o,success:!1,error:"No QR code detected"})}catch(t){self.postMessage({id:o,success:!1,error:t.message,stack:t.stack})}}function loadJsQrLibrary(t=0){try{if(self.importScripts("https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"),"function"!=typeof self.jsQR)throw new Error("jsQR not found after import");jsQR=self.jsQR,isLibraryLoaded=!0,self.postMessage({type:"ready",status:"jsQR library loaded successfully"}),processPendingTasks()}catch(o){t<3?setTimeout((()=>{loadJsQrLibrary(t+1)}),500):self.postMessage({type:"error",error:`Failed to load jsQR library after ${t} attempts: ${o.message}`})}}loadJsQrLibrary(),self.addEventListener("message",(function(t){if(!t.data||!t.data.type)return;const{type:o}=t.data;"detect"===o?isLibraryLoaded?processTask(t.data):(pendingTasks.push({data:t.data}),self.postMessage({id:t.data.id,type:"pending",message:"Task queued while waiting for jsQR library to load"})):"ping"===o?self.postMessage({id:t.data.id,type:"pong",libraryLoaded:isLibraryLoaded,time:Date.now()}):"checkLibrary"===o&&self.postMessage({id:t.data.id,type:"libraryStatus",loaded:isLibraryLoaded,global:"function"==typeof self.jsQR,local:"function"==typeof jsQR})}));</script><script>function isLikelyBase64(e){const t=e.length%4==0||e.endsWith("=")||e.endsWith("=="),n=(e.match(/[A-Za-z0-9+/=]/g)||[]).length/e.length;return!(!e.startsWith("data:")||!e.includes(";base64,"))||/^[A-Za-z0-9+/]*={0,2}$/.test(e)&&t&&n>.98}function tryDecodeBase64(e){try{let t=e;e.includes(";base64,")&&(t=e.split(";base64,")[1]);const n=atob(t);return(n.match(/[\x20-\x7E]/g)||[]).length/n.length>.8?n:null}catch(e){return null}}function cleanBinaryCharacters(e,t=!1){if(!e)return"";let n=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"");return t?n=n.replace(/[^\x09\x0A\x0D\x20-\x7E]/g,""):(n=n.replace(/[\u0080-\u009F]/g,""),n=n.replace(/\x00/g,"")),n}function isLikelyBinary(e){if(!e)return!1;const t=(e.match(/[^\x09\x0A\x0D\x20-\x7E]/g)||[]).length/e.length,n=/^\x89PNG|\xff\xd8\xff|GIF8|^\x25PDF/.test(e.substring(0,8)),s=(e.match(/\x00/g)||[]).length>.05*e.length;return t>.1||n||s}function processMixedContent(e){const t={originalContent:e,processedContent:e,isBase64:!1,isBinary:!1,textExtracted:!1,processingNotes:[]};if(!e||""===e.trim())return t.processingNotes.push("Empty content detected"),t;if(isLikelyBinary(e))t.isBinary=!0,t.processingNotes.push("Binary content detected"),t.processedContent=cleanBinaryCharacters(e,!1),isLikelyBinary(t.processedContent)?(t.processedContent=cleanBinaryCharacters(e,!0),t.processingNotes.push("Aggressive binary cleaning applied")):t.processingNotes.push("Basic binary cleaning applied"),t.textExtracted=!isLikelyBinary(t.processedContent);else if(isLikelyBase64(e)){t.isBase64=!0,t.processingNotes.push("Base64 content detected");const n=tryDecodeBase64(e);n?(isLikelyBinary(n)?(t.isBinary=!0,t.processedContent=cleanBinaryCharacters(n,!1),t.processingNotes.push("Decoded base64 contains binary content")):(t.processedContent=n,t.processingNotes.push("Successfully decoded base64 to text")),t.textExtracted=!0):t.processingNotes.push("Base64 decoding failed or produced non-text content")}else t.processedContent=cleanBinaryCharacters(e,!1),t.processingNotes.push("Regular text content processed"),t.textExtracted=!0;return t}function extractBestText(e){const t=processMixedContent(e);if(t.textExtracted)return t.processedContent;if(t.isBinary){const t=[];let n="";for(let s=0;s<e.length;s++){const o=e.charAt(s);/[\x09\x0A\x0D\x20-\x7E]/.test(o)?n+=o:(n.length>10&&t.push(n),n="")}if(n.length>10&&t.push(n),t.length>0)return t.join("\n")}return cleanBinaryCharacters(e,!0)}"undefined"!=typeof module&&module.exports?module.exports={isLikelyBase64:isLikelyBase64,tryDecodeBase64:tryDecodeBase64,cleanBinaryCharacters:cleanBinaryCharacters,isLikelyBinary:isLikelyBinary,processMixedContent:processMixedContent,extractBestText:extractBestText}:window.improvedTextHandling={isLikelyBase64:isLikelyBase64,tryDecodeBase64:tryDecodeBase64,cleanBinaryCharacters:cleanBinaryCharacters,isLikelyBinary:isLikelyBinary,processMixedContent:processMixedContent,extractBestText:extractBestText};const LogManager={debugPanel:null,maxEntries:100,entries:[],logLevels:{verbose:!0,info:!0,warning:!0,error:!0,success:!0},init:function(){this.debugPanel=document.getElementById("debugPanel"),this.debugPanelContainer=document.getElementById("debugPanelContainer");try{const e=localStorage.getItem("qrDecoder_logLevels");e&&(this.logLevels=JSON.parse(e));const t=document.getElementById("logLevelVerbose"),n=document.getElementById("logLevelInfo"),s=document.getElementById("logLevelWarning"),o=document.getElementById("logLevelError"),a=document.getElementById("logLevelSuccess");t&&(t.checked=this.logLevels.verbose),n&&(n.checked=this.logLevels.info),s&&(s.checked=this.logLevels.warning),o&&(o.checked=this.logLevels.error),a&&(a.checked=this.logLevels.success)}catch(e){console.error("Error loading log levels:",e)}},toggleLogLevel:function(e,t){if(this.logLevels.hasOwnProperty(e)){this.logLevels[e]=t;try{localStorage.setItem("qrDecoder_logLevels",JSON.stringify(this.logLevels))}catch(e){console.error("Error saving log levels:",e)}}},updatePanel:function(){this.debugPanel&&Core.state.debugMode&&(this.debugPanel.style.display="block")},debug:function(e,t={}){this.addEntry(e,"verbose"),(Core.state.debugMode||t.forceConsole)&&console.debug(e)},log:function(e,t={}){this.addEntry(e,"info"),(Core.state.debugMode||t.forceConsole)&&console.log(e)},info:function(e,t={}){this.addEntry(e,"info"),(Core.state.debugMode||t.forceConsole)&&console.info(e)},warn:function(e,t={}){this.addEntry(e,"warning"),(Core.state.debugMode||t.forceConsole)&&console.warn(e)},error:function(e){this.addEntry(e,"error"),console.error(e)},success:function(e,t={}){this.addEntry(e,"success"),(Core.state.debugMode||t.forceConsole)&&console.log("%c"+e,"color: green")},coloredLog:function(e,t,n={}){this.addEntry(e,"info"),(Core.state.debugMode||n.forceConsole)&&console.log(`%c${e}`,`color: ${t}`)},addEntry:function(e,t){if(!this.logLevels[t])return;const n=(new Date).toLocaleTimeString();this.entries.unshift({message:e,type:t,timestamp:n}),this.entries.length>this.maxEntries&&this.entries.pop(),this.debugPanel&&Core.state.debugMode},clear:function(){this.entries=[],this.debugPanel&&(this.debugPanel.innerHTML="")}},EventBus={listeners:{},init:function(){this.listeners={}},on:function(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),this},off:function(e,t){return this.listeners[e]&&(t?this.listeners[e]=this.listeners[e].filter((e=>e!==t)):delete this.listeners[e]),this},emit:function(e,...t){return this.listeners[e]&&this.listeners[e].forEach((n=>{try{n(...t)}catch(t){console.error(`Error in event listener for ${e}:`,t),LogManager.error(`Event error (${e}): ${t.message}`)}})),this}},qrStatsUpdater={lastUpdated:0,updateInterval:500,update:function(e){const t=Date.now();if(!(t-this.lastUpdated<this.updateInterval)){this.lastUpdated=t;try{const t=document.getElementById("qrStats");if(!t)return;let n='<table class="stats-table">';for(const[t,s]of Object.entries(e))n+=`<tr><td>${t}:</td><td>${s}</td></tr>`;n+="</table>",t.innerHTML=n}catch(e){console.error("Error updating QR stats:",e)}}}},UIExtensions={init:function(){this.setupEnhancedControls(),this.setupAdvancedOptions()},setupEnhancedControls:function(){document.querySelectorAll(".enhanced-control").forEach((e=>{e.classList.remove("hidden")}))},setupAdvancedOptions:function(){const e=document.getElementById("advancedOptions");e&&e.classList.remove("hidden")}},UI={notificationElement:null,notificationTimeout:null,tabButtons:null,tabContents:null,init:function(){this.notificationElement=document.getElementById("notification"),this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.tabButtons.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-tab");this.activateTab(t)}))})),this.activateTab(this.tabButtons[0].getAttribute("data-tab")),this.updateSettingsUI(),this.setupSettingsListeners(),this.initEnhancedUI(),LogManager.log("UI initialized")},activateTab:function(e){const t=document.querySelector(".tab-content.active");t&&(t.style.opacity="0"),setTimeout((()=>{this.tabButtons.forEach((e=>e.classList.remove("active"))),this.tabContents.forEach((e=>e.classList.remove("active")));const t=document.querySelector(`.tab-button[data-tab="${e}"]`),n=document.getElementById(e);t&&n&&(t.classList.add("active"),n.classList.add("active"),setTimeout((()=>{n.style.opacity="1"}),50))}),150)},showNotification:function(e,t="info"){this.notificationElement&&(this.notificationTimeout&&clearTimeout(this.notificationTimeout),this.notificationElement.textContent=e,this.notificationElement.className="notification",t&&this.notificationElement.classList.add(t),this.notificationElement.classList.add("show"),this.notificationTimeout=setTimeout((()=>{this.notificationElement.classList.remove("show")}),3e3))},updateStats:function(){try{const e=document.getElementById("framesProcessed");e&&(e.textContent=Core.state.frameCounter);const t=document.getElementById("qrCodesDetected");t&&FountainDecoder&&FountainDecoder.processingStats&&(t.textContent=parseInt(FountainDecoder.processingStats.uniqueChunksReceived)||0);const n=FountainDecoder.fileMetadata;let s="--",o=0,a="?";if(o=parseInt(FountainDecoder.processingStats.uniqueChunksReceived)||0,n&&n.totalChunks&&(a=n.totalChunks,a>0&&(s=Math.round(o/a*100))),document.getElementById("systematicPackets")&&(document.getElementById("systematicPackets").textContent=FountainDecoder.systematic_packets_received||0),document.getElementById("fountainPackets")&&(document.getElementById("fountainPackets").textContent=FountainDecoder.fountain_packets_received||0),document.getElementById("decodingEfficiency")){const e=FountainDecoder.decoding_efficiency||0;document.getElementById("decodingEfficiency").textContent=`${(100*e).toFixed(1)}%`}if(document.getElementById("currentPhase")){const e=document.getElementById("currentPhase");FountainDecoder.systematic_phase_complete?(e.textContent=`Fountain Phase: ${FountainDecoder.fountain_packets_received} redundant packets`,e.className="status-badge fountain-phase"):(e.textContent=`Systematic Phase: ${FountainDecoder.systematic_packets_received}/${a} chunks`,e.className="status-badge systematic-phase")}const i=`${o} / ${a} (${s}%)`,r=document.getElementById("chunksRecovered");r&&(r.textContent=i);const c=Core.state.frameCounter>0?Math.round(Core.state.qrCodesDetected/Core.state.frameCounter*100):0;document.getElementById("successRate").textContent=c+"%";const l=document.getElementById("notReadableQR"),d=document.getElementById("invalidFormatQR"),u=document.getElementById("failedIntegrityQR");l&&(l.textContent=Core.state.qrErrorStats.notReadable||0),d&&(d.textContent=Core.state.qrErrorStats.invalidFormat||0),u&&(u.textContent=Core.state.qrErrorStats.failedIntegrity||0);const g=document.getElementById("lastFrameTime");if(Core.state.lastFrameTime&&g){const e=new Date-Core.state.lastFrameTime;g.textContent=`${e}ms ago`}try{if(FountainDecoder&&FountainDecoder.processingStats){const e=FountainDecoder.processingStats,t=document.getElementById("qrTotalDetected"),n=document.getElementById("qrUniqueChunks"),s=document.getElementById("qrDuplicates"),o=document.getElementById("qrInvalidFormat"),a=document.getElementById("qrMetadataChunks"),i=document.getElementById("qrDataChunks"),r=document.getElementById("qrNotReadable"),c=document.getElementById("qrInvalidFormatErr"),l=document.getElementById("qrFailedIntegrity"),d=document.getElementById("qrNotCorrectable");t&&(t.textContent=parseInt(e.totalQrDetected)||0),n&&(n.textContent=parseInt(e.uniqueChunksReceived)||0),s&&(s.textContent=parseInt(e.duplicateChunks)||0),o&&(o.textContent=parseInt(e.invalidFormats)||0),a&&(a.textContent=parseInt(e.metadataChunks)||0),i&&(i.textContent=parseInt(e.dataPackets)||0),r&&(r.textContent=Core.state.qrErrorStats.notReadable||0),c&&(c.textContent=Core.state.qrErrorStats.invalidFormat||0),l&&(l.textContent=Core.state.qrErrorStats.failedIntegrity||0),d&&(d.textContent=Core.state.qrErrorStats.notCorrectable||0),console.log("QR STATS UPDATE:",{totalDetected:e.totalQrDetected,uniqueChunks:e.uniqueChunksReceived,duplicates:e.duplicateChunks,invalidFormats:e.invalidFormats,metadataChunks:e.metadataChunks,dataPackets:e.dataPackets,errorStats:Core.state.qrErrorStats}),LogManager.log(`Updated QR stats: Total=${e.totalQrDetected}, Unique=${e.uniqueChunksReceived}`)}else console.warn("FountainDecoder.processingStats not available")}catch(e){console.error("Error updating QR stats:",e)}}catch(e){console.error("Critical error in updateStats:",e)}},initEnhancedUI:function(){UIExtensions.init(),setInterval((()=>{if(document.getElementById("lastUniqueTime")){const e=document.getElementById("lastUniqueTime"),t=FountainDecoder.lastUniquePacketTime;if(0===t)return void(e.textContent="-");const n=Date.now()-t;e.textContent=n<1e3?"just now":n<6e4?`${Math.floor(n/1e3)}s ago`:n<36e5?`${Math.floor(n/6e4)}m ago`:`${Math.floor(n/36e5)}h ago`}document.getElementById("qrDetectionRate")&&this.updateQrDetectionRate()}),1e3);const e=document.querySelector(".debug-panel");if(!document.getElementById("qrStats")&&e){const t=document.createElement("div");t.id="qrStats",t.className="stats-container",e.appendChild(t)}const t=document.querySelector(".control-panel");if(t){const e=document.createElement("div");e.className="enhanced-controls",e.innerHTML='\n                        <div class="control-group enhanced-control hidden">\n                            <label for="enhancedMode">Enhanced Mode</label>\n                            <input type="checkbox" id="enhancedMode" checked>\n                        </div>\n                    ',t.appendChild(e)}LogManager.log("Enhanced UI initialized")},updateQrDetectionRate:function(){this._lastStatUpdate||(this._lastStatUpdate=Date.now()),this._lastQrCountValue||(this._lastQrCountValue=0);const e=Date.now(),t=document.getElementById("qrDetectionRate");if(!t)return;const n=FountainDecoder.processingStats.totalQrDetected,s=(e-this._lastStatUpdate)/1e3,o=n-this._lastQrCountValue,a=s>0?(o/s).toFixed(1):0;t.textContent=`${a} per second`,this._lastStatUpdate=e,this._lastQrCountValue=n},updateSettingsUI:function(){document.getElementById("highDensitySwitch").checked=Core.state.highDensityMode,document.getElementById("debugModeSwitch").checked=Core.state.debugMode,document.getElementById("showDebugCanvasSwitch").checked=Core.state.showDebugCanvas,document.getElementById("showScanOverlaySwitch").checked=Core.state.showScanOverlay;const e=document.getElementById("workerCountSlider"),t=document.getElementById("workerCountValue");e&&(e.value=Core.state.workerCount),t&&(t.textContent=Core.state.workerCount);const n=document.getElementById("scanRateSlider"),s=document.getElementById("scanRateValue");n&&(n.value=Core.state.scanRate),s&&(s.textContent=`${Core.state.scanRate} FPS`),document.getElementById("imageProcessingSelect").value=Core.state.imageProcessing;const o=document.getElementById("scaleFactorSelect");if(o){const e=Core.state.scaleFactor.toString();Array.from(o.options).some((t=>t.value===e))?o.value=e:(o.value="1",Core.state.scaleFactor=1,LogManager.log("Invalid scale factor value detected, reset to 0.5 (50%)"))}const a=document.getElementById("highDensityStatus");Core.state.highDensityMode?(a.textContent="Enabled",a.className="status-badge active"):(a.textContent="Disabled",a.className="status-badge inactive"),this.debugPanelContainer=document.getElementById("debugPanelContainer"),this.debugPanelContainer&&(this.debugPanelContainer.style.display=Core.state.debugMode?"block":"none");const i=document.getElementById("debugCanvas"),r=document.getElementById("videoDebugCanvas");i&&(i.style.display=Core.state.showDebugCanvas?"block":"none"),r&&(r.style.display=Core.state.showDebugCanvas?"block":"none"),Core.state.debugMode&&LogManager.log("Debug canvas visibility: "+(Core.state.showDebugCanvas?"visible":"hidden"))},setupSettingsListeners:function(){document.getElementById("highDensitySwitch").addEventListener("change",(function(e){Core.state.highDensityMode=e.target.checked,UI.updateSettingsUI(),LogManager.log("High density mode "+(e.target.checked?"enabled":"disabled"))})),document.getElementById("debugModeSwitch").addEventListener("change",(function(e){Core.state.debugMode=e.target.checked,UI.updateSettingsUI(),LogManager.log("Debug mode "+(e.target.checked?"enabled":"disabled"));const t=document.getElementById("debugPanelContainer");t&&(t.style.display=e.target.checked?"block":"none")}));const e=document.getElementById("logLevelVerbose"),t=document.getElementById("logLevelInfo"),n=document.getElementById("logLevelWarning"),s=document.getElementById("logLevelError"),o=document.getElementById("logLevelSuccess"),a=document.getElementById("clearLogsBtn");e&&e.addEventListener("change",(function(e){LogManager.toggleLogLevel("verbose",e.target.checked)})),t&&t.addEventListener("change",(function(e){LogManager.toggleLogLevel("info",e.target.checked)})),n&&n.addEventListener("change",(function(e){LogManager.toggleLogLevel("warning",e.target.checked)})),s&&s.addEventListener("change",(function(e){LogManager.toggleLogLevel("error",e.target.checked)})),o&&o.addEventListener("change",(function(e){LogManager.toggleLogLevel("success",e.target.checked)})),a&&a.addEventListener("click",(function(){LogManager.clear(),LogManager.log("Logs cleared")})),document.getElementById("showDebugCanvasSwitch").addEventListener("change",(function(e){Core.state.showDebugCanvas=e.target.checked;const t=document.getElementById("debugCanvas"),n=document.getElementById("videoDebugCanvas");t&&(t.style.display=e.target.checked?"block":"none"),n&&(n.style.display=e.target.checked?"block":"none"),LogManager.log("Debug canvas "+(e.target.checked?"shown":"hidden")),Core.saveSettings()})),document.getElementById("showScanOverlaySwitch").addEventListener("change",(function(e){Core.state.showScanOverlay=e.target.checked,LogManager.log("Scan overlay "+(e.target.checked?"enabled":"disabled")),Core.saveSettings()})),document.getElementById("workerCountSlider").addEventListener("input",(function(e){const t=parseInt(e.target.value),n=document.getElementById("workerCountValue");n&&(n.textContent=t)})),document.getElementById("workerCountSlider").addEventListener("change",(function(e){const t=parseInt(e.target.value);Core.state.workerCount=t,WorkerPool.createWorkers(t),t>8&&LogManager.warn(`High worker count (${t}) may impact device performance on mobile`),LogManager.log(`Worker count changed to ${t}${t>8?" (high performance mode)":""}`),Core.saveSettings()})),document.getElementById("scanRateSlider").addEventListener("input",(function(e){const t=parseInt(e.target.value);Core.state.scanRate=t;const n=document.getElementById("scanRateValue");n&&(n.textContent=`${t} FPS`),LogManager.log(`Scan rate changed to ${t} FPS`),Core.saveSettings(),CameraManager.captureInterval&&(CameraManager.stopCapture(),CameraManager.startCapture())})),document.getElementById("imageProcessingSelect").addEventListener("change",(function(e){Core.state.imageProcessing=e.target.value,LogManager.log(`Image processing mode set to ${e.target.value}`),Core.saveSettings()})),document.getElementById("scaleFactorSelect").addEventListener("change",(function(e){Core.state.scaleFactor=parseFloat(e.target.value),LogManager.log(`Scale factor set to ${Core.state.scaleFactor}`),Core.saveSettings()})),document.getElementById("resetSettingsBtn").addEventListener("click",(function(){Core.resetSettings(),UI.updateSettingsUI(),UI.showNotification("Settings reset to defaults","info")}));const i=document.getElementById("resetDecoderBtn");i&&i.addEventListener("click",(()=>{FountainDecoder.reset(),UI.showNotification("Decoder reset","info")})),document.getElementById("captureFrameBtn").addEventListener("click",(function(){CameraManager.captureStillFrame()})),document.getElementById("saveChunksBtn").addEventListener("click",(function(){Core.state.enableSaveChunksManifest?FountainDecoder&&FountainDecoder.chunks&&FountainDecoder.chunks.length>0?(FountainDecoder.saveAllChunks(),UI.showNotification("Comprehensive manifest file with all chunk data saved","success")):UI.showNotification("No chunks available to save","error"):UI.showNotification("Save Chunks Manifest feature is disabled","warning")})),document.getElementById("fileManifestSaveBtn")?.addEventListener("click",(function(){Core.state.enableSaveChunksManifest?FountainDecoder&&FountainDecoder.chunks&&FountainDecoder.chunks.length>0?(FountainDecoder.saveAllChunks(),UI.showNotification("Comprehensive manifest file with all chunk data saved","success")):UI.showNotification("No chunks available to save","error"):UI.showNotification("Save Chunks Manifest feature is disabled","warning")})),document.getElementById("saveChunksManifestSwitch")?.addEventListener("change",(function(e){Core.state.enableSaveChunksManifest=e.target.checked,LogManager.log("Save Chunks Manifest "+(e.target.checked?"enabled":"disabled"));const t=document.getElementById("saveChunksBtn"),n=document.getElementById("fileManifestSaveBtn");t&&(t.disabled=!e.target.checked,e.target.checked?t.title="":t.title="Save Chunks Manifest feature is disabled"),n&&(n.disabled=!e.target.checked,e.target.checked?n.title="":n.title="Save Chunks Manifest feature is disabled"),Core.saveSettings()}))},updateProgressBar:function(e){const t=document.getElementById("progressBar");t&&(t.style.width=`${e}%`)},_lastReceivedChunks:new Set,updateChunkGrid:function(e,t){const n=document.getElementById("chunkGrid");if(!n)return;if(n.innerHTML="",0===e){const e=document.createElement("div");return e.className="grid-item placeholder",e.textContent="Waiting for metadata...",e.style.gridColumn="span 10",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.height="40px",void n.appendChild(e)}Core.state.debugMode&&(console.log(`Updating chunk grid: total=${e}, received=${t.length}`),console.log("Received chunks:",t));const s=new Set;t.forEach((e=>{const t="string"==typeof e?parseInt(e):e;this._lastReceivedChunks.has(t)||s.add(t)})),this._lastReceivedChunks=new Set(t.map((e=>"string"==typeof e?parseInt(e):e)));for(let o=0;o<e;o++){const e=document.createElement("div");e.className="grid-item",e.title=`Chunk ${o}`;const a=o.toString(),i=t.some((e=>e.toString()===a||parseInt(e)===o));s.has(o)&&e.classList.add("just-read");const r=o<FountainDecoder.systematic_packets_received;if(0===o)if(e.style.position="relative",e.style.zIndex="2",e.style.transform="scale(1.2)",e.style.margin="2px",e.style.boxShadow="0 0 5px rgba(0,0,0,0.3)",i){e.style.border="3px solid var(--success-color)",e.style.backgroundColor="var(--success-color)",e.title="First chunk (index 0) - RECEIVED ✓";const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.color="white",t.style.fontWeight="bold",t.style.fontSize="12px",t.textContent="0",e.appendChild(t)}else{e.style.border="3px solid var(--danger-color)",e.style.backgroundColor="rgba(220, 38, 38, 0.7)",e.title="MISSING CRITICAL first chunk (index 0) - Scan this QR code first!",e.classList.add("pulse-animation");const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.color="white",t.style.fontWeight="bold",t.style.fontSize="16px",t.textContent="!",e.appendChild(t)}else i?(e.classList.add("received"),r?(e.classList.add("systematic"),e.title=`Chunk ${o}: Received from systematic packet`):(e.classList.add("fountain"),e.title=`Chunk ${o}: Received from fountain packet`)):e.title=`Chunk ${o}: Not yet received`;n.appendChild(e)}const o=FountainDecoder.getMissingChunkIds();if(o&&o.length>0){const t=[];let s=o[0],a=o[0];for(let e=1;e<o.length;e++)o[e]===a+1||(s===a?t.push(`${s}`):t.push(`${s}-${a}`),s=o[e]),a=o[e];s===a?t.push(`${s}`):t.push(`${s}-${a}`);let i=document.getElementById("missingChunksInfo");i||(i=document.createElement("div"),i.id="missingChunksInfo",i.style.marginTop="10px",i.style.padding="5px",i.style.backgroundColor="rgba(220, 53, 69, 0.1)",i.style.borderRadius="4px",i.style.color="#dc3545",i.style.fontSize="13px",n.parentNode.insertBefore(i,n.nextSibling)),i.innerHTML=`<strong>Missing Chunks:</strong> ${t.join(", ")} <br>\n                                            <small>${o.length} chunks missing out of ${e} total</small>`}else{const e=document.getElementById("missingChunksInfo");e&&e.parentNode.removeChild(e)}},updateFileInfo:function(e){if(!e)return;const t=document.getElementById("fileInfo");t&&(t.style.display="block"),document.getElementById("fileName").textContent=e.name||"-",document.getElementById("fileType").textContent=e.type||"-",document.getElementById("fileSize").textContent=e.size?this.formatFileSize(e.size):"-",document.getElementById("totalChunks").textContent=e.totalChunks||"-",document.getElementById("recoveredChunks").textContent=e.recoveredChunks||"-";const n=e.totalChunks?Math.round(e.recoveredChunks/e.totalChunks*100):0;if(document.getElementById("recoveryProgress").textContent=`${n}%`,FountainDecoder.processingStats){const e=FountainDecoder.processingStats;document.getElementById("qrTotalDetected").textContent=e.totalQrDetected||0,document.getElementById("qrUniqueChunks").textContent=e.uniqueChunksReceived||0,document.getElementById("qrDuplicates").textContent=e.duplicateChunks||0,document.getElementById("qrInvalidFormat").textContent=e.invalidFormats||0,document.getElementById("qrMetadataChunks").textContent=e.metadataChunks||0,document.getElementById("qrDataChunks").textContent=e.dataPackets||0}const s=document.getElementById("timeRemaining");if(s&&e.lastUniqueChunkTime&&e.uniqueChunksReceived){const t=(e.lastUniqueChunkTime-Date.now())/e.uniqueChunksReceived,n=e.totalChunks-e.recoveredChunks;if(n>0&&t>0){const e=n*t;let o;o=e<6e4?`${Math.ceil(e/1e3)} seconds`:e<36e5?`${Math.ceil(e/6e4)} minutes`:`${(e/36e5).toFixed(1)} hours`,s.textContent=o}else s.textContent="Almost done!"}const o=document.getElementById("downloadFileBtn");o&&(o.disabled=!e.complete,e.complete?o.classList.add("pulse-animation"):o.classList.remove("pulse-animation"))},formatFileSize:function(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},updateDecodingStatus:function(e){try{const t=document.getElementById("decodingStatusBadge");if(LogManager.log("Updating decoding status to: "+(e?"Active":"Inactive")),t)e?(t.textContent="Active",t.className="status-badge active",LogManager.success("Decoding status set to Active")):(t.textContent="Inactive",t.className="status-badge inactive",LogManager.log("Decoding status set to Inactive"));else{LogManager.error("decodingStatusBadge element not found in the DOM!");const e=document.querySelectorAll("span.status-badge");LogManager.log(`Found ${e.length} status badges in the DOM`),e.forEach(((e,t)=>{LogManager.log(`Badge ${t}: id=${e.id}, text=${e.textContent}`)}))}}catch(e){console.error("Error updating decoding status:",e)}}},ImageProcessor={preprocessImageData:function(e,t="adaptive"){const n=e.width,s=e.height;e.data;Core.state.debugMode&&LogManager.log(`Preprocessing image: ${n}x${s}, method: ${t}`);const o=Core.state.scaleFactor;let a=e;if(1!==o){const t=Math.floor(n*o),i=Math.floor(s*o),r=document.createElement("canvas");r.width=t,r.height=i;const c=r.getContext("2d",{willReadFrequently:!0}),l=document.createElement("canvas");l.width=n,l.height=s;if(l.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0),o<1?c.imageSmoothingEnabled=!1:(c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high"),c.drawImage(l,0,0,n,s,0,0,t,i),a=c.getImageData(0,0,t,i),Core.state.debugMode){const e=o>1?"upscaled":"downscaled";LogManager.log(`${e} image to ${t}x${i}`)}}const i=a.data,r=a.width,c=a.height;switch(t){case"contrast":{const e=1.5,t=128;for(let n=0;n<i.length;n+=4)for(let s=0;s<3;s++){const o=i[n+s],a=Math.min(255,Math.max(0,(o-t)*e+t));i[n+s]=a}break}case"bw":{const e=this.getOptimalThreshold(i);for(let t=0;t<i.length;t+=4){const n=.299*i[t]+.587*i[t+1]+.114*i[t+2]<e?0:255;i[t]=i[t+1]=i[t+2]=n}break}case"invert":for(let e=0;e<i.length;e+=4)i[e]=255-i[e],i[e+1]=255-i[e+1],i[e+2]=255-i[e+2];break;case"adaptive":{const e=new Uint8Array(r*c);for(let t=0,n=0;t<i.length;t+=4,n++)e[n]=Math.round(.299*i[t]+.587*i[t+1]+.114*i[t+2]);const t=Math.max(3,Math.floor(Math.min(r,c)/20)),n=5,s=new Uint32Array((r+1)*(c+1));for(let t=0;t<c;t++)for(let n=0;n<r;n++){const o=t*r+n,a=(t+1)*(r+1)+(n+1);s[a]=e[o]+s[a-1]+s[a-(r+1)]-s[a-(r+1)-1]}for(let o=0;o<c;o++)for(let a=0;a<r;a++){const l=4*(o*r+a),d=Math.max(0,a-t),u=Math.max(0,o-t),g=Math.min(r-1,a+t),h=Math.min(c-1,o+t),m=(g-d+1)*(h-u+1),p=s[(h+1)*(r+1)+(g+1)]-s[(h+1)*(r+1)+d]-s[u*(r+1)+(g+1)]+s[u*(r+1)+d],f=Math.round(p/m)-n,y=e[o*r+a]<f?0:255;i[l]=i[l+1]=i[l+2]=y}break}case"aggressive":{for(let e=0;e<i.length;e+=4){const t=.299*i[e]+.587*i[e+1]+.114*i[e+2];i[e]=i[e+1]=i[e+2]=t}this.normalizeHistogram(i);const e=this.getOptimalThreshold(i);for(let t=0;t<i.length;t+=4){const n=i[t]<e?0:255;i[t]=i[t+1]=i[t+2]=n}break}}if(Core.state.debugMode&&Core.state.showDebugCanvas){const e="video-tab"===(document.querySelector(".tab-content.active")?.id||"")?"videoDebugCanvas":"debugCanvas",t=document.getElementById(e);if(t){const e=t.getContext("2d");if(e){const a=new ImageData(new Uint8ClampedArray(i),r,c);if(t.width===n&&t.height===s||(t.width=n,t.height=s),e.clearRect(0,0,t.width,t.height),1!==o){const t=document.createElement("canvas");t.width=r,t.height=c;t.getContext("2d").putImageData(a,0,0),e.drawImage(t,0,0,n,s)}else e.putImageData(a,0,0);t.style.display="block"}}}return a},getOptimalThreshold:function(e){const t=new Array(256).fill(0);let n=0;for(let s=0;s<e.length;s+=4)t[e[s]]++,n++;for(let e=0;e<256;e++)t[e]/=n;let s=0,o=0,a=0,i=0,r=0;for(let e=0;e<256;e++)r+=e*t[e];for(let e=0;e<256;e++){if(o+=t[e],0===o)continue;const n=1-o;if(0===n)break;s+=e*t[e];const c=s/o,l=(r-s)/n,d=o*n*(c-l)*(c-l);d>a&&(a=d,i=e)}return i},normalizeHistogram:function(e){let t=255,n=0;for(let s=0;s<e.length;s+=4){const o=e[s];o<t&&(t=o),o>n&&(n=o)}if(0===t&&255===n)return;const s=n-t;if(0!==s)for(let n=0;n<e.length;n+=4){const o=Math.round((e[n]-t)/s*255);e[n]=e[n+1]=e[n+2]=o}}},CameraManager={videoElement:null,canvasElement:null,canvasContext:null,debugCanvasElement:null,debugCanvasContext:null,mediaStream:null,captureInterval:null,rAFId:null,useRAF:!0,lastProcessedTime:0,processingDelay:0,screenOrientation:"portrait",isFullscreen:!1,init:function(){if(this.videoElement=document.getElementById("video"),this.canvasElement=document.getElementById("canvas"),this.canvasContext=this.canvasElement.getContext("2d",{willReadFrequently:!0}),this.debugCanvasElement=document.getElementById("debugCanvas"),this.debugCanvasElement&&(this.debugCanvasContext=this.debugCanvasElement.getContext("2d")),this.setupCameraSelect(),this.setupOrientationChange(),this.setupTouchControls(),document.getElementById("startCameraBtn").addEventListener("click",(()=>this.startCamera())),document.getElementById("stopCameraBtn").addEventListener("click",(()=>this.stopCamera())),document.getElementById("fullscreenBtn").addEventListener("click",(()=>this.toggleFullscreen())),!document.getElementById("fullscreenBtn")){const e=document.querySelector(".controls");if(e){const t=document.createElement("button");t.id="fullscreenBtn",t.className="success",t.innerHTML='<i class="fullscreen-icon"></i> Fullscreen',t.addEventListener("click",(()=>this.toggleFullscreen())),e.appendChild(t)}}LogManager.log("Camera manager initialized with mobile optimizations")},setupOrientationChange:function(){window.addEventListener("orientationchange",(()=>{setTimeout((()=>{this.updateCameraViewForOrientation()}),200)})),this.updateCameraViewForOrientation()},updateCameraViewForOrientation:function(){const e=window.innerHeight>window.innerWidth;if(this.screenOrientation=e?"portrait":"landscape",this.mediaStream&&this.videoElement){const t=document.querySelector(".video-container");t&&(t.style.height=e?"60vh":"80vh"),this.resizeCanvasToVideo()}LogManager.log(`Screen orientation updated to ${this.screenOrientation}`)},setupTouchControls:function(){const e=document.querySelector(".video-container");if(e){let t=0,n=1;e.addEventListener("touchstart",(e=>{2===e.touches.length&&(t=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY))})),e.addEventListener("touchmove",(e=>{if(2===e.touches.length&&this.mediaStream){e.preventDefault();const s=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);n*=s/t,n=Math.max(1,Math.min(n,5));const o=this.mediaStream.getVideoTracks()[0];if(o&&o.getCapabilities&&o.getCapabilities().zoom){const e=o.getCapabilities(),t=e.zoom.max-e.zoom.min,s=e.zoom.min+t*(n-1)/4;o.applyConstraints({advanced:[{zoom:s}]}).catch((e=>{LogManager.warn(`Could not apply zoom: ${e.message}`)}))}t=s}}),{passive:!1})}},setupCameraSelect:function(){const e=document.getElementById("cameraSelect");navigator.mediaDevices.enumerateDevices().then((t=>{const n=t.filter((e=>"videoinput"===e.kind));if(e.innerHTML="",0===n.length){const t=document.createElement("option");t.value="",t.textContent="No cameras found",e.appendChild(t),LogManager.warn("No cameras found")}else{const t=n.filter((e=>e.label&&(e.label.toLowerCase().includes("back")||e.label.toLowerCase().includes("rear"))));if(t.length>0)t.forEach((n=>{const s=document.createElement("option");s.value=n.deviceId,s.textContent=n.label||`Back Camera ${t.indexOf(n)+1}`,s.selected=!0,e.appendChild(s)})),n.filter((e=>!t.includes(e))).forEach((t=>{const n=document.createElement("option");n.value=t.deviceId,n.textContent=t.label||`Camera ${e.options.length}`,e.appendChild(n)}));else{const t=document.createElement("option");t.value="",t.textContent="Default Camera",e.appendChild(t),n.forEach((t=>{const n=document.createElement("option");n.value=t.deviceId,n.textContent=t.label||`Camera ${e.options.length}`,e.appendChild(n)}))}e.disabled=!1,this.isMobileDevice()&&t.length>0&&LogManager.log("Mobile device detected, auto-selecting back camera"),LogManager.log(`Found ${n.length} cameras (${t.length} back cameras)`)}})).catch((t=>{LogManager.error("Error enumerating devices: "+t.message),console.error("Error enumerating devices:",t),e.innerHTML="";const n=document.createElement("option");n.value="",n.textContent="Default Camera",e.appendChild(n),e.disabled=!1}))},isMobileDevice:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},startCamera:function(){const e=document.getElementById("cameraSelect").value;if(Core.state.cameraActive&&Core.state.currentCameraId===e)return;this.mediaStream&&this.stopCamera();const t=this.isMobileDevice(),n={video:{width:{ideal:t?1280:1920},height:{ideal:t?720:1080},facingMode:t?"environment":"user",frameRate:{ideal:30,min:15}}};e&&(n.video.deviceId={exact:e}),this.showCameraLoadingUI(!0),navigator.mediaDevices.getUserMedia(n).then((n=>{this.mediaStream=n,this.videoElement.srcObject=n;const s=n.getVideoTracks()[0],o=s.getSettings();this.canvasElement.width=o.width||1280,this.canvasElement.height=o.height||720,this.debugCanvasElement&&(this.debugCanvasElement.width=o.width||1280,this.debugCanvasElement.height=o.height||720);try{const e=s.getCapabilities();if(e){const t={};if(e.focusMode&&(t.focusMode="continuous"),e.torch&&(t.torch=Core.state.enableTorch||!1),e.exposureCompensation){e.exposureCompensation.min;const n=e.exposureCompensation.max||2;t.exposureCompensation=.3*n}Object.keys(t).length>0&&s.applyConstraints({advanced:[t]}).then((()=>{LogManager.log("Applied advanced camera constraints: "+JSON.stringify(t))})).catch((e=>{LogManager.log("Could not apply advanced constraints: "+e.message)}))}}catch(e){LogManager.log("Camera capabilities not supported: "+e.message)}this.videoElement.onloadedmetadata=()=>{this.showCameraLoadingUI(!1),Core.state.cameraActive=!0,Core.state.currentCameraId=e,document.getElementById("cameraStatus").textContent="Active",document.getElementById("cameraStatus").className="status-badge active",document.getElementById("startCameraBtn").disabled=!0,document.getElementById("stopCameraBtn").disabled=!1,document.getElementById("cameraOverlay").classList.add("hidden"),Core.state.debugMode&&this.debugCanvasElement&&(this.debugCanvasElement.style.display="block"),this.resizeCanvasToVideo(),this.startCapture(),t&&Core.state.autoFullscreen&&!this.isFullscreen&&setTimeout((()=>this.toggleFullscreen()),500),this.showChunkGridOverlay(!0),LogManager.log("Camera started: "+(s.label||"unknown camera")),LogManager.log(`Video dimensions: ${this.videoElement.videoWidth}x${this.videoElement.videoHeight}`)},this.videoElement.onerror=()=>{LogManager.error("Video element error"),this.showCameraLoadingUI(!1),this.stopCamera(),UI.showNotification("Error initializing camera","error")}})).catch((e=>{LogManager.error("Camera access error: "+e.message),console.error("Camera access error:",e),this.showCameraLoadingUI(!1),"NotAllowedError"===e.name?UI.showNotification("Camera access denied. Please allow camera permissions.","error"):"NotFoundError"===e.name?UI.showNotification("No camera found on this device.","error"):UI.showNotification("Camera access error: "+e.message,"error")}))},showCameraLoadingUI:function(e){const t=document.getElementById("cameraOverlay");t&&(e?(t.classList.remove("hidden"),t.innerHTML='\n                    <div class="overlay-content">\n                        <div class="spinner"></div>\n                        <h3>Initializing Camera</h3>\n                        <p>Please wait while we set up the camera...</p>\n                    </div>\n                '):t.classList.add("hidden"))},showChunkGridOverlay:function(e){const t=document.getElementById("chunkGrid"),n=document.querySelector(".video-container");if(t&&n)if(e){const e=document.getElementById("chunkGridOverlay");e&&e.remove();const t=document.createElement("div");t.id="chunkGridOverlay",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.pointerEvents="none",t.style.zIndex="10",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",this.isFullscreen?t.style.backgroundColor="rgba(0,0,0,0.25)":t.style.backgroundColor="rgba(0,0,0,0.1)";const s=document.createElement("div");s.id="overlayGridContainer",this.isFullscreen?(s.style.width="90%",s.style.maxWidth="800px",s.style.backgroundColor="rgba(0,0,0,0.7)",s.style.padding="15px"):(s.style.width="80%",s.style.maxWidth="500px",s.style.backgroundColor="rgba(0,0,0,0.4)",s.style.padding="10px"),s.style.borderRadius="8px";const o=document.createElement("div");o.style.marginBottom="10px",o.style.color="white",o.style.fontWeight="bold",o.style.textAlign="center",o.style.fontSize=this.isFullscreen?"16px":"14px",o.id="overlayGridHeader";const a=document.getElementById("fileName"),i=document.getElementById("recoveryProgress");a&&"-"!==a.textContent&&i?o.textContent=`${a.textContent} - ${i.textContent}`:o.textContent="Scanning for QR codes...",s.appendChild(o);const r=document.createElement("div");r.className="grid-container",r.style.margin="0",r.style.opacity="0.9",this.isFullscreen&&(r.style.gap="4px",r.style.gridTemplateColumns="repeat(auto-fill, minmax(24px, 1fr))"),s.appendChild(r),t.appendChild(s),n.appendChild(t),EventBus.on("chunksUpdated",(()=>{this.updateChunkGridOverlay()})),this.updateChunkGridOverlay()}else{const e=document.getElementById("chunkGridOverlay");e&&e.remove()}},updateChunkGridOverlay:function(){const e=document.getElementById("chunkGridOverlay");if(!e)return;const t=e.querySelector(".grid-container"),n=document.getElementById("overlayGridHeader");if(!t)return;t.innerHTML="";const s=FountainDecoder.getTotalChunks()||20,o=FountainDecoder.getReceivedChunkIds()||[];if(n){const e=document.getElementById("fileName"),t=document.getElementById("recoveryProgress");e&&"-"!==e.textContent&&t&&(n.textContent=`${e.textContent} - ${t.textContent}`)}if(0===s){const e=document.createElement("div");return e.className="grid-item placeholder",e.textContent="Waiting for data...",e.style.gridColumn="span 10",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.height="40px",e.style.color="white",e.style.backgroundColor="rgba(255,255,255,0.1)",void t.appendChild(e)}for(let e=0;e<s;e++){const n=document.createElement("div");n.className="grid-item",n.title=`Chunk ${e}`;const s=o.some((t=>t.toString()===e.toString()||parseInt(t)===e));s&&n.classList.add("received"),0===e&&(n.style.position="relative",n.style.zIndex="2",n.style.transform="scale(1.2)",n.style.margin="2px",n.style.boxShadow="0 0 5px rgba(255,255,255,0.5)",s?(n.style.border="3px solid var(--success-color)",n.style.backgroundColor="var(--success-color)"):(n.style.border="3px solid var(--danger-color)",n.style.backgroundColor="rgba(220,38,38,0.7)",n.classList.add("pulse-animation"))),t.appendChild(n)}if(this.isFullscreen){t.querySelectorAll(".grid-item").forEach((e=>{e.classList.contains("placeholder")||(e.classList.contains("just-read")?(e.style.opacity="1",e.style.boxShadow="0 0 6px rgba(255,255,100,0.8)"):e.classList.contains("received")?(e.style.opacity="1",e.style.boxShadow="0 0 3px rgba(255,255,255,0.3)"):e.style.opacity="0.6")}))}},toggleFullscreen:function(){const e=document.querySelector(".video-container");if(!e)return;if(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.isFullscreen=!1;const t=document.getElementById("exitFullscreenBtn");t&&t.remove();const n=document.getElementById("chunkGridOverlay");n&&n.remove(),this.videoElement.style.width="",this.videoElement.style.height="",e.style.backgroundColor="",setTimeout((()=>{this.resizeCanvasToVideo()}),300),LogManager.log("Exited native fullscreen camera mode")}else e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),this.isFullscreen=!0,this.videoElement.style.width="100%",this.videoElement.style.height="100%",e.style.backgroundColor="#000",this.isMobileDevice()&&this.addFullscreenExitButton(e),this.showChunkGridOverlay(!0),setTimeout((()=>{this.resizeCanvasToVideo(),this.updateChunkGridOverlay()}),300),LogManager.log("Entered native fullscreen camera mode");else if(this.isFullscreen){this.isFullscreen=!1,this._originalStyles?(Object.assign(e.style,this._originalStyles.videoContainer),document.body.style.overflow=this._originalStyles.bodyOverflow):(e.style.position="",e.style.top="",e.style.left="",e.style.width="",e.style.height="",e.style.zIndex="",e.style.backgroundColor="",document.body.style.overflow="");const t=document.getElementById("exitFullscreenBtn");t&&t.remove();const n=document.getElementById("chunkGridOverlay");n&&n.remove(),this.resizeCanvasToVideo(),LogManager.log("Exited custom fullscreen camera mode")}else this.isFullscreen=!0,this._originalStyles={videoContainer:{position:e.style.position,top:e.style.top,left:e.style.left,width:e.style.width,height:e.style.height,zIndex:e.style.zIndex},bodyOverflow:document.body.style.overflow},e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.zIndex="1000",e.style.backgroundColor="#000",document.body.style.overflow="hidden",this.addFullscreenExitButton(e),this.showChunkGridOverlay(!0),this.resizeCanvasToVideo(),this.updateChunkGridOverlay(),LogManager.log("Entered custom fullscreen camera mode");const t=document.getElementById("fullscreenBtn");t&&(t.innerHTML=this.isFullscreen?'<i class="fullscreen-icon"></i> Exit Fullscreen':'<i class="fullscreen-icon"></i> Fullscreen')},addFullscreenExitButton:function(e){const t=document.createElement("button");t.id="exitFullscreenBtn",t.innerHTML="✕",t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.background="rgba(0,0,0,0.5)",t.style.color="white",t.style.border="none",t.style.borderRadius="50%",t.style.width="40px",t.style.height="40px",t.style.fontSize="20px",t.style.cursor="pointer",t.style.zIndex="1001",t.addEventListener("click",(()=>this.toggleFullscreen())),e.appendChild(t)},stopCamera:function(){this.stopCapture(),this.mediaStream&&(this.mediaStream.getTracks().forEach((e=>e.stop())),this.mediaStream=null),this.videoElement.srcObject=null,Core.state.cameraActive=!1,Core.state.currentCameraId=null,document.getElementById("cameraStatus").textContent="Inactive",document.getElementById("cameraStatus").className="status-badge inactive",document.getElementById("startCameraBtn").disabled=!1,document.getElementById("stopCameraBtn").disabled=!0,document.getElementById("cameraOverlay").classList.remove("hidden"),this.debugCanvasElement&&(this.debugCanvasElement.style.display="none"),this.showChunkGridOverlay(!1),this.isFullscreen&&this.toggleFullscreen(),LogManager.log("Camera stopped")},resizeCanvasToVideo:function(){if(!this.videoElement||!this.videoElement.videoWidth)return;const e=this.videoElement.videoWidth,t=this.videoElement.videoHeight;if(this.canvasElement.width===e&&this.canvasElement.height===t||(this.canvasElement.width=e,this.canvasElement.height=t,this.debugCanvasElement&&(this.debugCanvasElement.width=e,this.debugCanvasElement.height=t),LogManager.debug(`Canvas resized to match video: ${e}x${t}`)),this.isFullscreen){if(document.querySelector(".video-container")){e/t>window.innerWidth/window.innerHeight?(this.videoElement.style.width="100%",this.videoElement.style.height="auto"):(this.videoElement.style.width="auto",this.videoElement.style.height="100%")}}else this.videoElement.style.width="",this.videoElement.style.height=""},startCapture:function(){this.stopCapture(),this.processingDelay=1e3/Core.state.scanRate,this.lastProcessedTime=0,this.frameQueue=[],this.maxQueueSize=3,this.captureInterval=setInterval((()=>{this.frameQueue.length<this.maxQueueSize&&this.captureFrameToQueue(),this.processNextFrameFromQueue(),this.monitorPerformance()}),this.processingDelay),LogManager.log(`Continuous frame capture started at ${Core.state.scanRate}FPS (${this.processingDelay}ms interval)`),UI.updateDecodingStatus(!0)},captureWithRAF:function(){LogManager.warn("captureWithRAF is deprecated, using new continuous capture instead"),this.startCapture()},captureFrameToQueue:function(){try{if(this.videoElement.readyState!==this.videoElement.HAVE_ENOUGH_DATA)return;const e=this.videoElement.videoWidth,t=this.videoElement.videoHeight;this.canvasElement.width===e&&this.canvasElement.height===t||this.resizeCanvasToVideo(),this.canvasContext.drawImage(this.videoElement,0,0,e,t);const n=this.canvasContext.getImageData(0,0,e,t);this.frameQueue.push({imageData:n,timestamp:Date.now()}),Core.state.debugMode&&LogManager.debug(`Frame added to queue. Queue size: ${this.frameQueue.length}`)}catch(e){LogManager.error(`Frame capture error: ${e.message}`),console.error("Frame capture error:",e)}},processNextFrameFromQueue:function(){if(0===this.frameQueue.length)return;if(0===WorkerPool.workers.filter((e=>!e.busy&&e.readyState)).length)return;const e=this.frameQueue.pop();this.frameQueue=[],Core.state.frameCounter++,Core.state.lastFrameTime=new Date;const t=this.preprocessImageData(e.imageData);WorkerPool.processFrame(t),UI.updateStats()},monitorPerformance:function(){this._performanceStats||(this._performanceStats={startTime:Date.now(),frameCount:0,lastFpsCalculation:Date.now(),currentFps:0,adaptationCount:0});const e=this._performanceStats;e.frameCount++;const t=Date.now();if(t-e.lastFpsCalculation>=1e3){const n=(t-e.lastFpsCalculation)/1e3;if(e.currentFps=e.frameCount/n,e.frameCount=0,e.lastFpsCalculation=t,Core.state.debugMode&&LogManager.log(`Current processing rate: ${e.currentFps.toFixed(1)} FPS`),e.currentFps<.7*Core.state.scanRate&&e.adaptationCount<3){const t=Math.max(5,Math.floor(e.currentFps));LogManager.warn(`Performance adaptation: Reducing scan rate to ${t} FPS`),Core.state.scanRate=t,this.stopCapture(),this.startCapture(),UI.updateSettingsUI(),e.adaptationCount++}}},stopCapture:function(){this.captureInterval&&(clearInterval(this.captureInterval),this.captureInterval=null),this.rAFId&&(cancelAnimationFrame(this.rAFId),this.rAFId=null),UI.updateDecodingStatus(!1),LogManager.log("Frame capture stopped")},captureFrame:function(){if(this.videoElement.readyState!==this.videoElement.HAVE_ENOUGH_DATA)return;const e=this.videoElement.videoWidth,t=this.videoElement.videoHeight;this.canvasElement.width===e&&this.canvasElement.height===t||this.resizeCanvasToVideo(),Core.state.frameCounter++,Core.state.lastFrameTime=new Date;try{this.canvasContext.drawImage(this.videoElement,0,0,e,t);const n=this.canvasContext.getImageData(0,0,e,t);window.createImageBitmap;{const e=this.preprocessImageData(n);WorkerPool.processFrame(e)}UI.updateStats(),Core.state.frameCounter%30==0&&this.updateChunkGridOverlay()}catch(e){LogManager.error(`Frame capture error: ${e.message}`),console.error("Frame capture error:",e)}},preprocessImageData:function(e){return ImageProcessor.preprocessImageData(e,Core.state.imageProcessing)},captureStillFrame:function(){if(Core.state.cameraActive){this.captureFrame();try{const e=this.canvasElement.toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download=`qr-frame-${(new Date).toISOString().replace(/[:.]/g,"-")}.png`,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),UI.showNotification("Frame captured and saved","success"),LogManager.log("Still frame captured and saved")}catch(e){LogManager.error("Error saving frame: "+e.message),UI.showNotification("Error saving frame","error")}}else UI.showNotification("Camera is not active","warning")}},mobileStyles="",WorkerPool={workers:[],queue:[],processing:[],taskId:0,workerScript:"",init:function(){const e=document.getElementById("workerScript");e?this.workerScript=e.textContent:LogManager.error("Worker script not found in DOM"),this.createWorkers(Core.state.workerCount),Core.workerHealthCheckInterval=setInterval((()=>this.checkWorkerHealth()),1e4),LogManager.debug("Worker pool initialized")},createWorkers:function(e){this.terminateWorkers();const t=new Blob([this.workerScript],{type:"application/javascript"}),n=URL.createObjectURL(t);this.workers=[];for(let t=0;t<e;t++)try{const e=new Worker(n);e.onmessage=this.handleWorkerMessage.bind(this),e.onerror=this.handleWorkerError.bind(this),this.workers.push({worker:e,id:t,busy:!1,readyState:!1,lastActivity:Date.now(),errors:0}),e.postMessage({id:"init-"+t,type:"ping"}),e.addEventListener("message",(t=>{if(t.data&&("ready"===t.data.type||"pong"===t.data.type)){const n=this.workers.find((t=>t.worker===e));n&&(n.readyState=!0,n.lastActivity=Date.now(),LogManager.debug(`Worker ${n.id} is ready (${t.data.type})`),t.data.status&&LogManager.debug(`Worker status: ${t.data.status}`))}}),{once:!1})}catch(e){LogManager.error(`Error creating worker: ${e.message}`),console.error("Error creating worker:",e)}document.getElementById("workerStatus").textContent=`${this.workers.length} active`,Core.state.workerCount=e,LogManager.log(`Worker pool created with ${this.workers.length} workers`),URL.revokeObjectURL(n)},terminateWorkers:function(){this.workers.forEach((e=>{try{e.worker.terminate()}catch(e){console.error("Error terminating worker:",e)}})),this.workers=[],this.queue=[],this.processing=[],LogManager.log("All workers terminated")},processFrame:function(e,t="camera-frame"){if(0===this.workers.filter((e=>e.readyState)).length)return void LogManager.warn("No workers ready to process frames");const n={id:this.taskId++,type:t,imageData:e,timestamp:Date.now()};this.queue.push(n),this.processQueue()},isWorkerAvailable:function(){return this.workers.some((e=>!e.busy&&e.readyState))},processQueue:function(){if(0===this.queue.length)return;const e=this.workers.filter((e=>!e.busy&&e.readyState));for(;e.length>0&&this.queue.length>0;){const t=e.pop();let n;this.queue.length>1&&"camera-frame"===this.queue[0].type?(n=this.queue.pop(),this.queue=this.queue.filter((e=>"camera-frame"!==e.type))):n=this.queue.shift(),t.busy=!0,t.lastActivity=Date.now(),this.processing.push({id:n.id,workerId:t.id,timestamp:n.timestamp});const s={width:n.imageData.width,height:n.imageData.height,data:n.imageData.data};t.worker.postMessage({id:n.id,imageData:s,highDensityMode:Core.state.highDensityMode,processingMethod:Core.state.imageProcessing,type:"detect"},[n.imageData.data.buffer]),Core.state.debugMode&&LogManager.log(`Task ${n.id} sent to worker ${t.id} (${n.imageData.width}x${n.imageData.height})`)}},handleWorkerMessage:function(e){const t=e.data,n=this.findWorkerByEvent(e);if(n&&(n.lastActivity=Date.now()),"pong"===t.type)return;if("error"===t.type)return void LogManager.error(`Worker error: ${t.error}`);if("ready"===t.type)return;const s=this.processing.findIndex((e=>e.id===t.id));if(-1!==s){const e=this.processing[s];this.processing.splice(s,1);const n=this.workers.find((t=>t.id===e.workerId));if(n&&(n.busy=!1,t.success&&(n.errors=0)),t.success){Core.state.qrCodesDetected++,Core.state.debugMode&&LogManager.success(`QR code detected by worker ${e.workerId}: ${t.data.substring(0,20)}...`);const n=document.getElementById("decodingStatusBadge");n&&(n.textContent="Active",n.className="status-badge active",LogManager.success("Decoding status directly set to Active")),this.handleQRData(t.data,t.location)}else Core.state.debugMode&&t.debugInfo&&LogManager.log(`No QR code in frame: ${JSON.stringify(t.debugInfo)}`),t.error&&("No QR code detected"===t.error||(t.error.includes("not readable")||t.error.includes("corrupted")?(Core.state.qrErrorStats.notReadable++,LogManager.warn(`QR code detected but not readable: ${t.error}`)):n&&(n.errors++,t.stack&&LogManager.error(`Worker ${e.workerId} error: ${t.error}\n${t.stack}`),n.errors>5&&(LogManager.warn(`Restarting worker ${n.id} after too many errors`),this.restartWorker(n.id)))));this.processQueue()}},handleWorkerError:function(e){LogManager.error("Worker error: "+e.message),console.error("Worker error:",e);const t=this.findWorkerByEvent(e);t&&(t.errors++,t.errors>3&&this.restartWorker(t.id)),LogManager.error("Worker state: "+JSON.stringify({workerCount:this.workers.length,queueLength:this.queue.length,processingTasks:this.processing.length}))},findWorkerByEvent:function(e){return this.workers.find((t=>t.worker===e.target))},restartWorker:function(e){const t=this.workers.findIndex((t=>t.id===e));if(-1===t)return;const n=this.workers[t];try{n.worker.terminate()}catch(e){console.error("Error terminating worker:",e)}try{const t=new Blob([this.workerScript],{type:"application/javascript"}),s=URL.createObjectURL(t),o=new Worker(s);o.onmessage=this.handleWorkerMessage.bind(this),o.onerror=this.handleWorkerError.bind(this),n.worker=o,n.busy=!1,n.readyState=!1,n.lastActivity=Date.now(),n.errors=0,o.addEventListener("message",(e=>{!e.data||"ready"!==e.data.type&&"pong"!==e.data.type||(n.readyState=!0,LogManager.log(`Worker ${n.id} restarted and ready`))})),o.postMessage({id:"restart-"+e,type:"ping"}),URL.revokeObjectURL(s),LogManager.log(`Worker ${e} restarted`)}catch(t){LogManager.error(`Error restarting worker ${e}: ${t.message}`)}},checkWorkerHealth:function(){const e=Date.now();this.workers.forEach((t=>{if(e-t.lastActivity>3e4)return LogManager.warn(`Worker ${t.id} appears stalled, restarting`),void this.restartWorker(t.id);try{t.worker.postMessage({id:"ping-"+t.id,type:"ping"})}catch(e){LogManager.error(`Error sending ping to worker ${t.id}: ${e.message}`),this.restartWorker(t.id)}}));const t=this.processing.filter((t=>e-t.timestamp>1e4));t.length>0&&(LogManager.warn(`Found ${t.length} stale tasks, cleaning up`),this.processing=this.processing.filter((t=>e-t.timestamp<=1e4)),t.forEach((e=>{const n=this.workers.find((t=>t.id===e.workerId));if(n){n.busy=!1;const e=t.filter((e=>e.workerId===n.id));e.length>1&&(LogManager.warn(`Worker ${n.id} had ${e.length} stale tasks, restarting`),this.restartWorker(n.id))}})))},handleQRData:function(e,t){if(Core.state.debugMode){const n="string"==typeof e?e.substring(0,150)+(e.length>150?"...":""):JSON.stringify(e);if(console.error(`Raw QR data received: ${n}`),t){console.log("QR location data received:",t);try{if(t.topLeft&&t.topRight&&"number"==typeof t.topLeft.x&&"number"==typeof t.topLeft.y&&"number"==typeof t.topRight.x&&"number"==typeof t.topRight.y){const e=Math.round(Math.sqrt(Math.pow(t.topRight.x-t.topLeft.x,2)+Math.pow(t.topRight.y-t.topLeft.y,2)));LogManager.log(`QR location: topLeft(${t.topLeft.x},${t.topLeft.y}), dimensions ~${e}px`),LogManager.log(`QR corners: TL(${t.topLeft.x},${t.topLeft.y}), \n                                    TR(${t.topRight.x},${t.topRight.y}), \n                                    BL(${t.bottomLeft.x},${t.bottomLeft.y}), \n                                    BR(${t.bottomRight.x},${t.bottomRight.y})`)}else LogManager.log("QR location provided but coordinates are invalid")}catch(e){LogManager.error(`Error calculating QR dimensions: ${e.message}`)}}else LogManager.log("No QR location data available for this code")}if(UI.updateDecodingStatus(!0),FountainDecoder.processingStats.totalQrDetected++,UI.updateStats(),Core.state.debugMode){const t="string"==typeof e?e:JSON.stringify(e);console.log("FULL QR CODE DATA:",t),LogManager.log(`Full QR data (for debug): ${t.substring(0,500)}${t.length>500?"...":""}`)}if("string"==typeof e&&e.startsWith("{")&&e.endsWith("}"))try{const t=JSON.parse(e);if(LogManager.log(`QR JSON structure: ${Object.keys(t).join(", ")}`),t.seed&&!t.packetId&&(LogManager.log(`Found non-standard seed format. Contains: seed=${t.seed}`),t.data||t.payload)){const n={packetId:t.seed||0,data:t.data||t.payload||""};LogManager.log("Creating compatible chunk format from seed data"),e=JSON.stringify(n)}}catch(e){LogManager.warn(`Failed to parse JSON from QR code: ${e.message}`)}else"string"==typeof e&&e.startsWith("D:")&&(LogManager.success("Detected fountain format with D: prefix"),console.log("Fountain format detected:",e.substring(0,100)));if(FountainDecoder.isValidChunk(e)){const t=FountainDecoder.processChunk(e);t.isNewChunk&&(Core.state.chunksRecovered++,UI.showNotification(`New chunk recovered (${Core.state.chunksRecovered} total)`,"success")),t.isComplete&&(UI.showNotification("File recovery complete!","success"),document.getElementById("downloadFileBtn").disabled=!1),UI.updateFileInfo(FountainDecoder.getFileInfo()),UI.updateChunkGrid(FountainDecoder.getTotalChunks(),FountainDecoder.getReceivedChunkIds()),UI.updateProgressBar(FountainDecoder.getProgress())}else{if(Core.state.debugMode&&LogManager.warn(`QR code did not match any known fountain format: ${"string"==typeof e?e.substring(0,50)+(e.length>50?"...":""):JSON.stringify(e)}`),"string"==typeof e&&e.startsWith("D:")){LogManager.warn("Found D: prefix but wasn't validated as a fountain chunk. Attempting direct processing...");try{const t=e.split(":");if(t.length>=6){const e=parseInt(t[1])||0,n=parseInt(t[4])||10,s=t.slice(6).join(":");FountainDecoder.chunks.push({id:e,data:s}),FountainDecoder.receivedPackets.add(e),FountainDecoder.processingStats.dataPackets++,FountainDecoder.lastUniquePacketTime=Date.now(),FountainDecoder.fileMetadata||(FountainDecoder.fileMetadata={totalChunks:n,name:"reconstructed-file.bin",type:"application/octet-stream",size:0}),LogManager.success(`Forced processing of D: format packet: ID=${e}`),UI.showNotification(`Packet id ${e} recovered via direct processing`,"success");return FountainDecoder.tryReconstructFile()&&(UI.showNotification("File recovery complete!","success"),document.getElementById("downloadFileBtn").disabled=!1),UI.updateFileInfo(FountainDecoder.getFileInfo()),UI.updateChunkGrid(FountainDecoder.getTotalChunks(),FountainDecoder.getReceivedChunkIds()),void UI.updateProgressBar(FountainDecoder.getProgress())}}catch(e){console.error("Error during forced D: format processing:",e)}}FountainDecoder.processingStats.invalidFormats++,UI.showNotification("QR Code: "+("string"==typeof e?e.substring(0,30)+(e.length>30?"...":""):JSON.stringify(e).substring(0,30)+"..."),"info"),EventBus.emit("qrCodeDetected",e,t),Core.state.debugMode&&LogManager.log("Emitted qrCodeDetected event for non-fountain QR code")}UI.updateStats()}},VideoUploader={videoElement:null,canvasElement:null,canvasContext:null,videoFile:null,processInterval:null,processingActive:!1,currentFrame:0,init:function(){this.videoElement=document.getElementById("uploadedVideo"),this.canvasElement=document.getElementById("videoCanvas"),this.canvasContext=this.canvasElement.getContext("2d",{willReadFrequently:!0});document.getElementById("videoFileInput").addEventListener("change",(e=>this.handleFileSelect(e))),document.getElementById("startProcessingBtn").addEventListener("click",(()=>this.startProcessing())),document.getElementById("stopProcessingBtn").addEventListener("click",(()=>this.stopProcessing())),this.videoElement.addEventListener("loadedmetadata",(()=>{document.getElementById("startProcessingBtn").disabled=!1,this.canvasElement.width=this.videoElement.videoWidth,this.canvasElement.height=this.videoElement.videoHeight,LogManager.log(`Video loaded: ${this.videoElement.videoWidth}x${this.videoElement.videoHeight}`)})),LogManager.log("Video uploader initialized")},handleFileSelect:function(e){const t=e.target.files;if(0===t.length)return;const n=t[0];if(!n.type.startsWith("video/"))return void UI.showNotification("Please select a video file","error");document.getElementById("videoFileLabel").textContent=n.name,document.getElementById("videoOverlay").classList.add("hidden");const s=URL.createObjectURL(n);this.videoElement.src=s,this.videoFile=n,LogManager.log(`Video file selected: ${n.name} (${this.formatFileSize(n.size)})`)},formatFileSize:function(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},startProcessing:function(){if(!this.videoFile)return void UI.showNotification("Please select a video file first","warning");this.videoElement.currentTime=0,this.currentFrame=0,this.processingActive=!0,document.getElementById("startProcessingBtn").disabled=!0,document.getElementById("stopProcessingBtn").disabled=!1,document.getElementById("processingStatus").textContent="Active",document.getElementById("processingStatus").className="status-badge active",this.videoElement.play();const e=Core.state.scanRate,t=1e3/e;this.processInterval=setInterval((()=>{this.processVideoFrame()}),t),LogManager.log(`Video processing started at ${e} FPS`),UI.showNotification("Video processing started","info")},stopProcessing:function(){this.processInterval&&(clearInterval(this.processInterval),this.processInterval=null),this.videoElement.pause(),this.processingActive=!1,document.getElementById("startProcessingBtn").disabled=!1,document.getElementById("stopProcessingBtn").disabled=!0,document.getElementById("processingStatus").textContent="Inactive",document.getElementById("processingStatus").className="status-badge inactive",UI.updateDecodingStatus(!1),LogManager.log("Video processing stopped"),UI.showNotification("Video processing stopped","info")},processVideoFrame:function(){if(this.videoElement.readyState!==this.videoElement.HAVE_ENOUGH_DATA||this.videoElement.paused||this.videoElement.ended)return void(this.videoElement.ended&&(this.stopProcessing(),LogManager.log("Video processing complete"),UI.showNotification("Video processing complete","success")));const e=this.videoElement.videoWidth,t=this.videoElement.videoHeight;this.canvasContext.drawImage(this.videoElement,0,0,e,t);const n=this.canvasContext.getImageData(0,0,e,t),s=CameraManager.preprocessImageData(n);Core.state.frameCounter++,this.currentFrame++,Core.state.lastFrameTime=new Date,WorkerPool.processFrame(s),UI.updateStats()}},FountainDecoder={chunks:[],receivedPackets:new Set,receivedChunks:new Set,fileMetadata:null,fileData:null,lastUniquePacketTime:0,processingStats:{totalQrDetected:0,uniqueChunksReceived:0,duplicateChunks:0,invalidFormats:0,metadataChunks:0,dataChunks:0,dataPackets:0},init:function(){this.chunks=[],this.receivedPackets=new Set,this.receivedChunks=new Set,this.dataPackets=0,this.dataChunks=0,this.fileMetadata=null,this.fileData=null,this.lastUniquePacketTime=Date.now(),this.start_time=null,this.systematic_packets_received=0,this.fountain_packets_received=0,this.systematic_phase_complete=!1,this.frames_scanned=0,this.duplicate_frames=0,this.invalid_frames=0,this.decoding_efficiency=0,this.processingStats={totalQrDetected:0,uniqueChunksReceived:0,duplicateChunks:0,invalidFormats:0,metadataChunks:0,dataPackets:0},document.getElementById("downloadFileBtn").addEventListener("click",(()=>this.downloadFile()));const e=document.getElementById("saveChunksBtn");e&&(e.disabled=!0),LogManager.log("Fountain decoder initialized")},extractActualChunkData:function(e){if(!e)return null;if(e.startsWith("D:")){const t=e.split(":");if(t.length>=6)return t.slice(6).join(":")}if(/^\d+:/.test(e)){const t=e.indexOf(":");if(t>0)return e.substring(t+1)}if(e.includes("|")&&e.includes(":"))try{const t=e.split("|");return t.map((e=>{const t=e.indexOf(":");return t>0&&!isNaN(parseInt(e.substring(0,t)))?e.substring(t+1):e})).join("\n---COMBINED CHUNK SEPARATOR---\n")}catch(e){console.error("Error processing combined format:",e)}if(e.startsWith("{")&&e.endsWith("}"))try{const t=JSON.parse(e);if(t.data)return t.data}catch(e){}if(e.startsWith("M:")){const t=e.split(":");if(t.length>=5)try{const e={version:t[1],filename:decodeURIComponent(t[2]),type:decodeURIComponent(t[3]),size:t[4],chunks:t[5]};return"METADATA: "+JSON.stringify(e,null,2)}catch(e){console.error("Error parsing metadata:",e)}}return null},simpleChecksum:function(e){if(!e)return"empty";let t=0;for(let n=0;n<Math.min(e.length,1e4);n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t.toString(16)},analyzeChunkFormat:function(e){if(!e)return"Empty";if(e.startsWith("{")&&e.endsWith("}"))try{const t=JSON.parse(e);return`JSON (keys: ${Object.keys(t).join(", ")})`}catch(e){return"Invalid JSON"}if(e.startsWith("D:")){const t=e.split(":");return t.length>=6?`Fountain (packet: ${t[1]}, seed: ${t[2]}, numChunks: ${t[4]}, degree: ${t[5]})`:"Partial Fountain Format"}if(e.startsWith("M:")){const t=e.split(":");return t.length>=7?`Metadata (version: ${t[1]}, chunks: ${t[5]})`:"Partial Metadata Format"}if(/^\d+:/.test(e)){const t=e.indexOf(":");return`Numeric Prefix (${e.substring(0,t)})`}if(e.includes("|")&&e.includes(":")){return`Combined Format (${e.match(/\|/g).length+1} chunks)`}return e.includes("CHUNK:")?"Custom CHUNK Format":/^[A-Za-z0-9+/]*={0,2}$/.test(e)?"Likely Base64":"Unknown Format"},saveAllChunks:function(){try{if(!this.chunks||0===this.chunks.length)return void LogManager.error("No chunks available to save");const e=this.chunks.reduce(((e,t)=>e+(t.data?t.data.length:0)),0),t=(Math.round(e/1024),"1");if(!t)return;switch(t.trim()){case"1":this._saveMode="full";break;case"2":default:this._saveMode="preview";break;case"3":this._saveMode="smart"}try{const e=`Debugging information for QR File Transfer\nGenerated: ${(new Date).toISOString()}\nTotal received packets: ${this.chunks.length}\nUnique chunk indices received: ${this.receivedChunks.size}\nReceived chunk indices: ${Array.from(this.receivedChunks).sort(((e,t)=>e-t)).join(", ")}\nFile metadata: ${JSON.stringify(this.fileMetadata,null,2)}\nProcessing stats: ${JSON.stringify(this.processingStats,null,2)}\nAll required chunks received: ${this.receivedChunks.size>=(this.fileMetadata?.totalChunks||0)}\n`+(this.missingChunks&&this.missingChunks.size>0?`Missing chunk indices: ${Array.from(this.missingChunks).sort(((e,t)=>e-t)).join(", ")}`:"No missing chunks!")+"\n",t={fileData:this.fileData?`${this.fileData.substring(0,100)}... (${this.fileData.length} chars)`:null,receivedPackets:this.chunks.map((e=>{const t=e.data||"";this.extractActualChunkData(t);let n=null;try{const s=t.replace(/[^A-Za-z0-9+/=]/g,"");if(/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(s))try{n=atob(s)}catch(t){console.log(`Failed to decode base64 in chunk ${e.id}: ${t.message}`)}}catch(t){console.error(`Error processing chunk ${e.id} for base64: ${t.message}`)}const s=this.analyzeChunkFormat(t),o={containsFountainMarker:t.includes("D:"),containsMetadataMarker:t.includes("M:"),containsNumericPrefix:/^\d+:/.test(t),containsPipeSeparator:t.includes("|")};return{id:e.id,dataLength:t.length,format:s,formatDetails:o,preview:t.substring(0,30),detailedData:"full"===this._saveMode||"smart"===this._saveMode&&t.length<=2e3?t:t.substring(0,500)+(t.length>500?" [...truncated, full length: "+t.length+" chars]":"")}})),receivedChunks:Array.from(this.receivedChunks).sort(),processingData:{originalDataLength:this.fileData?this.fileData.length:0,originalDataChecksum:this.fileData?this.simpleChecksum(this.fileData):null,reconstructionMethod:this.fileData?"Fountain":"Not reconstructed",lastError:this._lastError||null}};JSON.stringify(t,null,2)}catch(e){LogManager.error(`Error saving chunks: ${e.message}`),console.error("Error saving chunks:",e)}}catch(e){console.error("Critical error in saveAllChunks:",e),UI.showNotification("Error saving chunks: "+(e.message||"Unknown error"),"error")}},isValidChunk:function(e){try{if(!e||"string"!=typeof e)return LogManager.warn("Invalid chunk: Not a string or empty: "+typeof e),!1;if(Core.state.debugMode&&LogManager.log(`QR data format check: ${e.substring(0,100)}${e.length>100?"...":""}`),e.startsWith("{")&&e.endsWith("}"))try{const t=JSON.parse(e),n=t.hasOwnProperty("packetId")&&t.hasOwnProperty("data"),s=t.hasOwnProperty("seed"),o=n||s;return Core.state.debugMode&&(o?n?LogManager.success(`Valid JSON chunk: packetId=${t.packetId}`):s&&LogManager.success(`Valid JSON seed-based chunk: seed=${t.seed}`):LogManager.warn(`JSON format doesn't match expected patterns. Keys: ${Object.keys(t).join(", ")}`)),o}catch(e){return LogManager.error(`JSON parse error: ${e.message}`),!1}if(e.includes("CHUNK:"))return LogManager.success("Valid chunk format: CHUNK: prefix found"),!0;if(e.startsWith("D:")){const t=e.split(":");if(console.log("D: format detected - parts:",t),Core.state.debugMode){LogManager.success("Found fountain data format with D: prefix, accepting it unconditionally");try{if(t.length>=6){const e=parseInt(t[1]),n=parseInt(t[2]),s=parseInt(t[3]),o=parseInt(t[4]),a=parseInt(t[5]);console.log("Fountain data details:",{counter:e,seed:n,seedBase:s,numChunks:o,degree:a,dataStart:t.length>6?t[6].substring(0,20)+"...":"N/A"})}else console.log("Partial D: format with insufficient parts:",t)}catch(e){console.error("Error parsing fountain format:",e)}}return!0}if(e.startsWith("M:")){const t=e.split(":"),n=t.length>=5;return Core.state.debugMode&&(n?LogManager.success(`Valid metadata format: ${t.length} parts`):LogManager.warn(`Invalid metadata format: ${t.length} parts (expected ≥5)`)),n}if(e.startsWith("seed:"))return LogManager.log(`Found seed-only format: ${e}`),!0;if(/^\d+:/.test(e)){const t=e.indexOf(":");if(t>0){const n=parseInt(e.substring(0,t));if(!isNaN(n))return LogManager.success(`Valid numeric prefix format: ID=${n}`),!0}}return LogManager.warn(`Unrecognized QR format: ${e.substring(0,30)}...`),Core.state.qrErrorStats.invalidFormat++,!1}catch(e){return LogManager.error(`Error validating chunk: ${e.message}`),e.message.includes("integrity")||e.message.includes("checksum")?Core.state.qrErrorStats.failedIntegrity++:e.message.includes("corrupted")||e.message.includes("correctable")?Core.state.qrErrorStats.notCorrectable++:Core.state.qrErrorStats.invalidFormat++,!1}},processChunk:function(e){let t=null,n=-1,s=!1;/^0:/.test(e)&&console.log("!!! FOUND BLOCK 0 - CRITICAL FOR RECONSTRUCTION !!!"),console.log(`Current QR stats before processing: Total=${this.processingStats.totalQrDetected}, Unique=${this.processingStats.uniqueChunksReceived}`);try{if(/^\d+:/.test(e)){console.log("Detected numeric prefix format");try{const s=e.indexOf(":");if(!(s>0))throw new Error("Invalid numeric prefix format");{const o=parseInt(e.substring(0,s));if(t=e.substring(s+1),console.error(`Numeric prefix format: Chunk index=${o}, data length=${t.length}`),Core.state.debugMode&&console.log(`First 50 chars: ${t.substring(0,50)}`),0===o&&(console.log("FOUND CRITICAL CHUNK 0! This is important for reconstruction."),this.missingChunks&&this.missingChunks.has(0)&&console.log("Marking chunk 0 as received in missing chunks tracking")),!this.fileMetadata){const e=Math.max(...Array.from(this.receivedChunks),n),t=Math.max(50,1.5*e);this.fileMetadata={totalChunks:Math.ceil(t),name:"reconstructed-file.xlsx",type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",size:0},console.error(`Created estimated file metadata with ${Math.ceil(t)} total chunks`)}this.processingStats.dataPackets++,LogManager.success(`Successfully processed numeric prefix chunk: id=${n}`)}}catch(e){throw console.error("Error processing numeric prefix format:",e),LogManager.error(`Error processing numeric prefix: ${e.message}`),e}}else if(e.startsWith("D:")){const s=e.split(":");if(console.log("Processing D: format data:",s),s.length<6)throw console.warn("Fountain format has too few parts:",s.length),new Error(`Invalid fountain data format: too few parts (${s.length})`);try{n=parseInt(s[1]);const e=parseInt(s[2]),o=(parseInt(s[3]),parseInt(s[4])),a=parseInt(s[5]);if(isNaN(n)||isNaN(e)||isNaN(o))throw console.error("Invalid numeric values in fountain format",{packetId:n,seed:e,numChunks:o,degree:a}),new Error("Invalid numeric values in fountain format");s.length>=7?(t=s.slice(6).join(":"),console.log("RAW CHUNK DATA:",t.substring(0,100)+(t.length>100?"...":""))):(t="",console.warn("No data part found in fountain format")),this.systematic_phase_complete||this.systematic_packets_received++,!this.systematic_phase_complete&&this.systematic_packets_received>=o&&(this.systematic_phase_complete=!0,this.fountain_packets_received++,LogManager.success("Systematic phase complete, now in fountain phase"),console.log("Systematic phase appears complete, entering fountain phase")),this.processingStats.totalQrDetected>0&&(this.decoding_efficiency=this.processingStats.uniqueChunksReceived/this.processingStats.totalQrDetected);const i=t.split("|");console.log(`Found ${i.length} chunks`);const r=[];for(const e of i){const t=e.indexOf(":");if(t>0){const n=parseInt(e.substring(0,t)),s=e.substring(t+1);if(this.receivedChunks.has(n)){LogManager.log(`Duplicate chunk received: ${n}`),this.processingStats.duplicateChunks++;const e=this.chunks.find((e=>e.id===n));if(!e||e.data&&0!==e.data.length)return{isNewChunk:!1,isComplete:!1};console.log("Found empty chunk 0, replacing with new data"),e.data=s}else this.chunks.push({id:n,data:s}),this.receivedChunks.add(n),this.processingStats.uniqueChunksReceived++,this.lastUniqueChunkTime=Date.now(),this.updateMissingChunks(n),setTimeout((()=>{UI.updateChunkGrid(this.getTotalChunks(),this.getReceivedChunkIds())}),100);LogManager.log(`New chunk received: ${n}`),r.push({index:n,data:s}),console.log(`Extracted chunk ${n}: ${s.substring(0,30)}...`)}}console.log(`Successfully extracted ${r.length} combined chunks`),this.fileMetadata||(this.fileMetadata={totalChunks:o,name:"reconstructed-file.bin",type:"application/octet-stream",size:0},console.log(`Created file metadata with ${o} total chunks`)),this.processingStats.dataPackets++,LogManager.success(`Successfully processed fountain data packet: id=${n}, chunks=${o}, degree=${a}`),console.log(`Fountain packet ${n}/${o} processed successfully, data length: ${t.length}`)}catch(e){throw console.error("Error processing fountain format:",e),LogManager.error(`Error processing fountain format: ${e.message}`),e}}else{if(e.startsWith("M:")){const t=e.split(":");if(t.length<7)throw new Error("Invalid metadata format");console.error(`Metadata: ${e}`);const n=t[1],o=decodeURIComponent(t[2]),a=decodeURIComponent(t[3]),i=parseInt(t[4]),r=parseInt(t[5]);return this.fileMetadata={name:o,type:a,size:i,totalChunks:r,version:n},this.initializeMissingChunks(r),s=!0,this.processingStats.metadataChunks++,LogManager.log(`Metadata received: ${o}, ${r} chunks`),console.log(`Missing chunks initialized: Expecting ${r} chunks to complete file`),{isNewChunk:!0,isComplete:!1}}if(e.startsWith("seed:")){const s=e.split(":");n=parseInt(s[1]),t=s.slice(2).join(":"),LogManager.log(`Seed-based format: id=${n}`),this.processingStats.dataPackets++}}}catch(e){return LogManager.error(`Error parsing chunk: ${e.message}`),this.processingStats.invalidFormats++,{isNewChunk:!1,isComplete:!1}}return{isNewChunk:!0,isComplete:this.tryReconstructFile()}},tryReconstructFile:function(){let e=[];if(!this.fileMetadata||!this.fileMetadata.totalChunks)return console.log("Cannot reconstruct file: missing metadata or totalChunks information"),!1;if(console.log(`Trying to reconstruct file: have ${this.receivedChunks.size} of ${this.fileMetadata.totalChunks} chunks`),this.receivedChunks.size<this.fileMetadata.totalChunks)return!1;console.log("Have all needed chunks, attempting reconstruction...");try{const e=new Array(this.fileMetadata.totalChunks).fill(null);let t=0;this.chunks.forEach((n=>{const s=n.data;if("string"==typeof s&&s.includes("|")&&s.includes(":"))try{const n=s.split("|");for(const s of n){const n=s.indexOf(":");if(n>0){const o=parseInt(s.substring(0,n)),a=s.substring(n+1);!isNaN(o)&&o>=0&&o<this.fileMetadata.totalChunks&&(e[o]=a,t++,console.log(`Placed extracted chunk at index ${o}`))}}}catch(e){console.error("Error processing combined chunks:",e)}else console.log("Chunk doesn't appear to be in combined format, using as-is")}));const n=e.filter((e=>null===e)).length;if(console.log(`Fountain decoding extracted ${t} chunks, missing ${n} of ${this.fileMetadata.totalChunks}`),0===n){let t=e.join("");return this.fileData=t,console.log(`File successfully reconstructed from fountain chunks: ${t.length} characters`),LogManager.success("File successfully reconstructed from fountain chunks"),Core.stopAllBackgroundTasks(),document.getElementById("saveChunksBtn")&&(document.getElementById("saveChunksBtn").disabled=!1),!0}}catch(e){console.error("Error in fountain reconstruction:",e)}console.log("Fountain reconstruction failed or incomplete, trying traditional method"),this.chunks.sort(((e,t)=>e.id-t.id)),console.log(`Sorted ${this.chunks.length} packets by ID`);const t=[];for(let e=0;e<this.fileMetadata.totalChunks;e++)this.receivedChunks.has(e)||(console.warn(`MISSING CHUNK at index ${e}`),t.push(e));if(t.includes(0)){console.error("CRITICAL ERROR: Missing chunk at index 0. This chunk contains essential file information."),LogManager.error("CRITICAL: Missing chunk at index 0. This chunk contains essential file information."),UI.showNotification("Missing first QR code (index 0). Please scan this code first for proper file reconstruction.","error",1e4);const e="missingChunk0Warning";let t=document.getElementById(e);if(!t){t=document.createElement("div"),t.id=e,t.className="error-tracking-container pulse-animation",t.style.marginTop="15px",t.style.padding="15px",t.style.backgroundColor="rgba(220, 38, 38, 0.1)",t.style.border="2px solid var(--danger-color)",t.style.borderRadius="8px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="10px";const n=document.querySelector(".progress-container");if(n&&n.parentNode)n.parentNode.insertBefore(t,n.nextSibling);else{const e=document.querySelector(".info-panel");e&&e.appendChild(t)}}t.innerHTML='\n                        <h3 style="color: var(--danger-color); margin-bottom: 10px;">⚠️ Missing Critical QR Code (Index 0)</h3>\n                        <p>The first QR code (index 0) contains essential information needed to reconstruct the file properly.</p>\n                        <div style="margin-top: 10px;">\n                            <strong>How to fix this issue:</strong>\n                            <ul style="margin-top: 5px; margin-left: 20px;">\n                                <li>Ensure you scan the QR code labeled as "0" or "1 of X" first</li>\n                                <li>If scanning from a screen, try adjusting brightness or contrast</li>\n                                <li>If scanning from paper, ensure good lighting and no reflections</li>\n                                <li>Try increasing the distance between the camera and QR code</li>\n                            </ul>\n                        </div>\n                        <div style="margin-top: 10px;">\n                            <strong>Recovery status:</strong> \n                            <span style="color: var(--warning-color);">Partial recovery may be possible but file integrity cannot be guaranteed</span>\n                        </div>\n                    '}else if(t.length>0){console.warn(`Missing ${t.length} chunks: ${t.join(", ")}`),LogManager.warn(`Missing ${t.length} chunks: ${t.join(", ")}`);const e=document.getElementById("missingChunk0Warning");e&&e.remove()}else{const e=document.getElementById("missingChunk0Warning");e&&e.remove()}const n={};this.chunks.forEach((e=>{n[e.id]={length:e.data?e.data.length:0,start:e.data?e.data.substring(0,20):"null",end:e.data?e.data.substring(e.data.length-20):"null"}})),console.log("CHUNK DATA INFO:",n);let s=new Array(this.fileMetadata.totalChunks).fill(null);if(this.chunks.forEach((e=>{e.id>=0&&e.id<this.fileMetadata.totalChunks&&(null===s[e.id]?(s[e.id]=e.data,console.log(`Placed chunk at index ${e.id} (ID-based assignment)`)):console.log(`Duplicate chunk for index ${e.id}, keeping first occurrence`))})),null===s[0]){console.warn("CRITICAL: First chunk (index 0) is missing! Attempting to recover..."),LogManager.warn("First chunk (index 0) is missing! Attempting recovery...");const e=[];let t=!1,n="";const o=this.chunks.find((e=>0===e.id));if(o)console.log("Found explicit chunk with ID 0, using it"),s[0]=o.data,t=!0,n="Found explicit chunk with ID 0",e.push({method:"Explicit ID",result:"Success",details:"Found chunk explicitly marked as ID 0"});else{e.push({method:"Explicit ID",result:"Failed",details:"No chunk explicitly marked as ID 0 found"}),console.log("Checking for chunks with metadata signatures that suggest it could be chunk 0...");const o={excel:["UEsDB","PK","[Content_Types].xml"],pdf:["%PDF","PDF-"],image:["/9j/","iVBOR","R0lGOD","UklGR"],text:["<!DOCTYPE","<html","<?xml","{","["],json:["{",'{"',"[","[{"],csv:["ID,","Name,","Date,","Time,"]},a=[...this.chunks].sort(((e,t)=>e.id-t.id));let i=!1;for(const r of a)if(r.data&&"string"==typeof r.data&&r.data.length>0){const a=r.data.substring(0,50);for(const[c,l]of Object.entries(o)){for(const o of l)if(a.includes(o)){console.log(`Chunk ${r.id} has ${c} file signature '${o}', using as first chunk`),LogManager.log(`Recovery: Chunk ${r.id} has ${c} signature, using as chunk 0`),s[0]=r.data,t=!0,n=`Detected ${c} file signature`,i=!0,e.push({method:"File Signature",result:"Success",details:`Detected ${c} file signature in chunk ${r.id}`});break}if(i)break}if(i)break}if(!i){e.push({method:"File Signature",result:"Failed",details:"No known file signatures detected in any chunks"});for(const o of a)if(o.id<=5&&o.data&&(console.log(`Examining low ID chunk ${o.id} as possible first chunk`),o.id<=2)){console.log(`Using low ID chunk ${o.id} as the first chunk`),LogManager.log(`Recovery: Using low ID chunk ${o.id} as chunk 0`),s[0]=o.data,t=!0,n=`Used low ID chunk ${o.id}`,e.push({method:"Low ID Proximity",result:"Success",details:`Used chunk with low ID (${o.id}) as substitute for chunk 0`});break}if(null===s[0]&&a.length>0){e.push({method:"Low ID Proximity",result:"Failed",details:"No suitable low ID chunks found"});const o=a[0];console.log(`Last resort: Using lowest ID chunk (${o.id}) as the first chunk`),LogManager.log(`Recovery: Last resort using lowest ID chunk ${o.id} as chunk 0`),s[0]=o.data,t=!0,n=`Last resort: used lowest available ID (${o.id})`,e.push({method:"Last Resort",result:"Success",details:`Used lowest available chunk ID (${o.id}) as last resort`})}else null===s[0]&&(e.push({method:"Last Resort",result:"Failed",details:"No chunks available to use as substitute"}),t=!1,n="All recovery methods failed",console.error("CRITICAL ERROR: Could not recover chunk 0 by any method"),LogManager.error("CRITICAL: All recovery methods for chunk 0 failed"))}}const a=document.getElementById("missingChunk0Warning");if(a){const s=a.querySelector("div:last-child");s&&(s.innerHTML=t?`\n                                    <strong>Recovery status:</strong> \n                                    <span style="color: var(--warning-color);">Attempted recovery using ${n}</span>\n                                    <div style="margin-top: 5px; font-style: italic; color: var(--warning-color);">\n                                        File might be partially recovered but integrity cannot be guaranteed\n                                    </div>\n                                `:'\n                                    <strong>Recovery status:</strong> \n                                    <span style="color: var(--danger-color);">Failed to recover chunk 0</span>\n                                    <div style="margin-top: 5px; font-style: italic; color: var(--danger-color);">\n                                        File reconstruction is likely to fail or produce corrupted results\n                                    </div>\n                                ');const o=document.createElement("button");o.style.marginTop="10px",o.style.padding="8px 12px",o.style.backgroundColor="var(--primary-color)",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.textContent="View Recovery Details",o.onclick=function(){console.log("Recovery attempts:",e);const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0.7)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="1000";const s=document.createElement("div");s.style.backgroundColor="white",s.style.padding="20px",s.style.borderRadius="8px",s.style.width="80%",s.style.maxWidth="600px",s.style.maxHeight="80%",s.style.overflow="auto";let o='\n                                <h3>Chunk 0 Recovery Details</h3>\n                                <p>The following recovery methods were attempted:</p>\n                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">\n                                    <thead>\n                                        <tr>\n                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Method</th>\n                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Result</th>\n                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Details</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                            ';e.forEach((e=>{const t="Success"===e.result?"var(--success-color)":"var(--danger-color)";o+=`\n                                    <tr>\n                                        <td style="border: 1px solid #ddd; padding: 8px;">${e.method}</td>\n                                        <td style="border: 1px solid #ddd; padding: 8px; color: ${t};">${e.result}</td>\n                                        <td style="border: 1px solid #ddd; padding: 8px;">${e.details}</td>\n                                    </tr>\n                                `})),o+=`\n                                    </tbody>\n                                </table>\n                                <p style="margin-top: 15px;">Final recovery status: \n                                    <span style="color: ${t?"var(--warning-color)":"var(--danger-color)"};">\n                                        ${t?"Attempted recovery but data integrity may be compromised":"Failed to recover chunk 0"}\n                                    </span>\n                                </p>\n                                <div style="text-align: right; margin-top: 20px;">\n                                    <button id="closeRecoveryDetails" style="padding: 8px 16px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>\n                                </div>\n                            `,s.innerHTML=o,n.appendChild(s),document.body.appendChild(n),document.getElementById("closeRecoveryDetails").addEventListener("click",(function(){document.body.removeChild(n)}))},a.appendChild(o)}console.log("Recovery attempts summary:",e),LogManager.log(`Chunk 0 recovery ${t?"attempted":"failed"}: ${n}`)}const o=s.filter((e=>null===e)).length;o>0&&(console.warn(`WARNING: ${o} chunks are missing in the ordered array`),s.forEach(((e,t)=>{null===e&&console.warn(`Missing chunk at index ${t}`)})));const a=s.filter((e=>null!==e));console.log(`Using ${a.length} valid chunks out of ${this.fileMetadata.totalChunks} total`),a.forEach(((e,t)=>{if(e){const n=e.substring(0,20).replace(/\s+/g," ");console.log(`Chunk ${t} start: ${n}...`)}}));let i=a.map(((e,t)=>{if("string"!=typeof e)return e;console.log(`Processing chunk ${t} for cleaning, length: ${e.length}`);let n=e;const s=e.match(/^(\d+):/);if(s){const t=s[0];console.log(`Found numeric prefix ${t} in chunk data, removing it`),n=e.substring(t.length),"0"===s[1]&&console.log("This is chunk 0 data - extra careful processing")}if(n.includes("D:")){const e=n.indexOf("D:"),t=n.substring(e).split(":");if(t.length>=6){console.log(`Found possible fountain data format at position ${e}`);const s=t.slice(6).join(":");s.length>0&&(console.log(`Extracted ${s.length} characters of data from fountain format`),n=s)}}else if(n.includes("M:")){const e=n.indexOf("M:");console.log(`Found possible metadata format at position ${e}, skipping this portion`),n=n.substring(0,e)}if(n.length>200){const e=n.substring(0,Math.floor(n.length/2)),t=n.substring(Math.floor(n.length/2));(e.includes(t.substring(0,30))||t.includes(e.substring(0,30)))&&(console.log("Detected possible duplication in chunk data, using first half"),n=e)}if(n.includes("|")&&n.includes(":"))try{const e=n.split("|"),t=e.map((e=>{const t=e.indexOf(":");return t>0&&!isNaN(parseInt(e.substring(0,t)))?e.substring(t+1):e})).join("");console.log(`Processed combined format, extracted ${t.length} characters`),n=t}catch(e){console.error("Error processing combined format:",e)}const o=n.replace(/[\x00-\x1F\x7F-\x9F]/g,"");return o.length!==n.length&&(console.log(`Removed ${n.length-o.length} non-printable characters`),n=o),n})).join("");if(this.fileMetadata){const e=this.fileMetadata.type||"",t=this.fileMetadata.name||"",n=e.includes("text")||t.endsWith(".txt")||e.includes("plain")||e.includes("json"),s=e.includes("spreadsheet")||e.includes("excel")||t.endsWith(".xlsx")||t.endsWith(".xls")||e.includes("pdf")||e.includes("zip")||e.includes("octet-stream")||e.includes("image/");console.log("File type detection: "+(n?"TEXT":s?"BINARY":"UNKNOWN")),console.log(`MIME: ${e}, Name: ${t}`);let o=[];if(s){console.log("Binary file format detected, ensuring data is properly base64-encoded");const e=i.replace(/[^A-Za-z0-9+/=]/g,"");if(o.push({stage:"Original (Binary)",checksum:this.simpleChecksum(i),length:i.length}),e.includes("base64,")){const t=e.indexOf("base64,")+7;i=e.substring(t),console.log("Extracted base64 data after 'base64,' marker")}else i=e,console.log("Using cleaned base64 data")}else if(n){console.log("Text file detected, preserving original content");const e=this.simpleChecksum(i);console.log(`Original text checksum: ${e} (length: ${i.length})`);const t=/[\x00-\x08\x0B\x0C\x0E-\x1F\x80-\xFF]/.test(i),n=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,s=i.replace(/[^A-Za-z0-9+/=]/g,""),a=n.test(s);if(console.log(`Text file analysis: Contains binary: ${t}, Looks like base64: ${a}`),o.push({stage:"Original",checksum:e,length:i.length,containsBinary:t,looksLikeBase64:a}),a||t&&s.length>20)try{console.log("Text appears to be base64 encoded, attempting to decode");const e=atob(s);if(e&&e.length>0&&!/[\x00-\x08\x0B\x0C\x0E-\x1F\x80-\xFF]/.test(e.substring(0,50))){console.log("Successfully decoded base64 to readable text");const t=this.simpleChecksum(e);console.log(`Base64 decoded checksum: ${t} (length: ${e.length})`),o.push({stage:"Base64 Decoded",checksum:t,length:e.length,containsBinary:/[\x00-\x08\x0B\x0C\x0E-\x1F\x80-\xFF]/.test(e),method:"atob"}),i=e}else if(e&&e.length>0){const t=i.substring(0,100),n=e.substring(0,100),s=e=>e.replace(/[^\x20-\x7E]/g,"").length;if(s(n)>s(t)){console.log("Decoded text has more readable characters, using it");const t=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,""),n=this.simpleChecksum(t);console.log(`Cleaned decoded text checksum: ${n} (length: ${t.length})`),o.push({stage:"More Readable Decoded",checksum:n,length:t.length,containsBinary:!1,method:"base64 decode + regex clean"}),i=t}else console.log("Original content has more readable text than decoded"),i=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"")}}catch(e){console.warn("Error during base64 decode:",e),i=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"")}else t?(console.log("Text contains binary characters, cleaning them"),i=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"")):console.log("Text appears to be clean already");console.log("Cleaned text content (first 100 chars):"),console.log(i.substring(0,100))}else console.log("Unknown file type, applying general cleanup"),o.push({stage:"Original (Unknown Type)",checksum:this.simpleChecksum(i),length:i.length,containsBinary:/[\x00-\x08\x0B\x0C\x0E-\x1F\x80-\xFF]/.test(i)});const a=i.replace(/[^A-Za-z0-9+/=]/g,"");if(/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(a))i=a,console.log("Content appears to be base64, using cleaned base64 data"),o.push({stage:"Final (Base64 detected)",checksum:this.simpleChecksum(a),length:a.length,method:"cleaned base64"});else{const e=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"");i=e,console.log("Using cleaned text content"),o.push({stage:"Final (Not Base64)",checksum:this.simpleChecksum(e),length:e.length,method:"binary character cleanup"})}}if(e&&e.length>0){this._dataTransformations=e,console.log(`Data transformation history: ${e.length} stages`);const t=e[0]?.checksum,n=this.simpleChecksum(i);console.log(`File transformation: Original checksum ${t}, Final checksum ${n}`),console.log("File integrity: "+(t===n?"PRESERVED":"MODIFIED")),this._transformationSummary={stages:e.length,originalChecksum:t,finalChecksum:n,integrityPreserved:t===n,originalLength:e[0]?.length,finalLength:i.length}}if(this.fileData=i,console.log(`File reconstructed: ${i.length} characters`),document.getElementById("saveChunksBtn")&&(document.getElementById("saveChunksBtn").disabled=!1),i.length>0&&(console.log(`First 100 chars: ${i.substring(0,100)}`),console.log(`Last 100 chars: ${i.substring(i.length-100)}`),this.fileMetadata&&(this.fileMetadata.type.includes("excel")||this.fileMetadata.name?.endsWith(".xlsx")))){i.startsWith("UEsDB")||i.includes("PK")?console.log("Excel file signature detected in the data - good sign!"):console.warn("Excel file signature not found - file may be corrupted")}return LogManager.success("File successfully reconstructed"),Core.stopAllBackgroundTasks(),this.showFileCompletionIndicator(),!0},showFileCompletionIndicator:function(){if(!this.fileMetadata||!this.fileData)return void console.log("Cannot show file completion indicator: missing file data or metadata");const e="fileCompletionIndicator";let t=document.getElementById(e);if(!t){t=document.createElement("div"),t.id=e,t.style.backgroundColor="var(--background-color, #f8f9fa)",t.style.border="2px solid var(--success-color, #28a745)",t.style.borderRadius="8px",t.style.padding="15px",t.style.margin="20px 0",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.1)";(document.querySelector(".container")||document.body).appendChild(t)}const n=this.fileMetadata.name||"reconstructed-file.bin",s=(o=this.fileMetadata.size||this.fileData.length)<1024?`${o} bytes`:o<1048576?`${(o/1024).toFixed(2)} KB`:`${(o/1048576).toFixed(2)} MB`;var o;const a=this.fileMetadata.type||"application/octet-stream";t.innerHTML=`\n                    <h3 style="color: var(--success-color, #28a745); margin-bottom: 5px;">✅ File Successfully Reconstructed</h3>\n                    <div style="margin: 5px 0;">\n                        <strong>File Name:</strong> ${n}\n                    </div>\n                    <div style="margin: 5px 0;">\n                        <strong>Size:</strong> ${s}\n                    </div>\n                    <div style="margin: 5px 0;">\n                        <strong>Type:</strong> ${a}\n                    </div>\n                    <div style="margin: 15px 0 5px;">\n                        <button id="downloadReconstructedBtn" style="\n                            background-color: var(--primary-color, #007bff);\n                            color: white;\n                            border: none;\n                            padding: 8px 15px;\n                            border-radius: 4px;\n                            cursor: pointer;\n                            font-weight: bold;\n                        ">Download File</button>\n                    </div>\n                `,setTimeout((()=>{const e=document.getElementById("downloadReconstructedBtn");e&&e.addEventListener("click",(()=>{console.log("Download button clicked"),this.downloadFile()}))}),100)},getFileInfo:function(){return this.fileMetadata?{name:this.fileMetadata.name||"unknown",type:this.fileMetadata.type||"application/octet-stream",size:this.fileMetadata.size||0,totalChunks:this.fileMetadata.totalChunks||0,recoveredChunks:this.receivedChunks.size,complete:null!==this.fileData}:null},getTotalChunks:function(){return this.fileMetadata?this.fileMetadata.totalChunks:0},initializeMissingChunks:function(e){if(!e||e<=0)return;console.log(`Initializing missing chunks tracking for ${e} chunks`),this.missingChunks=new Set;for(let t=0;t<e;t++)this.missingChunks.add(t);this.receivedChunks.forEach((e=>{this.missingChunks.has(e)&&this.missingChunks.delete(e)})),console.log(`Missing chunks initialized: ${this.missingChunks.size} chunks missing`);const t=Array.from(this.missingChunks).sort(((e,t)=>e-t));console.log(`Missing chunks: ${t.join(", ")}`),this.updateMissingChunksUI()},getMissingChunkIds:function(){if(!this.missingChunks)return[];this.missingChunks.has(0)&&this.receivedChunks.has(0)&&(console.log("INCONSISTENCY DETECTED: Chunk 0 is in both receivedChunks and missingChunks!"),console.log("Fixing by removing chunk 0 from missing chunks list"),this.missingChunks.delete(0),console.log(`After fixing chunk 0 inconsistency: missingChunks has chunk 0? ${this.missingChunks.has(0)}`)),this.receivedChunks.has(0)?(console.log("Status check: We have chunk 0 in receivedChunks"),this.missingChunks.has(0)?(console.log("CRITICAL ERROR: Chunk 0 is still marked as missing even though we have it!"),this.missingChunks.delete(0)):console.log("Good: Chunk 0 is properly marked as received (not in missing chunks)")):(console.log("Status check: We do NOT have chunk 0 in receivedChunks yet"),this.missingChunks.has(0)||(console.log("INCONSISTENCY: Chunk 0 is not marked as missing even though we don't have it!"),this.missingChunks.add(0)));const e=Array.from(this.missingChunks).sort(((e,t)=>e-t));return e.length>0?console.log(`Missing ${e.length} chunks: ${e.join(", ")}`):console.log("No missing chunks! All chunks have been received."),e},updateMissingChunksUI:function(){setTimeout((()=>{if(UI.updateChunkGrid(this.getTotalChunks(),this.getReceivedChunkIds()),document.getElementById("debugManifest")){const e=this.getMissingChunkIds(),t=e.length>0?`Missing ${e.length} chunks`:"No missing chunks - all data received!";document.getElementById("debugManifest").innerHTML+=`<div class="debug-item" style="color: ${e.length>0?"orange":"green"}">${t}</div>`}}),50)},updateMissingChunks:function(e){if(!this.missingChunks)return void console.log("Missing chunks tracking not initialized yet");const t=parseInt(e);if(isNaN(t))console.warn(`Invalid chunk ID for missing chunks update: ${e}`);else if(this.missingChunks.has(t)&&(this.missingChunks.delete(t),console.log(`Removed chunk ${t} from missing chunks list. ${this.missingChunks.size} chunks still missing.`),0===t&&console.log("CRITICAL CHUNK 0 RECEIVED AND PROCESSED SUCCESSFULLY!"),this.updateMissingChunksUI(),0===this.missingChunks.size)){console.log("ALL CHUNKS RECEIVED! File is complete.");this.tryReconstructFile()&&this.fileData&&(console.log("File reconstruction successful - triggering automatic download"),Core.stopAllBackgroundTasks(),setTimeout((()=>{UI.showNotification("File reconstruction complete! Starting download...","success",5e3),this.downloadFile()}),500))}},getReceivedChunkIds:function(){const e=Array.from(this.receivedChunks);return e.length>0&&!e.includes(0)?(console.log("Forcing chunk 0 to appear as received in the UI for better visualization"),[0,...e]):e},getProgress:function(){return this.fileMetadata&&this.fileMetadata.totalChunks?Math.round(this.receivedChunks.size/this.fileMetadata.totalChunks*100):0},formatFileSize:function(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},showFileCompletionIndicator:function(){const e="fileCompletionIndicator";let t=document.getElementById(e);if(!t){t=document.createElement("div"),t.id=e,t.className="success-indicator pulse-animation",t.style.marginTop="15px",t.style.padding="15px",t.style.backgroundColor="rgba(22, 163, 74, 0.1)",t.style.border="2px solid var(--success-color)",t.style.borderRadius="8px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="10px";const n=document.querySelector(".progress-container");if(n&&n.parentNode)n.parentNode.insertBefore(t,n.nextSibling);else{const e=document.querySelector(".info-panel");e&&e.appendChild(t)}}const n=this.fileMetadata?.name||"unknown",s=this.fileMetadata?.size||0,o=this.formatFileSize(s);t.innerHTML=`\n                    <h3 style="color: var(--success-color); margin-bottom: 5px;">✅ File Successfully Reconstructed</h3>\n                    <div style="margin: 5px 0;">\n                        <strong>File Name:</strong> ${n}\n                    </div>\n                    <div style="margin: 5px 0;">\n                        <strong>File Size:</strong> ${o}\n                    </div>\n                    <div style="margin: 10px 0; font-style: italic;">\n                        Download has started automatically\n                    </div>\n                    <button id="downloadAgainBtn" style="background-color: var(--success-color); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">\n                        Download Again\n                    </button>\n                `,document.getElementById("downloadAgainBtn").addEventListener("click",(()=>{this.downloadFile()}))},downloadFile:function(){if(this.fileData&&this.fileMetadata)try{let e;if(this.fileData.startsWith("data:"))e=this.fileData;else{const t=this.fileMetadata?.name||"download",n=this.fileMetadata?.type||"application/octet-stream",s=t.split(".").pop()?.toLowerCase()||"",o="txt"===s||"csv"===s||"json"===s||n.includes("text")||n.includes("csv")||n.includes("json"),a="xlsx"===s||"xls"===s||"pdf"===s||"zip"===s||n.includes("excel")||n.includes("spreadsheet")||n.includes("octet-stream")||n.includes("pdf")||n.includes("zip");console.log(`File type analysis: extension=${s}, mimeType=${n}`),console.log(`Determined file is ${o?"text":a?"binary":"unknown"} format`),Core.state.debugMode&&(console.log(`File data length: ${this.fileData.length} characters`),console.log(`First 50 chars: ${this.fileData.substring(0,50)}`),console.log(`Last 50 chars: ${this.fileData.substring(this.fileData.length-50)}`));const i=this.fileData.replace(/[^A-Za-z0-9+/=]/g,""),r=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(i);if(o){let t;if(console.log("Text file detected, using improved text handling"),window.improvedTextHandling){console.log("Using improved text handling for text file"),LogManager.log("Processing text file with improved text handling module"),t=window.improvedTextHandling.extractBestText(this.fileData);const e=window.improvedTextHandling.processMixedContent(this.fileData);LogManager.log(`Text processing notes: ${e.processingNotes.join(", ")}`),e.isBase64&&LogManager.success("Detected and processed base64-encoded text content"),e.isBinary&&LogManager.warn("Detected and cleaned binary characters in text file")}else console.log("Improved text handling not available, using basic cleaning"),/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/.test(this.fileData)?(console.log("Text file contains binary characters, cleaning them"),t=this.fileData.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"")):t=this.fileData;const s=new Blob([t],{type:n});e=URL.createObjectURL(s),LogManager.success("Created direct blob URL for text file"),Core.state.debugMode&&(console.log("Text file content (first 200 chars):"),console.log(t.substring(0,200)))}else if(a){if(console.log("Binary file detected, using data as base64"),"xlsx"===s||"xls"===s||n.includes("excel")||n.includes("spreadsheet")){console.log("Excel file specifically detected"),i.startsWith("UEs")||i.startsWith("PK")||console.warn("Warning: Excel file data doesn't have the expected header signature");try{e=`data:${n};base64,${i}`}catch(t){console.warn("Data URI approach failed, trying Blob approach");try{const t=atob(i),s=t.length,o=new Uint8Array(s);for(let e=0;e<s;e++)o[e]=t.charCodeAt(e);const a=new Blob([o],{type:n});e=URL.createObjectURL(a)}catch(t){console.error("Blob approach also failed:",t),e=`data:${n};base64,${i}`}}}else e=`data:${n};base64,${i}`;LogManager.success("Using cleaned data as base64 for binary file")}else if(r&&i.length>100)console.log("Data appears to be base64, using cleaned data"),e=`data:${n};base64,${i}`,LogManager.success("Using cleaned data as base64");else{console.log("Unknown file type, trying to encode as text");try{e=`data:${n};base64,${btoa(this.fileData)}`,LogManager.success("Data encoded with btoa()")}catch(t){LogManager.error(`Error encoding with btoa(): ${t.message}`),console.warn("btoa() failed, using cleaned data directly"),e=`data:${n};base64,${i}`}}}const t=document.createElement("a");t.href=e,t.download=this.fileMetadata.name||"download",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),LogManager.success(`File downloaded: ${this.fileMetadata.name}`),UI.showNotification("File downloaded successfully","success")}catch(e){LogManager.error(`Error downloading file: ${e.message}`),UI.showNotification("Error downloading file","error")}else UI.showNotification("No file available to download","error")},reset:function(){this.chunks=[],this.receivedChunks=new Set,this.missingChunks=null,this.fileMetadata=null,this.fileData=null,this.lastUniqueChunkTime=Date.now(),this.start_time=null,this.systematic_packets_received=0,this.fountain_packets_received=0,this.systematic_phase_complete=!1,this.frames_scanned=0,this.duplicate_frames=0,this.invalid_frames=0,this.decoding_efficiency=0,this.processingStats={totalQrDetected:0,uniqueChunksReceived:0,duplicateChunks:0,invalidFormats:0,metadataChunks:0,dataPackets:0},LogManager.log("Fountain decoder reset")}},Core={workerHealthCheckInterval:null,state:{cameraActive:!1,currentCameraId:null,debugMode:!0,highDensityMode:!0,showDebugCanvas:!0,showScanOverlay:!0,workerCount:4,scanRate:30,imageProcessing:"bw",scaleFactor:1.5,frameCounter:0,qrCodesDetected:0,chunksRecovered:0,lastFrameTime:null,qrErrorStats:{notReadable:0,invalidFormat:0,failedIntegrity:0,notCorrectable:0},enableSaveChunksManifest:!0},init:function(){EventBus.init(),UI.init(),LogManager.init(),CameraManager.init(),VideoUploader.init(),WorkerPool.init(),FountainDecoder.init(),this.setupEventListeners(),this.loadSettings(),this.state.highDensityMode=!0,this.state.debugMode=!0,this.state.workerCount=4,this.state.scanRate=30,this.state.imageProcessing="bw",this.state.scaleFactor=1.5,UI.updateSettingsUI(),LogManager.log("Unified QR Decoder initialized with enhanced settings",{forceConsole:!0}),LogManager.success("Application initialized with enhanced QR detection settings")},setupEventListeners:function(){document.getElementById("saveFrameBtn")?.addEventListener("click",(function(){CameraManager.captureStillFrame()})),document.getElementById("downloadFileBtn")?.addEventListener("click",(function(){FountainDecoder.downloadFile()}))},loadSettings:function(){try{const e=localStorage.getItem("qrDecoderSettings");if(e){const t=JSON.parse(e);Object.assign(this.state,t),LogManager.log("Settings loaded from local storage")}}catch(e){LogManager.error("Error loading settings: "+e.message)}},saveSettings:function(){try{const e={debugMode:this.state.debugMode,highDensityMode:this.state.highDensityMode,showDebugCanvas:this.state.showDebugCanvas,showScanOverlay:this.state.showScanOverlay,workerCount:this.state.workerCount,scanRate:this.state.scanRate,imageProcessing:this.state.imageProcessing,scaleFactor:this.state.scaleFactor};localStorage.setItem("qrDecoderSettings",JSON.stringify(e)),LogManager.log("Settings saved to local storage")}catch(e){LogManager.error("Error saving settings: "+e.message)}},resetSettings:function(){this.state.debugMode=!0,this.state.highDensityMode=!0,this.state.showDebugCanvas=!0,this.state.showScanOverlay=!0,this.state.workerCount=4,this.state.scanRate=30,this.state.imageProcessing="contrast",this.state.scaleFactor=1,WorkerPool.createWorkers(this.state.workerCount),this.saveSettings(),LogManager.log("Settings reset to defaults")},stopAllBackgroundTasks:function(){LogManager.log("Stopping all background tasks after file reconstruction"),CameraManager&&CameraManager.stopCapture&&CameraManager.stopCapture(),VideoUploader&&VideoUploader.stopProcessing&&VideoUploader.stopProcessing(),this.workerHealthCheckInterval&&(clearInterval(this.workerHealthCheckInterval),this.workerHealthCheckInterval=null,LogManager.log("Worker health check interval cleared")),this.backgroundMonitorInterval&&(clearInterval(this.backgroundMonitorInterval),this.backgroundMonitorInterval=null,LogManager.log("Background monitor interval cleared")),UI.updateDecodingStatus(!1),UI.showNotification("File reconstruction complete. Scanning stopped.","success")}};function addTorchButton(){if(!CameraManager.mediaStream)return;const e=CameraManager.mediaStream.getVideoTracks()[0];if(e)try{const t=e.getCapabilities();if(!t||!t.torch)return;const n=document.querySelector(".video-container");if(!n)return;if(!document.getElementById("torchBtn")){const t=document.createElement("button");t.id="torchBtn",t.className="torch-btn",t.innerHTML="💡",t.title="Toggle Flashlight",t.style.display=CameraManager.isFullscreen?"block":"none",t.addEventListener("click",(()=>{Core.state.enableTorch=!Core.state.enableTorch,e.applyConstraints({advanced:[{torch:Core.state.enableTorch}]}).then((()=>{t.innerHTML=Core.state.enableTorch?"💡":"🔦",LogManager.log("Torch "+(Core.state.enableTorch?"enabled":"disabled"))})).catch((e=>{LogManager.warn(`Could not toggle torch: ${e.message}`),UI.showNotification("Could not toggle flashlight","warning")}))})),n.appendChild(t)}if(!document.getElementById("qrGuide")){const e=document.createElement("div");e.id="qrGuide",e.className="qr-guide",e.style.display=CameraManager.isFullscreen?"block":"none",n.appendChild(e)}}catch(e){console.log("Torch capability check error:",e)}}!function(){const e=document.createElement("style");e.textContent="",document.head.appendChild(e)}(),EventBus.emit("chunksUpdated",[]),document.addEventListener("DOMContentLoaded",(()=>{Core.init()}));</script></body></html>