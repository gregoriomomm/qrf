<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>QR Code File Decoder</title><style>.log-filter,body{color:var(--text-color)}.close,button{cursor:pointer}:root{--primary-color:#2563eb;--secondary-color:#1d4ed8;--success-color:#10b981;--warning-color:#f59e0b;--error-color:#ef4444;--text-color:#1f2937;--bg-color:#f9fafb;--panel-bg:#ffffff;--border-color:#e5e7eb}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.5;background-color:var(--bg-color);padding:20px;max-width:1200px;margin:0 auto}h1,h2{margin-bottom:1rem}button{background-color:var(--primary-color);color:#fff;border:none;padding:8px 16px;border-radius:4px;font-weight:500;transition:background-color .2s}.control-panel,.video-container{background-color:var(--panel-bg);border-radius:8px;margin-bottom:20px;padding:15px;box-shadow:0 1px 3px rgba(0,0,0,.1)}button:hover{background-color:var(--secondary-color)}button:disabled{background-color:#9ca3af;cursor:not-allowed}input[type=file]{margin-right:10px}.control-panel{display:flex;justify-content:space-between;align-items:center}.controls{display:flex;gap:10px}.video-container{position:relative}video{width:100%;max-height:400px;background-color:#000;border-radius:4px}canvas{position:absolute;top:15px;left:15px;pointer-events:none}#saveSettingsBtn,.progress-container{margin-top:10px}.progress-bar{height:10px;background-color:var(--primary-color);width:0%;border-radius:5px;transition:width .3s}.progress-text{font-size:14px;margin-top:5px;text-align:right}.chunks-container,.file-info-container{background-color:var(--panel-bg);padding:15px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:20px}.chunk,.chunk.pending{background-color:rgba(229,231,235,.5)}.chunks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(20px,1fr));gap:4px;margin-top:10px}.chunk{height:20px;border:1px solid var(--border-color);border-radius:2px;transition:background-color .3s}.chunk.received{background-color:rgba(16,185,129,.2);border-color:var(--success-color)}.chunk.blinking{animation:.5s blink}@keyframes blink{0%{background-color:rgba(245,158,11,.5)}100%{background-color:rgba(16,185,129,.2)}}#downloadContainer{margin-top:15px}#downloadBtn{background-color:var(--success-color)}#downloadBtn:hover{background-color:#0d9668}.debug-container{background-color:var(--panel-bg);padding:15px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.log-controls{display:flex;gap:8px;margin-bottom:10px}.log-filter{background-color:#e5e7eb;font-size:12px;padding:4px 8px}.log-filter.active{background-color:var(--primary-color);color:#fff}.log-window{height:200px;overflow-y:auto;border:1px solid var(--border-color);border-radius:4px;padding:10px;font-family:monospace;font-size:13px;background-color:#f1f5f9}.log-entry{margin-bottom:4px;border-bottom:1px solid rgba(229,231,235,.5);padding-bottom:4px}.log-debug{color:#6b7280}.log-info{color:#1d4ed8}.log-warn{color:#b45309}.log-error{color:#b91c1c}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}.modal-content{background-color:var(--panel-bg);margin:10% auto;padding:20px;border-radius:8px;max-width:500px;box-shadow:0 4px 6px rgba(0,0,0,.1);position:relative}.close,.scan-line{position:absolute}.close{right:15px;top:10px;font-size:24px}.settings-group{margin-bottom:15px}.settings-group label{display:block;margin-bottom:5px}.settings-group input{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:4px}.error-message{background-color:#fef2f2;border-left:4px solid var(--error-color);padding:15px;margin-bottom:20px;color:#b91c1c;display:none}#resetBtn{background-color:var(--warning-color)}#resetBtn:hover{background-color:#e08c00}.scan-line{height:2px;background-color:rgba(16,185,129,.8);animation:2s infinite scan-animation}@keyframes scan-animation{0%,100%{opacity:.5}50%{opacity:1}}@media (max-width:768px){.control-panel{flex-direction:column;align-items:flex-start}.controls{margin-top:10px;width:100%;flex-wrap:wrap}video{max-height:300px}.chunks-grid{grid-template-columns:repeat(auto-fill,minmax(15px,1fr))}.chunk{height:15px}}</style></head><body><div id="errorMessage" class="error-message"></div><header class="control-panel"><h1>QR Code File Decoder</h1><div class="controls"><input type="file" id="videoInput" accept="video/*"> <button id="startScanBtn" disabled="disabled">Start Scan</button> <button id="stopScanBtn" disabled="disabled">Stop Scan</button> <button id="resetBtn">Reset Contents</button> <button id="settingsBtn">Advanced Settings</button></div></header><div class="video-container"><video id="videoPreview" controls></video><canvas id="overlayCanvas"></canvas><div class="progress-container"><div class="progress-bar" id="scanProgressBar"></div><div class="progress-text" id="scanProgressText">Frames: 0/0 | Time Remaining: --:--</div></div></div><div class="chunks-container"><h2>Chunk Recovery Progress</h2><div class="chunks-grid" id="chunksGrid"></div></div><div class="file-info-container"><h2>File Information</h2><div id="fileInfo">No file detected yet</div><div id="missingChunks">Waiting for metadata...</div><div id="downloadContainer" style="display: none;"><button id="downloadBtn">Download Recovered File</button></div></div><div class="debug-container"><h2>Debug Log</h2><div class="log-controls"><button class="log-filter active" data-level="all">All</button> <button class="log-filter" data-level="debug">Debug</button> <button class="log-filter" data-level="info">Info</button> <button class="log-filter" data-level="warn">Warnings</button> <button class="log-filter" data-level="error">Errors</button> <button id="clearLogBtn">Clear Log</button></div><div class="log-window" id="logWindow"></div></div><div id="settingsModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2>Advanced Settings</h2><div class="settings-group"><label for="workerCount">QR Processing Workers:</label> <input type="number" id="workerCount" min="1" max="16" value="4"></div><div class="settings-group"><label for="packetWorkerCount">Packet Processing Workers:</label> <input type="number" id="packetWorkerCount" min="1" max="8" value="2"></div><div class="settings-group"><label for="frameInterval">Frame Processing Interval (ms):</label> <input type="number" id="frameInterval" min="0" max="1000" value="20"></div><div class="settings-group"><label for="qrDetectionConfidence">QR Detection Confidence (0-1):</label> <input type="number" id="qrDetectionConfidence" min="0" max="1" step="0.1" value="0.5"></div><button id="saveSettingsBtn">Save Settings</button></div></div><script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script><script>class Logger{constructor(e){this.logElement=document.getElementById(e),this.filter="all",this.maxEntries=500,this.entries=[]}debug(e){this.log("debug",e)}info(e){this.log("info",e)}warn(e){this.log("warn",e)}error(e){this.log("error",e)}log(e,t){const s={timestamp:new Date,level:e,message:t};this.entries.push(s),this.entries.length>this.maxEntries&&this.entries.shift();const i=document.createElement("div");i.className=`log-entry log-${e}`;const o=s.timestamp.toLocaleTimeString();i.innerHTML=`[${o}] [${e.toUpperCase()}] ${t}`,"all"!==this.filter&&this.filter!==e&&(i.style.display="none"),this.logElement.appendChild(i),this.logElement.scrollTop=this.logElement.scrollHeight}clear(){this.logElement.innerHTML="",this.entries=[]}setFilter(e){this.filter=e;this.logElement.querySelectorAll(".log-entry").forEach((t=>{if("all"===e)t.style.display="";else{const s=Array.from(t.classList).find((e=>e.startsWith("log-"))).replace("log-","");t.style.display=s===e?"":"none"}}))}}class UI{constructor(e){this.logger=e,this.overlayCanvas=document.getElementById("overlayCanvas"),this.overlayCtx=this.overlayCanvas.getContext("2d")}resetChunkGrid(){document.getElementById("chunksGrid").innerHTML="",document.getElementById("scanProgressBar").style.width="0%",document.getElementById("scanProgressText").textContent="Frames: 0/0 | Time Remaining: --:--",document.getElementById("downloadContainer").style.display="none"}initializeChunkGrid(e){const t=document.getElementById("chunksGrid");t.innerHTML="";for(let s=0;s<e;s++){const e=document.createElement("div");e.className="chunk pending",e.dataset.index=s,t.appendChild(e)}}updateProgress(e,t,s,i){document.getElementById("scanProgressBar").style.width=100*e+"%";const o=document.getElementById("scanProgressText"),r=`${Math.floor(i/60)}:${Math.floor(i%60).toString().padStart(2,"0")}`;o.textContent=`Frames: ${t}/${s} | Time Remaining: ${r}`}updateFileInfo(e){document.getElementById("fileInfo").innerHTML=e}blinkChunk(e){const t=document.querySelector(`.chunk[data-index="${e}"]`);t&&(t.classList.remove("blinking"),t.offsetWidth,t.classList.add("blinking"))}markChunkAsRecovered(e){const t=document.querySelector(`.chunk[data-index="${e}"]`);t&&(t.classList.remove("pending"),t.classList.add("received"))}showSettingsModal(){document.getElementById("settingsModal").style.display="block"}hideSettingsModal(){document.getElementById("settingsModal").style.display="none"}updateLogFilterButtons(e){document.querySelectorAll(".log-filter").forEach((e=>{e.classList.remove("active")})),e.classList.add("active")}showErrorMessage(e){const t=document.getElementById("errorMessage");t.textContent=e,t.style.display="block"}hideErrorMessage(){document.getElementById("errorMessage").style.display="none"}drawQRHighlight(e,t,s,i,o=10){const r=document.getElementById("videoPreview");this.overlayCanvas.width===r.clientWidth&&this.overlayCanvas.height===r.clientHeight||(this.overlayCanvas.width=r.clientWidth,this.overlayCanvas.height=r.clientHeight),this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const n=r.clientWidth/r.videoWidth,a=r.clientHeight/r.videoHeight,c=(e-o)*n,l=(t-o-30)*a,h=Math.max((s+2*o)*n,(i+2*o)*a),d=h,u=h;this.overlayCtx.strokeStyle="#10b981",this.overlayCtx.lineWidth=3,this.overlayCtx.beginPath(),this.overlayCtx.rect(c,0,d,u),this.overlayCtx.stroke();const g=u/4;this.overlayCtx.beginPath();for(let e=1;e<=3;e++){const t=l+g*e;this.overlayCtx.moveTo(c,t),this.overlayCtx.lineTo(c+d,t)}this.overlayCtx.stroke();const m=15;this.overlayCtx.fillStyle="#10b981",this.overlayCtx.fillRect(c-7.5,l-7.5,m,m),this.overlayCtx.fillRect(c+d-7.5,l-7.5,m,m),this.overlayCtx.fillRect(c-7.5,l+u-7.5,m,m),this.overlayCtx.fillRect(c+d-7.5,l+u-7.5,m,m)}clearQRHighlight(){this.overlayCtx&&this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height)}}class PacketProcessor{constructor(){}processQRData(e,t){try{if(e.startsWith("M:"))return this.processMetadataPacket(e,t);if(e.startsWith("D:"))return this.processDataPacket(e,t);throw new Error(`Unknown packet format: ${e.substring(0,10)}...`)}catch(e){return{success:!1,error:e.message,frameIndex:t}}}processMetadataPacket(e,t){const s=e.split(":");if(s.length<10)throw new Error(`Invalid metadata packet format: ${e.substring(0,30)}...`);let i=-1;try{i=parseInt(s[4])}catch(e){console.error(`Invalid file size: ${s[4]}`)}const o={protocolVersion:s[1],fileName:this.decodeURIComponentSafe(s[2]),fileType:this.decodeURIComponentSafe(s[3]),fileSize:i,chunksCount:parseInt(s[5]),packetCount:parseInt(s[6]),maxDegree:parseInt(s[7]),density:parseFloat(s[8]),fps:s[9],chunkSize:parseInt(s[10]||"1024"),redundancy:parseInt(s[11]||"0"),ecl:s[12]||"L",checksum:s[13]||"",ltParams:s.slice(14).join(":")};if((isNaN(o.fileSize)||o.fileSize<=0)&&(o.fileSize=-1,console.error(`Invalid file size: ${s[4]}`)),isNaN(o.chunksCount)||o.chunksCount<=0)throw new Error(`Invalid chunk count: ${s[5]}`);return{success:!0,packetType:"metadata",packetData:o,frameIndex:t}}processDataPacket(e,t){const s=e.split(":");if(s.length<7)throw new Error(`Invalid data packet format: ${e.substring(0,30)}...`);const i=parseInt(s[1]),o=parseInt(s[2]),r=parseInt(s[3]),n=parseInt(s[4]),a=parseInt(s[5]),c=s.slice(6).join(":");let l=[],h=[],d=null;if(1===a){const e=c.split("|");for(let t=0;t<e.length;t++){const s=e[t].split(":",2);if(2===s.length){const e=parseInt(s[0]),t=s[1];e>=0&&e<n&&(l.push(e),h.push({chunkIndex:e,chunkData:t}))}}}else{const e=this.createPRNG(o);l=this.selectChunksLT(e,a,n),d=this.stringToUint8Array(c),console.debug(`Fountain packet ${i} with degree ${a}, source chunks: ${l.join(",")}`)}let u=!1,g=0;const m=c.indexOf(":t:");if(m>0){u=!0;const e=c.substring(m+3).split(":");g=parseInt(e[0]||"0")}return{success:!0,packetType:"data",packetData:{packetId:i,seed:o,seedBase:r,degree:a,fountainData:d,systematicDataChunks:h,sourceChunks:l,isDegreeOne:1===a,isTruncated:u,originalLength:g},frameIndex:t}}decodeURIComponentSafe(e){try{return decodeURIComponent(e)}catch(t){return e}}createPRNG(e){let t=e;return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}}selectChunksLT(e,t,s){const i=[],o=Math.min(t,s);for(;i.length<o;){const t=Math.floor(e()*s);i.includes(t)||i.push(t)}return i}stringToUint8Array(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}}class EnhancedFountainDecoder{constructor(){this.initialized=!1,this.metaData=null,this.totalChunks=0,this.sourceChunks={},this.recoveredChunkCount=0,this.codedPackets=[],this.completeCallback=null,this.newlyRecoveredChunks=[],this.lastProcessedChunk=-1,this.packetStats={total:0,degree1:0,degreeN:0,usefulPackets:0}}initialize(e){this.metaData=e,this.totalChunks=e.chunksCount,this.initialized=!0,this.sourceChunks={},this.recoveredChunkCount=0,this.codedPackets=[],this.newlyRecoveredChunks=[],this.packetStats={total:0,degree1:0,degreeN:0,usefulPackets:0},console.log(`Fountain decoder initialized with ${e.chunksCount} chunks, file size: ${e.fileSize} bytes`)}setCompleteCallback(e){this.completeCallback=e}addPacket(e){if(!this.initialized)throw new Error("Fountain decoder not initialized");if(this.packetStats.total++,e.isDegreeOne){this.packetStats.degree1++;let t=!1;return e.systematicDataChunks.forEach((e=>{const s=e.chunkIndex;if(!this.sourceChunks[s]){const i=this.stringToUint8Array(e.chunkData);this.storeSourceChunk(s,i),this.newlyRecoveredChunks.push(s),t=!0}})),!!t&&(this.packetStats.usefulPackets++,this.propagateAndDecode(),!0)}this.packetStats.degreeN++;const t=e.sourceChunks.filter((e=>!this.sourceChunks[e]));if(0===t.length)return this.recoveredChunkCount===this.totalChunks&&(console.log("All chunks recovered! Finalizing file..."),this.finalizeFile()),!1;if(1===t.length){const s=t[0],i=new Uint8Array(e.fountainData.length);i.set(e.fountainData);for(const t of e.sourceChunks)t!==s&&this.sourceChunks[t]&&this.xorData(i,this.sourceChunks[t]);return this.storeSourceChunk(s,i),this.newlyRecoveredChunks.push(s),this.packetStats.usefulPackets++,this.propagateAndDecode(),!0}return this.codedPackets.push(e),!0}propagateAndDecode(){let e=!0;for(;e;){e=!1;for(let t=this.codedPackets.length-1;t>=0;t--){const s=this.codedPackets[t],i=s.sourceChunks.filter((e=>!this.sourceChunks[e]));if(0!==i.length){if(1===i.length){const o=i[0],r=new Uint8Array(s.fountainData.length);r.set(s.fountainData);for(const e of s.sourceChunks)e!==o&&this.sourceChunks[e]&&this.xorData(r,this.sourceChunks[e]);this.storeSourceChunk(o,r),this.newlyRecoveredChunks.push(o),this.packetStats.usefulPackets++,this.codedPackets.splice(t,1),e=!0}}else this.codedPackets.splice(t,1)}}this.recoveredChunkCount===this.totalChunks&&(console.log("All chunks recovered! Finalizing file..."),this.finalizeFile())}storeSourceChunk(e,t){this.sourceChunks[e]||(t instanceof Uint8Array||(console.warn(`Chunk ${e} data is not a Uint8Array. Converting...`),t=this.ensureUint8Array(t)),this.sourceChunks[e]=t,this.recoveredChunkCount++,console.debug(`Stored chunk ${e}, now have ${this.recoveredChunkCount}/${this.totalChunks} chunks`),e>this.lastProcessedChunk&&(this.lastProcessedChunk=e))}ensureUint8Array(e){return e instanceof Uint8Array?e:"string"==typeof e?this.stringToUint8Array(e):Array.isArray(e)||ArrayBuffer.isView(e)?new Uint8Array(e):(console.error("Unknown data type, cannot convert to Uint8Array:",typeof e),new Uint8Array(0))}stringToUint8Array(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}xorData(e,t){const s=Math.min(e.length,t.length);for(let i=0;i<s;i++)e[i]^=t[i]}getNewlyRecoveredChunks(){const e=[...this.newlyRecoveredChunks];return this.newlyRecoveredChunks=[],e}getRecoveryProgress(){return{recovered:this.recoveredChunkCount,total:this.totalChunks,percentage:Math.round(this.recoveredChunkCount/this.totalChunks*100),packetStats:this.packetStats}}finalizeFile(){console.log("Finalizing file reconstruction..."),console.log(`Recovery stats: ${this.recoveredChunkCount}/${this.totalChunks} chunks`),console.log(`Packet stats: ${JSON.stringify(this.packetStats)}`);try{for(let e=0;e<this.totalChunks;e++)if(!this.sourceChunks[e])return void console.error(`Missing chunk ${e} during file reconstruction, cannot finalize`);let e=this.metaData.fileSize;if(isNaN(e)||e<=0){e=0;for(let t=0;t<this.totalChunks;t++)e+=this.sourceChunks[t].length;console.log(`File size not provided in metadata, calculated: ${e} bytes`)}let t=new Uint8Array(e),s=0;const i=this.metaData.chunkSize||this.sourceChunks[0].length;console.log(`Using chunk size: ${i} bytes`);for(let e=0;e<this.totalChunks;e++){const i=this.sourceChunks[e];if(!i){console.error(`Chunk ${e} is missing`);continue}if(!(i instanceof Uint8Array)){console.error(`Chunk ${e} is not a Uint8Array: ${typeof i}`);continue}const o=Math.min(i.length,t.length-s);try{t.set(i.subarray(0,o),s),s+=o}catch(r){throw console.error(`Error copying chunk ${e}:`,r),console.error(`Chunk length: ${i.length}, bytesToCopy: ${o}, offset: ${s}, fileData.length: ${t.length}`),r}if(s>=t.length)break}console.log(`File reconstruction complete. Total size: ${t.length} bytes`);try{console.log("Decoding base64 data...");const e=this.arrayBufferToString(t);t=this.base64ToArrayBuffer(e),console.log(`Base64 decoded size: ${t.length} bytes`)}catch(e){console.error("Error decoding base64:",e)}this.completeCallback&&this.completeCallback(t)}catch(e){console.error("Error finalizing file:",e)}}arrayBufferToString(e){return new TextDecoder("utf-8").decode(e)}base64ToArrayBuffer(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}catch(e){throw console.error("Base64 decoding error:",e),e}}}class WorkerPoolManager{constructor(e,t){this.workerScript=e,this.workerCount=Math.max(1,Math.min(t,16)),this.workers=[],this.busyWorkers=new Set,this.taskQueue=[],this.resultCallback=null,this.errorCallback=null,this.initializeWorkers()}initializeWorkers(){for(let e=0;e<this.workerCount;e++)try{const e=new Worker(this.workerScript);e.onmessage=t=>{this.resultCallback&&this.resultCallback(t.data),this.busyWorkers.delete(e),this.processNextTask()},e.onerror=t=>{console.error("Worker error:",t),this.errorCallback&&this.errorCallback(t),this.busyWorkers.delete(e),this.processNextTask()},this.workers.push(e)}catch(e){console.error("Failed to create worker:",e),this.errorCallback&&this.errorCallback(e)}}setResultCallback(e){this.resultCallback=e}setErrorCallback(e){this.errorCallback=e}processTask(e){this.taskQueue.push(e),this.processNextTask()}processNextTask(){if(0===this.taskQueue.length||this.busyWorkers.size===this.workers.length)return;const e=this.workers.find((e=>!this.busyWorkers.has(e)));if(!e)return;this.busyWorkers.add(e);const t=this.taskQueue.shift();e.postMessage(t)}terminate(){this.workers.forEach((e=>e.terminate())),this.workers=[],this.busyWorkers.clear(),this.taskQueue=[]}getQueueLength(){return this.taskQueue.length}getBusyWorkerCount(){return this.busyWorkers.size}}class EnhancedVideoProcessor{constructor(e){this.frameCallback=e.frameCallback,this.progressCallback=e.progressCallback,this.errorCallback=e.errorCallback,this.frameInterval=e.frameInterval||20,this.videoElement=document.getElementById("videoPreview"),this.videoFile=null,this.processedFrames=0,this.totalFrames=0,this.startTime=0,this.isProcessing=!1,this.processTimer=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.frameStats={processed:0,qrCodesDetected:0,processingTimes:[]}}static isWebCodecsSupported(){return"function"==typeof window.VideoDecoder&&"function"==typeof window.VideoEncoder&&"function"==typeof window.EncodedVideoChunk}async initialize(e){this.videoFile=e,this.processedFrames=0,this.frameStats={processed:0,qrCodesDetected:0,processingTimes:[]};try{const t=URL.createObjectURL(e);return this.videoElement.src=t,await new Promise((e=>{this.videoElement.onloadedmetadata=()=>e()})),this.totalFrames=Math.ceil(30*this.videoElement.duration),this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,console.log(`Video initialized: ${this.videoElement.videoWidth}x${this.videoElement.videoHeight}, duration: ${this.videoElement.duration}s, estimated frames: ${this.totalFrames}`),!0}catch(e){throw this.errorCallback&&this.errorCallback(e),e}}startProcessing(){this.isProcessing||(this.isProcessing=!0,this.startTime=performance.now(),this.videoElement.currentTime=0,this.videoElement.play(),"requestVideoFrameCallback"in HTMLVideoElement.prototype?this.processWithVideoFrameCallback():this.processTimer=setInterval((()=>{this.processCurrentFrame()}),this.frameInterval),console.log(`Video processing started with frame interval: ${this.frameInterval}ms`))}processWithVideoFrameCallback(){const e=(t,s)=>{this.isProcessing&&(this.processCurrentFrame(),!this.isProcessing||this.videoElement.paused||this.videoElement.ended?this.completed():this.videoElement.requestVideoFrameCallback(e))};this.videoElement.requestVideoFrameCallback(e)}processCurrentFrame(){if(!this.isProcessing)return;if(this.videoElement.paused||this.videoElement.ended)return void this.completed();const e=performance.now();this.processedFrames++,this.frameStats.processed++;try{this.ctx.drawImage(this.videoElement,0,0,this.canvas.width,this.canvas.height);const t=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),s=Math.min(this.videoElement.currentTime/this.videoElement.duration,1),i=(performance.now()-this.startTime)/1e3,o=s>0?i/s:0,r=Math.max(0,o-i);this.progressCallback&&this.progressCallback(s,this.processedFrames,this.totalFrames,r),this.frameCallback&&this.frameCallback(t,this.videoElement.currentTime,this.processedFrames);const n=performance.now()-e;if(this.frameStats.processingTimes.push(n),this.frameStats.processed%30==0){const e=this.frameStats.processingTimes.reduce(((e,t)=>e+t),0)/this.frameStats.processingTimes.length;if(console.log(`Avg frame processing time: ${e.toFixed(2)}ms over last ${this.frameStats.processingTimes.length} frames`),this.frameStats.processingTimes=[],e>1.5*this.frameInterval){const t=Math.min(Math.ceil(1.2*e),100);console.log(`Adjusting frame interval from ${this.frameInterval}ms to ${t}ms due to performance`),this.frameInterval=t,this.processTimer&&(clearInterval(this.processTimer),this.processTimer=setInterval((()=>{this.processCurrentFrame()}),this.frameInterval))}}}catch(e){console.error("Error processing frame:",e),this.errorCallback&&this.errorCallback(e)}}stopProcessing(){this.isProcessing=!1,this.videoElement.paused||this.videoElement.pause(),this.processTimer&&(clearInterval(this.processTimer),this.processTimer=null),console.log(`Video processing stopped. Processed ${this.frameStats.processed} frames, detected ${this.frameStats.qrCodesDetected} QR codes`),this.completed()}completed(){this.isProcessing=!1}}class EnhancedQRProcessor{constructor(e){this.onQrDetected=e.onQrDetected,this.onError=e.onError,this.detectionConfidence=e.detectionConfidence||.5,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.html5QrCode=null,this.isReady=!1,this.detectionStats={attempts:0,successes:0,failures:0,lastDetectedFrameIndex:-1,duplicates:0},this.recentlySeenQRs=new Map,this.maxCacheSize=50,this.qrElement=document.createElement("div"),this.qrElement.id="qr-reader-hidden",this.qrElement.style.display="none",document.body.appendChild(this.qrElement)}async initialize(){try{return this.html5QrCode=new Html5Qrcode("qr-reader-hidden",{formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE,Html5QrcodeSupportedFormats.DATA_MATRIX,Html5QrcodeSupportedFormats.CODE_39,Html5QrcodeSupportedFormats.CODE_93,Html5QrcodeSupportedFormats.CODE_128,Html5QrcodeSupportedFormats.EAN_8,Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.ITF,Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.UPC_E]}),this.isReady=!0,console.log("QR processor initialized successfully"),!0}catch(e){throw this.onError&&this.onError(e),console.error("Failed to initialize HTML5QRCode",e),e}}processFrame(e,t){if(!this.isReady)throw new Error("QR processor not initialized");return this.detectionStats.attempts++,new Promise(((s,i)=>{try{this.canvas.width===e.width&&this.canvas.height===e.height||(this.canvas.width=e.width,this.canvas.height=e.height),this.ctx.putImageData(e,0,0);const i=this.canvas.toDataURL("image/jpeg");this.html5QrCode.scanFile(this.dataURLtoFile(i,"frame.jpg"),!1,void 0).then((i=>{this.detectionStats.successes++;if(this.checkDuplicate(i,t))this.detectionStats.duplicates++,s({success:!1,isDuplicate:!0,frameIndex:t});else{this.addToRecentlySeen(i,t),this.detectionStats.lastDetectedFrameIndex=t,this.detectionStats.successes%10==0&&console.log(`QR detection stats: ${this.detectionStats.successes}/${this.detectionStats.attempts} successful (${this.detectionStats.duplicates} duplicates)`);const o=this.html5QrCode._lastScanResult||null;s({success:!0,qrData:i,frameIndex:t,bounds:this.estimateBounds({result:o,imageData:e})})}})).catch((e=>{this.detectionStats.failures++,s({success:!1,frameIndex:t})}))}catch(e){this.detectionStats.failures++,this.onError&&this.onError(e),s({success:!1,frameIndex:t})}}))}checkDuplicate(e,t){if(this.recentlySeenQRs.has(e)){return t-this.recentlySeenQRs.get(e)<5}return!1}addToRecentlySeen(e,t){if(this.recentlySeenQRs.set(e,t),this.recentlySeenQRs.size>this.maxCacheSize){const e=Array.from(this.recentlySeenQRs.entries());e.sort(((e,t)=>e[1]-t[1]));const t=Math.ceil(.2*this.maxCacheSize);for(let s=0;s<t;s++)e[s]&&this.recentlySeenQRs.delete(e[s][0])}}estimateBounds(e){if(e&&e.result&&e.result.location){const t=e.result.location,s=[t.topLeft.x,t.topRight.x,t.bottomLeft.x,t.bottomRight.x],i=[t.topLeft.y,t.topRight.y,t.bottomLeft.y,t.bottomRight.y],o=Math.min(...s),r=Math.max(...s),n=Math.min(...i),a=Math.max(...i),c=r-o,l=a-n,h=Math.max(c,l);return{x:(o+r)/2-h/2,y:(n+a)/2-h/2,width:h,height:h}}const t=e.imageData||{width:300,height:300},s=t.width/2,i=(t.height,Math.min(t.width,t.height)/2.5);return{x:s-i/2,y:0,width:i,height:i}}dataURLtoFile(e,t){const s=e.split(","),i=s[0].match(/:(.*?);/)[1],o=atob(s[1]);let r=o.length;const n=new Uint8Array(r);for(;r--;)n[r]=o.charCodeAt(r);return new File([n],t,{type:i})}dispose(){if(this.html5QrCode)try{this.html5QrCode.clear()}catch(e){console.error("Error clearing HTML5QRCode",e)}this.qrElement&&this.qrElement.parentNode&&this.qrElement.parentNode.removeChild(this.qrElement),console.log(`QR processor disposed. Final stats: ${JSON.stringify(this.detectionStats)}`)}}class QRFileDecoder{constructor(){this.logger=new Logger("logWindow"),this.ui=new UI(this.logger),this.videoProcessor=null,this.qrProcessor=null,this.packetProcessor=null,this.fountainDecoder=null,this.isProcessing=!1,this.videoFile=null,this.metadataReceived=!1,this.fileMetadata=null,this.recoveredChunks=new Map,this.missingChunks=new Set,this.settings={workerCount:4,packetWorkerCount:2,frameInterval:20,qrDetectionConfidence:.5},this.qrCodesDetected=0,this.packetsProcessed=0,this.recoveredFileData=null,this.checkCompatibility(),this.initEventListeners(),this.logger.info("QR File Decoder initialized")}checkCompatibility(){EnhancedVideoProcessor.isWebCodecsSupported()||(this.ui.showErrorMessage("WebCodecs API is not supported in your browser. Please use Chrome 94+, Edge 94+, or another compatible browser."),document.getElementById("startScanBtn").disabled=!0),"undefined"==typeof Html5Qrcode&&(this.ui.showErrorMessage("HTML5QRCode library is not available. Please check your internet connection and reload the page."),document.getElementById("startScanBtn").disabled=!0)}resetContents(){this.isProcessing&&this.stopProcessing(),this.metadataReceived=!1,this.fileMetadata=null,this.recoveredChunks=new Map,this.missingChunks=new Set,this.qrCodesDetected=0,this.packetsProcessed=0,this.recoveredFileData=null,this.ui.resetChunkGrid(),this.ui.updateFileInfo("No file detected yet"),document.getElementById("missingChunks").textContent="Waiting for metadata...",document.getElementById("scanProgressBar").style.width="0%",document.getElementById("scanProgressText").textContent="Frames: 0/0 | Time Remaining: --:--",document.getElementById("downloadContainer").style.display="none",this.ui.clearQRHighlight(),this.ui.hideErrorMessage(),document.getElementById("startScanBtn").disabled=!this.videoFile,this.logger.info("Contents reset, ready for new scan")}initEventListeners(){document.getElementById("videoInput").addEventListener("change",this.handleVideoInput.bind(this)),document.getElementById("startScanBtn").addEventListener("click",this.startProcessing.bind(this)),document.getElementById("stopScanBtn").addEventListener("click",this.stopProcessing.bind(this)),document.getElementById("downloadBtn").addEventListener("click",this.downloadFile.bind(this)),document.getElementById("settingsBtn").addEventListener("click",this.ui.showSettingsModal.bind(this.ui)),document.getElementById("saveSettingsBtn").addEventListener("click",this.saveSettings.bind(this)),document.getElementById("clearLogBtn").addEventListener("click",this.logger.clear.bind(this.logger)),document.querySelectorAll(".log-filter").forEach((e=>{e.addEventListener("click",(e=>{this.logger.setFilter(e.target.dataset.level),this.ui.updateLogFilterButtons(e.target)}))})),document.querySelector(".modal .close").addEventListener("click",this.ui.hideSettingsModal.bind(this.ui)),document.getElementById("resetBtn").addEventListener("click",this.resetContents.bind(this))}async handleVideoInput(e){if(e.target.files&&0!==e.target.files.length){this.videoFile=e.target.files[0],this.logger.info(`Video file selected: ${this.videoFile.name} (${this.formatFileSize(this.videoFile.size)})`);try{const e=URL.createObjectURL(this.videoFile),t=document.getElementById("videoPreview");t.src=e,t.onloadedmetadata=()=>{document.getElementById("startScanBtn").disabled=!1,this.logger.info(`Video duration: ${t.duration.toFixed(2)} seconds`)}}catch(e){this.logger.error(`Error loading video: ${e.message}`),this.ui.showErrorMessage(`Error loading video: ${e.message}`)}}}async startProcessing(){if(this.videoFile)if(this.isProcessing)this.logger.warn("Processing already in progress");else{this.isProcessing=!0,this.metadataReceived=!1,this.recoveredChunks.clear(),this.missingChunks.clear(),this.qrCodesDetected=0,this.packetsProcessed=0,this.recoveredFileData=null,document.getElementById("startScanBtn").disabled=!0,document.getElementById("stopScanBtn").disabled=!1,document.getElementById("downloadContainer").style.display="none",this.ui.resetChunkGrid(),this.ui.updateFileInfo("Processing video..."),this.ui.clearQRHighlight(),this.ui.hideErrorMessage(),this.logger.info("Starting video processing");try{await this.initializeComponents(),await this.videoProcessor.initialize(this.videoFile),this.videoProcessor.startProcessing(),this.logger.info("Processing started")}catch(e){this.logger.error(`Failed to start processing: ${e.message}`),this.ui.showErrorMessage(`Failed to start processing: ${e.message}`),this.stopProcessing()}}else this.logger.warn("No video file selected")}async initializeComponents(){this.qrProcessor=new EnhancedQRProcessor({onQrDetected:this.handleQRCodeResult.bind(this),onError:e=>this.logger.error(`QR processing error: ${e.message}`),detectionConfidence:this.settings.qrDetectionConfidence}),await this.qrProcessor.initialize(),this.packetProcessor=new PacketProcessor,this.fountainDecoder=new EnhancedFountainDecoder,this.fountainDecoder.setCompleteCallback(this.handleFileComplete.bind(this)),this.videoProcessor=new EnhancedVideoProcessor({frameCallback:this.handleVideoFrame.bind(this),progressCallback:this.ui.updateProgress.bind(this.ui),errorCallback:e=>this.logger.error(`Video processing error: ${e.message}`),frameInterval:this.settings.frameInterval})}stopProcessing(){if(this.isProcessing&&(this.isProcessing=!1,this.videoProcessor&&this.videoProcessor.stopProcessing(),this.qrProcessor&&this.qrProcessor.dispose(),this.ui.clearQRHighlight(),document.getElementById("startScanBtn").disabled=!1,document.getElementById("stopScanBtn").disabled=!0,this.logger.info("Processing stopped"),this.logger.info(`Processing summary: Detected ${this.qrCodesDetected} QR codes, processed ${this.packetsProcessed} packets`),this.metadataReceived)){const e=this.fountainDecoder.getRecoveryProgress();this.logger.info(`File recovery progress: ${e.recovered}/${e.total} chunks (${e.percentage}%)`),e.packetStats&&this.logger.info(`Packet statistics: ${JSON.stringify(e.packetStats)}`)}}async handleVideoFrame(e,t,s){if(this.isProcessing)try{const t=await this.qrProcessor.processFrame(e,s);t.success?(this.qrCodesDetected++,t.bounds?(this.ui.drawQRHighlight(t.bounds.x,t.bounds.y,t.bounds.width,t.bounds.height),this.logger.info(`QR code detected in frame ${s} at position [${t.bounds.x.toFixed(0)}, ${t.bounds.y.toFixed(0)}]`)):this.logger.info(`QR code detected in frame ${s}`),this.handleQRCodeResult(t)):t.isDuplicate||this.ui.clearQRHighlight()}catch(e){this.logger.error(`Error processing frame ${s}: ${e.message}`)}}handleQRCodeResult(e){if(!e.success)return;const{qrData:t,frameIndex:s}=e;this.logger.debug(`QR code detected in frame ${s}: ${t.substring(0,30)}...`);const i=this.packetProcessor.processQRData(t,s);i.success?this.handlePacketResult(i):this.logger.warn(`Failed to process QR data: ${i.error}`)}handlePacketResult(e){if(!e.success)return void this.logger.warn(`Failed to process packet: ${e.error}`);this.packetsProcessed++;const{packetType:t,packetData:s}=e;"metadata"===t?this.handleMetadataPacket(s):"data"===t&&this.handleDataPacket(s)}handleMetadataPacket(e){if(this.metadataReceived){if(e.fileName===this.fileMetadata.fileName&&e.fileSize===this.fileMetadata.fileSize&&e.chunksCount===this.fileMetadata.chunksCount)return void this.logger.debug("Received duplicate metadata packet");this.logger.warn("Received metadata for a different file, reinitializing")}this.metadataReceived=!0,this.fileMetadata=e,this.ui.initializeChunkGrid(e.chunksCount),this.ui.updateFileInfo(`\n          <div><strong>File Name:</strong> ${e.fileName}</div>\n          <div><strong>File Type:</strong> ${e.fileType}</div>\n          <div><strong>File Size:</strong> ${this.formatFileSize(e.fileSize)}</div>\n          <div><strong>Chunks:</strong> ${e.chunksCount}</div>\n          <div><strong>Protocol Version:</strong> ${e.protocolVersion}</div>\n        `),this.fountainDecoder.initialize(e);for(let t=0;t<e.chunksCount;t++)this.missingChunks.add(t);this.updateMissingChunksUI(),this.logger.info(`Metadata received: ${e.fileName} (${this.formatFileSize(e.fileSize)}), ${e.chunksCount} chunks`)}handleDataPacket(e){if(!this.metadataReceived)return void this.logger.warn("Received data packet before metadata, ignoring");e.sourceChunks&&e.sourceChunks.forEach((e=>{this.ui.blinkChunk(e)}));if(this.fountainDecoder.addPacket(e)){const e=this.fountainDecoder.getNewlyRecoveredChunks();e.length>0&&(e.forEach((e=>{this.recoveredChunks.set(e,!0),this.missingChunks.delete(e),this.ui.markChunkAsRecovered(e)})),this.updateMissingChunksUI(),this.logger.info(`Recovered ${e.length} new chunks, total: ${this.recoveredChunks.size}/${this.fileMetadata.chunksCount}`))}}updateMissingChunksUI(){const e=this.missingChunks.size,t=this.fileMetadata.chunksCount,s=t-e;document.getElementById("missingChunks").innerHTML=`\n          <div>Recovered chunks: ${s}/${t} (${Math.round(s/t*100)}%)</div>\n          <div>Missing chunks: ${e}</div>\n        `,0===e&&s===t&&this.logger.info("All chunks recovered, finalizing file...")}handleFileComplete(e){this.logger.info("File recovery complete!"),this.recoveredFileData=e,document.getElementById("downloadContainer").style.display="block";const t=document.getElementById("fileInfo").innerHTML;document.getElementById("fileInfo").innerHTML=t+'\n          <div style="margin-top: 10px; color: var(--success-color);">\n            <strong>File Successfully Recovered!</strong>\n          </div>\n        ',this.isProcessing&&this.stopProcessing(),this.downloadFile()}downloadFile(){if(this.recoveredFileData&&this.fileMetadata)try{const e=new Blob([this.recoveredFileData],{type:this.fileMetadata.fileType||"application/octet-stream"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=this.fileMetadata.fileName,document.body.appendChild(s),s.click(),setTimeout((()=>{document.body.removeChild(s),URL.revokeObjectURL(t)}),100),this.logger.info(`File "${this.fileMetadata.fileName}" downloaded (${this.formatFileSize(this.recoveredFileData.byteLength)})`)}catch(e){this.logger.error(`Error downloading file: ${e.message}`),this.ui.showErrorMessage(`Error downloading file: ${e.message}`)}else this.logger.warn("No recovered file data available")}saveSettings(){const e=parseInt(document.getElementById("workerCount").value),t=parseInt(document.getElementById("packetWorkerCount").value),s=parseInt(document.getElementById("frameInterval").value),i=parseFloat(document.getElementById("qrDetectionConfidence").value);this.settings={workerCount:isNaN(e)?4:Math.min(Math.max(e,1),16),packetWorkerCount:isNaN(t)?2:Math.min(Math.max(t,1),8),frameInterval:isNaN(s)?20:Math.min(Math.max(s,0),1e3),qrDetectionConfidence:isNaN(i)?.5:Math.min(Math.max(i,0),1)},this.logger.info(`Settings updated: ${JSON.stringify(this.settings)}`),this.ui.hideSettingsModal()}formatFileSize(e){return e<1024?`${e} bytes`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1048576).toFixed(2)} MB`}detectDeviceCapabilities(){const e=navigator.hardwareConcurrency||4,t=navigator.deviceMemory||4;let s=Math.min(Math.max(Math.floor(e/2),1),4),i=50;return(e<=2||t<=2)&&(s=1,i=100),e>=8&&t>=8&&(s=8,i=10),{workerCount:s,packetWorkerCount:Math.max(1,Math.floor(s/2)),frameInterval:i}}}function addDebugButton(){if("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname){const e=document.querySelector(".controls");if(!e)return;const t=document.createElement("button");t.id="debugToolsBtn",t.textContent="Debug Tools",t.style.backgroundColor="#6b7280",t.addEventListener("click",(()=>{console.log("Debug tools accessed. Use window.debugTools in the console to analyze decoder state."),window.debugTools.analyzeDecoderState()})),e.appendChild(t)}}window.debugTools={analyzeDecoderState:function(){if(!window.qrFileDecoder||!window.qrFileDecoder.fountainDecoder)return void console.error("Decoder not initialized");const e=window.qrFileDecoder.fountainDecoder,t={initialized:e.initialized,totalChunks:e.totalChunks,recoveredChunks:e.recoveredChunkCount,recoveryPercentage:e.recoveredChunkCount/e.totalChunks*100,waitingPackets:e.codedPackets.length,metadata:e.metaData,packetStats:e.packetStats};console.log("==== Decoder State Analysis ===="),console.table(t);const s=[];for(let t=0;t<e.totalChunks;t++)e.sourceChunks[t]||s.push(t);return s.length>0?console.log(`Missing chunks (${s.length}):`,s):console.log("All chunks recovered!"),t},exportRecoveredData:function(){if(!window.qrFileDecoder||!window.qrFileDecoder.recoveredFileData)return void console.error("No recovered file data available");const e=window.qrFileDecoder.recoveredFileData;console.log(`Recovered data length: ${e.byteLength} bytes`);const t=new Uint8Array(e.slice(0,100));return console.log("Data preview (first 100 bytes):",t),{byteLength:e.byteLength,preview:Array.from(t)}}},document.addEventListener("DOMContentLoaded",(()=>{window.qrFileDecoder=new QRFileDecoder,setTimeout(addDebugButton,500)}));</script></body></html>