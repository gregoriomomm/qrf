<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>QR File Transfer - Encoder with Auto-Split</title><script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script><style>#qrDisplay,.panel{padding:20px;background:#fff}.control-label,.countdown-display,.info-label,.value-display,button{font-weight:700}*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;line-height:1.5;background:#f5f5f5;color:#333;max-width:1200px;margin:0 auto;padding:20px}h1{margin:20px 0;color:#2563eb}.container{display:flex;flex-wrap:wrap;gap:20px}.panel{border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);flex:1;min-width:300px}.control-panel{display:flex;flex-direction:column;gap:15px}.control-group,.display-container{flex-direction:column;display:flex}.control-group{gap:8px}button{padding:12px;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-top:10px;transition:background .2s}button:hover{background:#1d4ed8}button:disabled{background:#94a3b8;cursor:not-allowed}.display-container{align-items:center;justify-content:center}#qrDisplay{position:relative;margin:0 auto 20px;border:1px solid #ddd;border-radius:8px;max-width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}.info-row,.slider-labels{justify-content:space-between}.progress-container{width:100%;background:#e5e7eb;border-radius:4px;overflow:hidden;height:10px;margin-top:15px}.progress-bar{height:100%;background:#2563eb;width:0;transition:width .3s}.file-info,.metadata-info{background:#f0f9ff;border-radius:8px}.file-info{margin-top:20px;padding:15px;border-left:4px solid #2563eb}.metadata-info{margin-top:10px;padding:10px;border-left:4px solid #1d4ed8}.info-row{display:flex;margin-bottom:8px}.info-label{color:#1e40af}#keepAwakeVideo{position:fixed!important;top:-1px!important;left:-1px!important;width:1px!important;height:1px!important;opacity:0!important;pointer-events:none!important;z-index:-1!important}.fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:1000;display:flex;justify-content:center;align-items:center;flex-direction:column}.exit-button,.fullscreen-counter{top:20px;color:#fff;position:absolute}.fullscreen .qr-container{display:flex;justify-content:center;align-items:center;width:80vmin;height:80vmin;position:relative}.fullscreen-qr{width:100%;height:100%;object-fit:contain;max-width:95vh;max-height:95vh}.fullscreen-progress{position:absolute;bottom:50px;width:80%;max-width:400px}.fullscreen-counter{left:20px;background:rgba(0,0,0,.5);padding:10px;border-radius:4px;font-weight:700;font-size:16px;z-index:10}.exit-button{right:20px;background:#ef4444;border:none;width:40px;height:40px;border-radius:20px;font-size:20px;cursor:pointer}.countdown-display{font-size:120px;color:#1890ff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-shadow:0 0 10px rgba(24,144,255,.5);z-index:100;display:none;background:rgba(0,0,0,.4);width:200px;height:200px;border-radius:50%;line-height:200px;text-align:center}.file-input-label,input[type=range]{background:#e5e7eb;border-radius:4px}.fullscreen .countdown-display{width:250px;height:250px;line-height:250px;font-size:150px;background:rgba(0,0,0,.6)}input[type=range]{width:100%;height:8px;appearance:none;outline:0}input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;background:#2563eb;border-radius:50%;cursor:pointer}.slider-labels{display:flex;font-size:12px;color:#6b7280;margin-top:5px}.value-display{color:#2563eb;margin-left:auto}.file-input-container{position:relative;overflow:hidden;display:inline-block;width:100%}.file-input-label{padding:12px;color:#333;cursor:pointer;display:block;text-align:center;transition:background .2s}.file-input-label:hover,.preset-button:hover{background:#d1d5db}.file-input-container input[type=file]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}.file-list-container{margin-top:15px;background:#f9fafb;border-radius:8px;padding:15px;display:none}.file-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:600}.file-name,.file-status,.switch-label{font-weight:500}.file-list{max-height:300px;overflow-y:auto}.file-item{display:flex;align-items:center;padding:8px;border-bottom:1px solid #e5e7eb;transition:background .2s}.file-item:hover{background:#f3f4f6}.file-item:last-child{border-bottom:none}.file-checkbox{margin-right:12px;width:18px;height:18px;cursor:pointer}.file-info{flex:1;display:flex;flex-direction:column}.file-name{margin-bottom:2px}.file-size{font-size:12px;color:#6b7280}.file-status{margin-left:auto;padding:4px 8px;border-radius:12px;font-size:11px;text-transform:uppercase}.status-pending{background:#fef3c7;color:#d97706}.status-inprogress{background:#dbeafe;color:#2563eb}.status-sent{background:#dcfce7;color:#16a34a}.status-error{background:#fee2e2;color:#dc2626}.batch-controls{display:flex;gap:10px;margin-top:10px}.clear-all-btn,.select-all-btn{font-size:12px;padding:6px 12px}.control-switch{display:flex;align-items:center;cursor:pointer;user-select:none;margin:10px 0}.control-switch input[type=checkbox]{margin-right:8px;width:16px;height:16px}.action-button{background-color:#16a34a;width:100%;padding:14px;font-size:16px}.guide-label,.tooltip:hover::after{position:absolute;color:#fff;font-size:12px}.action-button:hover{background-color:#15803d}.alignment-guide{position:absolute;border:3px dashed rgba(59,130,246,.7);pointer-events:none;display:none}#qrDisplay.show-guides .alignment-guide{display:block}.guide-label{background:rgba(0,0,0,.6);padding:2px 6px;border-radius:4px;pointer-events:none}.preset-button,.tooltip{background:#e5e7eb;text-align:center}.qr-image{transition:opacity .15s ease-out}.preset-selector{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}.preset-button{padding:8px 12px;color:#333;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;flex:1;min-width:120px;transition:.2s}.preset-button.active{background:#2563eb;color:#fff;border-color:#2563eb}.tooltip{position:relative;display:inline-block;margin-left:5px;width:16px;height:16px;color:#6b7280;border-radius:50%;line-height:16px;font-size:11px;font-weight:700;cursor:help}.tooltip:hover::after{content:attr(data-tooltip);top:-5px;left:100%;transform:translateY(-100%);background:rgba(55,65,81,.9);padding:5px 10px;border-radius:4px;width:200px;font-weight:400;z-index:10;line-height:1.4}.handshake-notice{margin-top:20px;padding:10px;background:rgba(245,158,11,.1);border-left:3px solid #f59e0b;border-radius:3px;font-size:13px;color:#92400e}@media (max-width:768px){.container{flex-direction:column}.handshake-notice,.preset-selector{font-size:11px}.preset-button{padding:6px 8px;min-width:90px}.control-label{font-size:14px}h1{font-size:20px;margin:10px 0}.panel{padding:15px}.slider-labels{font-size:10px}.countdown-display{width:150px;height:150px;line-height:150px;font-size:90px}}</style></head><body><video id="keepAwakeVideo" style="position: absolute; top: -1px; left: -1px; width: 1px; height: 1px; opacity: 0; pointer-events: none;" muted loop autoplay><source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDEyMSByMzA1MSAwMWViMzY0IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxOCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTE3IGxvb2thaGVhZF90aHJlYWRzPTIgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yMyBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAJ1liIQAL//+9Qa/8UAqAAADAAA" type="video/mp4"></video><h1>QR Code File Encoder</h1><div class="container"><div class="panel control-panel"><div class="control-group"><label class="control-label">Select File</label><div class="file-input-container"><label class="file-input-label"><span id="fileLabel">Choose files</span> <input type="file" id="fileInput" multiple="multiple"></label></div><div id="fileListContainer" class="file-list-container"><div class="file-list-header"><span>Selected Files</span><div class="batch-controls"><button id="selectAllBtn" class="select-all-btn">Select All</button> <button id="clearAllBtn" class="clear-all-btn">Clear All</button></div></div><div id="fileList" class="file-list"></div></div></div><div class="control-group"><label class="control-label">Performance Presets</label><div class="preset-selector"><button id="fastPreset" class="preset-button">Fast Transfer</button> <button id="reliablePreset" class="preset-button active">Reliable</button> <button id="mobilePreset" class="preset-button">Mobile Optimized</button></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Presets automatically configure optimal settings for your use case</div></div><div class="control-group"><div class="control-label">QR Size <span class="value-display" id="sizeValue">800px</span> <span class="tooltip" data-tooltip="Size of the QR code in pixels. Larger QR codes are easier to scan but may not fit on screen.">?</span></div><input type="range" id="sizeSlider" min="200" max="800" value="800"><div class="slider-labels"><span>Smaller</span> <span>Larger</span></div></div><div class="control-group"><div class="control-label">Display Speed <span class="value-display" id="speedValue">6 FPS</span> <span class="tooltip" data-tooltip="Frames per second. Higher values transfer data faster, but may be harder to scan.">?</span></div><input type="range" id="speedSlider" min="1" max="30" value="6"><div class="slider-labels"><span>Slower</span> <span>Faster</span></div></div><div class="control-group"><div class="control-label">Chunk Size <span class="value-display" id="chunkValue">450 chars</span> <span class="tooltip" data-tooltip="Size of each data chunk. Larger chunks transfer faster but may be harder to scan.">?</span></div><input type="range" id="chunkSlider" min="100" max="1000" step="50" value="450"><div class="slider-labels"><span>Smaller chunks</span> <span>Larger chunks</span></div></div><div class="control-group"><div class="control-label">Redundancy <span class="value-display" id="redundancyValue">100%</span> <span class="tooltip" data-tooltip="Extra data to ensure successful transfer. Higher values improve reliability but increase transfer time.">?</span></div><input type="range" id="redundancySlider" min="20" max="200" step="10" value="100"><div class="slider-labels"><span>Less</span> <span>More</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">For 30% missed frames, use 60-70% redundancy<br>For 50% missed frames, use 100-120% redundancy</div></div><div class="control-group"><div class="control-label">Error Correction Level <span class="tooltip" data-tooltip="QR code error correction level. Higher levels are more reliable but create larger, more complex QR codes.">?</span></div><div style="display: flex; justify-content: space-between; margin-top: 5px;"><select id="errorCorrectionSelect" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #d1d5db;"><option value="H">High (30% recovery)</option><option value="M">Medium (15% recovery)</option><option value="L">Low (7% recovery)</option></select></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Higher correction = more reliable but larger QR codes</div></div><div class="control-group"><div class="control-label">Systematic Chunks per QR <span class="value-display" id="systematicChunksValue">2</span> <span class="tooltip" data-tooltip="Number of chunks to combine in systematic QR codes (reliable phase). 1=one chunk per QR, 2=two chunks per QR.">?</span></div><input type="range" id="systematicChunksSlider" min="1" max="4" step="1" value="2"><div class="slider-labels"><span>Single (1)</span> <span>Quad (4)</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Systematic phase: Recommend 1-2 for highest reliability</div></div><div class="control-group"><div class="control-label">Fountain Max Degree <span class="value-display" id="fountainDegreeValue">3</span> <span class="tooltip" data-tooltip="Maximum degree for fountain coding phase (redundancy). Higher values create more complex combinations but better error recovery.">?</span></div><input type="range" id="fountainDegreeSlider" min="2" max="20" step="1" value="3"><div class="slider-labels"><span>Simple (2)</span> <span>Complex (20)</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Fountain phase: Higher degrees improve recovery but need more processing</div></div><div class="control-group"><div class="control-label">Auto-Split Threshold <span class="value-display" id="splitThresholdValue">100KB</span> <span class="tooltip" data-tooltip="Files larger than this size will be automatically split into manageable parts for QR transmission.">?</span></div><input type="range" id="splitThresholdSlider" min="50" max="500" step="10" value="100"><div class="slider-labels"><span>50KB</span> <span>500KB</span></div><div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Large files split automatically for better QR transmission reliability</div></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="enableAutoSplitCheckbox" checked="checked"> <span class="switch-label">Enable Auto-Split for Large Files</span> <span class="tooltip" data-tooltip="Automatically splits large files into smaller parts for more reliable QR transmission.">?</span></label><div style="font-size: 12px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Recommended for files >100KB to improve transmission success rate</div></div><div class="control-group"><div class="control-label">Countdown Before Start <span class="value-display" id="countdownValue">10s</span> <span class="tooltip" data-tooltip="Time to prepare before QR codes start displaying.">?</span></div><input type="range" id="countdownSlider" min="0" max="30" value="10"><div class="slider-labels"><span>None</span> <span>30s</span></div></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="fullscreenCheckbox" checked="checked"> <span class="switch-label">Start in Fullscreen Mode (Recommended)</span></label></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="showGuidesCheckbox"> <span class="switch-label">Show Scanner Alignment Guides</span></label></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="enableTransitionsCheckbox" checked="checked"> <span class="switch-label">Enable Smooth Transitions</span> <span class="tooltip" data-tooltip="Enables subtle transitions between QR codes to improve scanning reliability.">?</span></label><div style="font-size: 12px; color: #6b7280; margin-top: 5px; margin-left: 24px;">Always on for best results; disable only for older devices</div></div><div class="control-group"><label class="control-switch"><input type="checkbox" id="highDensityCheckbox"> <span class="switch-label">High Density Mode</span> <span class="tooltip" data-tooltip="Increases QR code data capacity but requires enhanced scanner capabilities.">?</span></label><div style="font-size: 12px; color: #6b7280; margin-top: 5px; margin-left: 24px;">WARNING: Only enable if using the enhanced parallel processing decoder</div></div><div class="control-group"><button id="generateAndStartBtn" class="action-button" disabled="disabled">Generate & Start Display</button><div style="display: flex; gap: 10px; margin-top: 5px;"><button id="generateBtn" disabled="disabled">Generate QR Codes</button> <button id="stopBtn" disabled="disabled" style="flex: 1; background: #dc2626;">Stop</button></div><div style="display: flex; gap: 10px; margin-top: 5px;"><button id="startBtn" disabled="disabled" style="flex: 1;">Start Display</button> <button id="fullscreenBtn" disabled="disabled" style="flex: 1; background: #4b5563;">Fullscreen</button></div></div><div class="handshake-notice"><strong>Handshake Mode</strong>: The first frame contains special setup data that helps the decoder optimize for your specific transfer. Make sure to scan this frame.</div></div><div class="panel"><div class="display-container"><div id="frameCounter" style="margin-bottom: 10px; font-weight: bold;">Frame: 0 / 0</div><div id="qrDisplay" style="width: 800px; height: 800px; display: flex; align-items: center; justify-content: center;"><div class="alignment-guide" style="width: 90%; height: 90%; top: 5%; left: 5%;"></div><div class="alignment-guide" style="width: 70%; height: 70%; top: 15%; left: 15%;"></div><div class="guide-label" style="top: 2%; left: 50%; transform: translateX(-50%);">Keep QR code within this area</div><div style="color: #6b7280;">QR code will appear here</div><div id="countdownDisplay" class="countdown-display"></div></div><div class="progress-container"><div class="progress-bar" id="progressBar"></div></div></div><div id="fileInfo" class="file-info" style="display: none;"><h3 style="margin-bottom: 10px;">File Information</h3><div class="info-row"><div class="info-label">File Name:</div><div id="fileName">-</div></div><div class="info-row"><div class="info-label">File Size:</div><div id="fileSize">-</div></div><div class="info-row"><div class="info-label">Chunks:</div><div id="chunksCount">-</div></div><div class="info-row"><div class="info-label">Packets:</div><div id="packetsCount">-</div></div><div class="info-row"><div class="info-label">Redundancy Level:</div><div id="redundancyLevel">-</div></div><div class="info-row"><div class="info-label">Transfer Time:</div><div id="transferTime">-</div></div><div class="info-row"><div class="info-label">Optimal Distance:</div><div id="optimalDistance">-</div></div><div class="info-row high-density-indicator" style="display: none;"><div class="info-label" style="color: #b91c1c;">High Density Mode:</div><div style="color: #b91c1c; font-weight: bold;">Active</div></div></div><div id="metadataInfo" class="metadata-info" style="display: none;"><h3 style="margin-bottom: 10px;">Transmission Details</h3><div id="qrCodeInfo" style="margin-bottom: 10px;"><div style="font-weight: bold; color: #1e40af;">Current Frame Type:</div><div id="frameType">-</div></div><div id="currentChunkInfo" style="margin-bottom: 10px; display: none;"><div style="font-weight: bold; color: #1e40af;">Current Chunk:</div><div id="chunkId">-</div></div><div id="transmissionStats" style="margin-top: 10px;"><div style="font-weight: bold; color: #1e40af;">Transmission Stats:</div><div>Elapsed Time: <span id="elapsedTime">0s</span></div><div>Avg Speed: <span id="transmissionSpeed">-</span></div></div></div></div></div><div id="fullscreenDisplay" class="fullscreen" style="display: none;"><div class="qr-container"><img id="fullscreenQR" class="fullscreen-qr" src="" alt="QR Code"><div id="fsCountdownDisplay" class="countdown-display"></div></div><div class="fullscreen-counter" id="fullscreenCounter">Frame: 0 / 0</div><div class="fullscreen-progress progress-container"><div class="progress-bar" id="fullscreenProgressBar"></div></div><button class="exit-button" id="exitFullscreenBtn">&times;</button></div><script>const DEFAULT_QR_CONTENT_SIZE=3500,HIGH_DENSITY_QR_CONTENT_SIZE=5e3;let MAX_QR_CONTENT_SIZE=3500;const fileInput=document.getElementById("fileInput"),fileLabel=document.getElementById("fileLabel"),speedSlider=document.getElementById("speedSlider"),sizeSlider=document.getElementById("sizeSlider"),chunkSlider=document.getElementById("chunkSlider"),redundancySlider=document.getElementById("redundancySlider"),countdownSlider=document.getElementById("countdownSlider"),systematicChunksSlider=document.getElementById("systematicChunksSlider"),fountainDegreeSlider=document.getElementById("fountainDegreeSlider"),splitThresholdSlider=document.getElementById("splitThresholdSlider"),enableAutoSplitCheckbox=document.getElementById("enableAutoSplitCheckbox"),speedValue=document.getElementById("speedValue"),sizeValue=document.getElementById("sizeValue"),chunkValue=document.getElementById("chunkValue"),redundancyValue=document.getElementById("redundancyValue"),systematicChunksValue=document.getElementById("systematicChunksValue"),fountainDegreeValue=document.getElementById("fountainDegreeValue"),splitThresholdValue=document.getElementById("splitThresholdValue"),countdownValue=document.getElementById("countdownValue"),errorCorrectionSelect=document.getElementById("errorCorrectionSelect"),fullscreenCheckbox=document.getElementById("fullscreenCheckbox"),showGuidesCheckbox=document.getElementById("showGuidesCheckbox"),enableTransitionsCheckbox=document.getElementById("enableTransitionsCheckbox"),highDensityCheckbox=document.getElementById("highDensityCheckbox"),generateAndStartBtn=document.getElementById("generateAndStartBtn"),generateBtn=document.getElementById("generateBtn"),startBtn=document.getElementById("startBtn"),stopBtn=document.getElementById("stopBtn"),fullscreenBtn=document.getElementById("fullscreenBtn"),qrDisplay=document.getElementById("qrDisplay"),progressBar=document.getElementById("progressBar"),frameCounter=document.getElementById("frameCounter"),fileInfo=document.getElementById("fileInfo"),metadataInfo=document.getElementById("metadataInfo"),frameType=document.getElementById("frameType"),chunkId=document.getElementById("chunkId"),currentChunkInfo=document.getElementById("currentChunkInfo"),elapsedTime=document.getElementById("elapsedTime"),transmissionSpeed=document.getElementById("transmissionSpeed"),fileName=document.getElementById("fileName"),fileSize=document.getElementById("fileSize"),chunksCount=document.getElementById("chunksCount"),packetsCount=document.getElementById("packetsCount"),redundancyLevel=document.getElementById("redundancyLevel"),transferTime=document.getElementById("transferTime"),optimalDistance=document.getElementById("optimalDistance"),fullscreenDisplay=document.getElementById("fullscreenDisplay"),fullscreenQR=document.getElementById("fullscreenQR"),fullscreenCounter=document.getElementById("fullscreenCounter"),fullscreenProgressBar=document.getElementById("fullscreenProgressBar"),exitFullscreenBtn=document.getElementById("exitFullscreenBtn"),countdownDisplay=document.getElementById("countdownDisplay"),fsCountdownDisplay=document.getElementById("fsCountdownDisplay"),fastPreset=document.getElementById("fastPreset"),reliablePreset=document.getElementById("reliablePreset"),mobilePreset=document.getElementById("mobilePreset");let fileContent=null,fileNameText="",fileSizeBytes=0,chunks=[],fountainPackets=[],displayInterval=null,currentFrame=0,totalFrames=0,isPlaying=!1,isFullscreen=!1,qrSize=800,startTime=null,transmissionTimer=null,preGeneratedQRs=[],countdownTimer=null,countdownSeconds=10,wakeLock=null,debugMode=!1;function applyPreset(e){switch(fastPreset.classList.remove("active"),reliablePreset.classList.remove("active"),mobilePreset.classList.remove("active"),e){case"fast":fastPreset.classList.add("active"),speedSlider.value=12,chunkSlider.value=600,redundancySlider.value=50,systematicChunksSlider.value=2,fountainDegreeSlider.value=3,errorCorrectionSelect.value="M",enableTransitionsCheckbox.checked=!0;break;case"reliable":reliablePreset.classList.add("active"),speedSlider.value=6,chunkSlider.value=450,redundancySlider.value=100,systematicChunksSlider.value=2,fountainDegreeSlider.value=3,errorCorrectionSelect.value="H",sizeSlider.value=800,qrSize=800,qrDisplay.style.width=`${qrSize}px`,qrDisplay.style.height=`${qrSize}px`,sizeValue.textContent=`${qrSize}px`,enableTransitionsCheckbox.checked=!0;break;case"mobile":mobilePreset.classList.add("active"),speedSlider.value=8,chunkSlider.value=400,redundancySlider.value=100,systematicChunksSlider.value=1,fountainDegreeSlider.value=4,errorCorrectionSelect.value="H",sizeSlider.value=600,qrSize=600,qrDisplay.style.width=`${qrSize}px`,qrDisplay.style.height=`${qrSize}px`,sizeValue.textContent=`${qrSize}px`,enableTransitionsCheckbox.checked=!0}speedValue.textContent=`${speedSlider.value} FPS`,chunkValue.textContent=`${chunkSlider.value} chars`,redundancyValue.textContent=`${redundancySlider.value}%`,systematicChunksValue.textContent=systematicChunksSlider.value,fountainDegreeValue.textContent=fountainDegreeSlider.value}speedSlider.addEventListener("input",(()=>{const e=speedSlider.value;speedValue.textContent=`${e} FPS`})),sizeSlider.addEventListener("input",(()=>{qrSize=parseInt(sizeSlider.value),sizeValue.textContent=`${qrSize}px`,qrDisplay.style.width=`${qrSize}px`,qrDisplay.style.height=`${qrSize}px`})),chunkSlider.addEventListener("input",(()=>{const e=chunkSlider.value;chunkValue.textContent=`${e} chars`})),redundancySlider.addEventListener("input",(()=>{const e=redundancySlider.value;redundancyValue.textContent=`${e}%`})),countdownSlider.addEventListener("input",(()=>{countdownSeconds=parseInt(countdownSlider.value),countdownValue.textContent=countdownSeconds>0?`${countdownSeconds}s`:"None"})),systematicChunksSlider.addEventListener("input",(()=>{const e=systematicChunksSlider.value;systematicChunksValue.textContent=e})),fountainDegreeSlider.addEventListener("input",(()=>{const e=fountainDegreeSlider.value;fountainDegreeValue.textContent=e})),splitThresholdSlider.addEventListener("input",(()=>{const e=splitThresholdSlider.value;splitThresholdValue.textContent=`${e}KB`})),showGuidesCheckbox.addEventListener("change",(()=>{showGuidesCheckbox.checked?qrDisplay.classList.add("show-guides"):qrDisplay.classList.remove("show-guides")})),highDensityCheckbox.addEventListener("change",(()=>{highDensityCheckbox.checked?(MAX_QR_CONTENT_SIZE=5e3,document.querySelectorAll(".high-density-indicator").forEach((e=>{e.style.display="block"}))):(MAX_QR_CONTENT_SIZE=3500,document.querySelectorAll(".high-density-indicator").forEach((e=>{e.style.display="none"}))),chunks&&chunks.length>0&&(generateBtn.disabled=!1)})),fastPreset.addEventListener("click",(()=>{applyPreset("fast")})),reliablePreset.addEventListener("click",(()=>{applyPreset("reliable")})),mobilePreset.addEventListener("click",(()=>{applyPreset("mobile")}));let fileList=[],currentProcessingIndex=0;function calculateOptimalSettings(e){return{fps:6,chunkSize:450,redundancy:100,distance:"25-30cm",preset:"reliable"}}function updateFileLabel(){const e=fileList.filter((e=>e.selected)).length,t=fileList.length;fileLabel.textContent=0===t?"Choose files":1===t?fileList[0].name:`${e}/${t} files selected`}function updateFileListDisplay(){const e=document.getElementById("fileListContainer"),t=document.getElementById("fileList");0!==fileList.length?(e.style.display="block",t.innerHTML="",fileList.forEach(((e,n)=>{const a=document.createElement("div");a.className="file-item",a.innerHTML=`\n                    <input type="checkbox" class="file-checkbox" id="file-${e.id}" \n                           ${e.selected?"checked":""} \n                           onchange="toggleFileSelection(${e.id})">\n                    <div class="file-info">\n                        <div class="file-name">${e.name}</div>\n                        <div class="file-size">${formatFileSize(e.size)}</div>\n                    </div>\n                    <div class="file-status status-${e.status}">${e.status}</div>\n                `,t.appendChild(a)}))):e.style.display="none"}function toggleFileSelection(e){const t=fileList.find((t=>t.id===e));t&&(t.selected=!t.selected,updateFileLabel())}function updateFileStatus(e,t){const n=fileList.find((t=>t.id===e));n&&(n.status=t,updateFileListDisplay())}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}async function splitFileIntoParts(e,t){return new Promise(((n,a)=>{const s=new FileReader;s.onload=()=>{try{const a=s.result,r=new Uint8Array(a),l=[],o=Math.ceil(r.length/t);console.log(`✂️ ENTERPRISE: Splitting ${e.name} (${r.length} bytes) into ${o} parts of ~${formatFileSize(t)} each`);for(let n=0;n<o;n++){const a=n*t,s=Math.min(a+t,r.length),i=r.slice(a,s),c=e.name.split(".").pop(),d=`${e.name.replace(`.${c}`,"")}.part${n+1}-${o}.${c}`,u=new Blob([i],{type:e.type}),h=new File([u],d,{type:e.type});l.push(h),console.log(`📦 Created part ${n+1}/${o}: ${d} (${formatFileSize(i.length)})`)}n(l)}catch(e){a(e)}},s.onerror=a,s.readAsArrayBuffer(e)}))}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}async function processBatchFiles(e,t=!1){currentProcessingIndex=0,console.log(`📁 Starting COMBINED batch processing of ${e.length} files...`),console.log(`🎬 AutoStart mode: ${t} - will ${t?"display all QR codes automatically":"only generate codes"}`);const n=[];let a=0;for(let t=0;t<e.length;t++){const s=e[t];currentProcessingIndex=t;try{console.log(`📄 Processing file ${t+1}/${e.length}: ${s.name} (${s.size} bytes)`),updateFileStatus(s.id,"inprogress");if(enableAutoSplitCheckbox.checked&&s.size>1024*parseInt(splitThresholdSlider.value)){console.log(`✂️ ENTERPRISE: File ${s.name} (${formatFileSize(s.size)}) exceeds ${splitThresholdSlider.value}KB threshold - auto-splitting`);const e=await splitFileIntoParts(s.file,1024*parseInt(splitThresholdSlider.value));for(let t=0;t<e.length;t++){const s=e[t];console.log(`📦 Processing part ${t+1}/${e.length}: ${s.name}`);const r=await generateQRCodesForFileOnly(s);n.push(...r),a+=r.length,console.log(`📦 Added ${r.length} packets for ${s.name} (total: ${a})`)}console.log(`✅ ENTERPRISE: Completed auto-split processing for ${s.name} → ${e.length} parts`)}else{console.log(`📄 File ${s.name} (${formatFileSize(s.size)}) under ${splitThresholdSlider.value}KB threshold - processing as single file`);const e=await generateQRCodesForFileOnly(s.file);n.push(...e),a+=e.length,console.log(`📦 Added ${e.length} packets for ${s.name} (total: ${a})`)}updateFileStatus(s.id,"sent"),s.selected=!1,updateFileListDisplay(),updateFileLabel()}catch(n){if(console.error(`❌ Error processing file ${s.name}:`,n),updateFileStatus(s.id,"error"),t<e.length-1){if(!confirm(`Error processing ${s.name}. Continue with remaining files?`))break}}}console.log(`🎯 Combining all files into single QR sequence: ${a} total packets`),allPackets=n,fountainPackets=n,totalPackets=a,totalFrames=a,console.log(`🔧 Display variables set: totalPackets=${totalPackets}, totalFrames=${totalFrames}`),console.log(`🎨 Pre-generating all ${a} QR code images...`),await preGenerateAllQRCodes(),console.log("✅ All QR codes pre-generated and ready for display");e[0];const s=document.getElementById("fileInfo");s&&(document.getElementById("fileName").textContent=`Batch: ${e.length} files`,document.getElementById("fileSize").textContent="Combined transfer",document.getElementById("packetsCount").textContent=a,s.style.display="block"),console.log(`📁 Combined batch ready: ${a} QR codes for ${e.length} files`),t&&a>0?(console.log("🎬 Auto-starting combined QR display for all files..."),fullscreenCheckbox.checked?(enterFullscreenMode(),countdownSeconds>0?await startCountdownAndWait():await startPlayingAndWait()):countdownSeconds>0?await startCountdownAndWait():await startPlayingAndWait(),console.log("✅ Combined batch transmission complete!")):(startBtn.disabled=!1,fullscreenBtn.disabled=!1,console.log('💡 Click "Start Display" or "Fullscreen" to show combined QR sequence for all files'))}async function generateQRCodesForFileOnly(e){return new Promise(((t,n)=>{try{console.log(`🔧 Generating packets for ${e.name} (${e.size} bytes)`);const a=new FileReader;a.onload=async()=>{try{const n=a.result,s=new Uint8Array(n),r=parseInt(chunkSlider.value),l=[];for(let e=0;e<s.length;e+=r){const t=s.slice(e,e+r);l.push(t)}const o=new SystematicLTEncoder(l);o.systematicChunksPerQR=parseInt(systematicChunksSlider.value),o.fountainMaxDegree=parseInt(fountainDegreeSlider.value),o.currentFileName=e.name,o.currentFileSize=e.size,o.currentFileType=e.type;const i=[o.generateMetadataPacket()],c=o.calculateTotalPackets();for(let e=1;e<c;e++)i.push(o.generatePacket());console.log(`✅ Generated ${i.length} packets for ${e.name}`),t(i)}catch(e){n(e)}},a.onerror=n,a.readAsArrayBuffer(e)}catch(e){n(e)}}))}async function generateQRCodesForFile(e){return new Promise(((t,n)=>{try{console.log(`🔧 Starting QR generation for ${e.name} (${e.size} bytes)`);const a=new FileReader;a.onload=async()=>{try{console.log("📖 File read complete, processing..."),fileName.textContent=e.name;const n=a.result,s=new Uint8Array(n);console.log(`📦 File data loaded: ${s.length} bytes`),fileNameText=e.name,fileSizeBytes=e.size;const r=parseInt(chunkSlider.value),l=[];console.log(`✂️ Splitting into ${r} byte chunks...`);for(let e=0;e<s.length;e+=r){const t=s.slice(e,e+r);l.push(t)}console.log(`📊 Created ${l.length} chunks`),console.log("🏗️ Creating SystematicLTEncoder...");const o=new SystematicLTEncoder(l);o.systematicChunksPerQR=parseInt(systematicChunksSlider.value),o.fountainMaxDegree=parseInt(fountainDegreeSlider.value),o.currentFileName=e.name,o.currentFileSize=e.size,o.currentFileType=e.type,console.log(`⚙️ Encoder configured: systematic=${o.systematicChunksPerQR}, fountain=${o.fountainMaxDegree}`),console.log("📤 Generating metadata packet...");const i=[o.generateMetadataPacket()];console.log("🔢 Calculating total packets needed...");const c=o.calculateTotalPackets();console.log(`📊 Will generate ${c} total packets`);for(let e=1;e<c;e++){const t=o.generatePacket();i.push(t),e%50==0&&console.log(`📤 Generated ${e}/${c} packets...`)}console.log(`✅ Generated all ${i.length} packets`),allPackets=i,fountainPackets=i,totalPackets=allPackets.length,console.log(`🔧 Global arrays set: allPackets.length=${allPackets.length}, fountainPackets.length=${fountainPackets.length}`),console.log("📊 Updating packet info UI...");try{const t=document.getElementById("frameCounter"),n=document.getElementById("fileName"),a=document.getElementById("fileSize"),s=document.getElementById("chunksCount"),r=document.getElementById("packetsCount"),o=document.getElementById("redundancyLevel"),i=document.getElementById("transferTime");t&&(t.textContent=`Frame: 0 / ${fountainPackets.length}`),n&&(n.textContent=e.name),a&&(a.textContent=this.formatFileSize?this.formatFileSize(e.size):`${e.size} bytes`),s&&(s.textContent=l.length),r&&(r.textContent=fountainPackets.length),o&&(o.textContent=`${parseInt(redundancySlider.value)}%`),i&&(i.textContent=`~${Math.ceil(fountainPackets.length/parseInt(speedSlider.value))} seconds`);const c=document.getElementById("fileInfo");c&&(c.style.display="block"),console.log("✅ UI update completed")}catch(e){console.error("❌ Error updating UI:",e)}console.log(`🎯 QR generation complete for ${e.name}`),t()}catch(e){console.error("❌ Error in file processing:",e),console.error("❌ Error details:",e.message),console.error("❌ Error stack:",e.stack),n(e)}},a.onerror=e=>{console.error("❌ File reader error:",e),n(e)},console.log("📖 Reading file as ArrayBuffer..."),a.readAsArrayBuffer(e)}catch(e){console.error("❌ Error setting up file reader:",e),n(e)}}))}async function startPlayingAndWait(){return new Promise((e=>{startPlaying();const t=setInterval((()=>{displayInterval||isPlaying||(clearInterval(t),e())}),1e3)}))}async function startCountdownAndWait(){return new Promise((e=>{startCountdown();const t=setInterval((()=>{displayInterval||countdownTimer||isPlaying||(clearInterval(t),e())}),1e3)}))}function exitFullscreenMode(){const e=document.getElementById("fullscreenDisplay");e&&(e.style.display="none"),(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen())}function applyOptimalSettings(){if(!fileInput.files.length)return;const e=calculateOptimalSettings(fileSizeBytes);speedSlider.value=e.fps,speedValue.textContent=`${e.fps} FPS`,chunkSlider.value=e.chunkSize,chunkValue.textContent=`${e.chunkSize} chars`,redundancySlider.value=e.redundancy,redundancyValue.textContent=`${e.redundancy}%`,optimalDistance.textContent=e.distance,applyPreset(e.preset)}async function generateQRCodes(){if(!fileInput.files.length)return;const e=fileInput.files[0],t=parseInt(chunkSlider.value),n=parseInt(redundancySlider.value),a=await readFileAsBinary(e);fileContent=a,chunks=chunkFileBinary(fileContent,t),debugMode&&(console.log("🔍 ENCODER DEBUG - File reading:"),console.log(`  File size: ${a.length} bytes`),console.log(`  File type: ${a.constructor.name}`),console.log(`  File first 4 bytes: [${Array.from(a.slice(0,4)).join(", ")}]`),console.log(`  Chunk size: ${t} bytes`),console.log(`  Created ${chunks.length} chunks`),console.log(`  First chunk: ${chunks[0].length} bytes, type: ${chunks[0].constructor.name}`),console.log(`  First chunk first 4 bytes: [${Array.from(chunks[0].slice(0,4)).join(", ")}]`),console.log(`  Last chunk: ${chunks[chunks.length-1].length} bytes`));const s=new SystematicLTEncoder(chunks);s.systematicChunksPerQR=parseInt(systematicChunksSlider.value),s.fountainMaxDegree=parseInt(fountainDegreeSlider.value),s.currentFileName=fileNameText,s.currentFileSize=fileSizeBytes,s.currentFileType=fileInput.files[0]?fileInput.files[0].type:"",fountainPackets=[s.generateMetadataPacket()];const r=s.calculateTotalPackets();for(let e=1;e<r;e++)fountainPackets.push(s.generatePacket());if(chunks.length>0){const e=s.createSystematicPacket(0);e.p=s.packetCounter,fountainPackets.push(e)}const l=fountainPackets.filter((e=>!1===e.systematic&&void 0===e.metaString)).length,o=fountainPackets.filter((e=>!0===e.systematic)).length,i=Math.ceil(chunks.length*(n/100));if(l<i){const e=i-l;for(let t=0;t<e;t++)s.systematicPhase=!1,fountainPackets.push(s.createLTPacket())}totalFrames=fountainPackets.length,frameCounter.textContent=`Frame: 0 / ${totalFrames}`,fileName.textContent=fileNameText,fileSize.textContent=formatFileSize(fileSizeBytes),chunksCount.textContent=chunks.length,packetsCount.textContent=fountainPackets.length,redundancyLevel.textContent=`${n}% (${Math.round(100*(fountainPackets.length/chunks.length-1))}% effective)`,transferTime.textContent=`~${Math.ceil(totalFrames/parseInt(speedSlider.value))} seconds`,optimalDistance.textContent=calculateOptimalSettings(fileSizeBytes).distance;const c=o,d=l+(fountainPackets.length-c-l-1);if(document.getElementById("phaseInfo"))document.getElementById("phaseDetails").innerHTML=`\n                    <div>Systematic: ${c} packets</div>\n                    <div>Fountain: ${d} packets</div>\n                `;else{const e=document.createElement("div");e.id="phaseInfo",e.className="info-row",e.innerHTML=`\n                    <div class="info-label">Encoding Phases:</div>\n                    <div id="phaseDetails">\n                        <div>Systematic: ${c} packets</div>\n                        <div>Fountain: ${d} packets</div>\n                    </div>\n                `,document.getElementById("fileInfo").appendChild(e)}if(!document.getElementById("ltParams")&&fountainPackets.length>0){const e=document.createElement("div");e.id="ltParams",e.className="info-row",e.innerHTML=`\n                    <div class="info-label">LT Parameters:</div>\n                    <div id="ltDetails">\n                        <div>c: ${s.c.toFixed(2)}</div>\n                        <div>δ: ${s.delta.toFixed(2)}</div>\n                    </div>\n                `,document.getElementById("fileInfo").appendChild(e)}return fileInfo.style.display="block",preGeneratedQRs.length>0&&(displayPreGeneratedQR(0,isFullscreen),currentFrame=0),!0}async function startCountdown(){let e=countdownSeconds;console.log("⏰ Starting countdown with first QR code visible for camera alignment"),preGeneratedQRs.length>0&&(displayPreGeneratedQR(0,isFullscreen),console.log("📋 First QR code (metadata) displayed during countdown for camera alignment")),countdownDisplay.textContent=e,countdownDisplay.style.display="block",fsCountdownDisplay.textContent=e,fsCountdownDisplay.style.display=isFullscreen?"block":"none",null===qrDisplay.querySelector(".countdown-display")&&qrDisplay.appendChild(countdownDisplay),startBtn.disabled=!0,countdownTimer=setInterval((()=>{e--,e<=0?(clearInterval(countdownTimer),countdownDisplay.style.display="none",fsCountdownDisplay.style.display="none",console.log("⏰ Countdown finished - keeping first metadata QR for additional 3 seconds"),setTimeout((()=>{console.log("📋 Additional 3-second metadata display complete - starting sequence from frame 1"),currentFrame=1,startPlayingFromCurrentFrame()}),3e3)):(countdownDisplay.textContent=e,fsCountdownDisplay.textContent=e)}),1e3)}async function requestWakeLock(){try{"wakeLock"in navigator&&(wakeLock=await navigator.wakeLock.request("screen"),console.log("Screen wake lock activated"),wakeLock.addEventListener("release",(()=>{console.log("Screen wake lock released")})))}catch(e){console.log("Wake lock failed:",e.message)}}function releaseWakeLock(){wakeLock&&(wakeLock.release(),wakeLock=null,console.log("Screen wake lock released manually"))}function startPlaying(){console.log("🎬 startPlaying() called - beginning QR display"),console.log(`📊 Total packets available: ${totalPackets}`),console.log(`📊 Fountain packets array length: ${fountainPackets.length}`),isPlaying=!0,startBtn.disabled=!0,stopBtn.disabled=!1,currentFrame=0,requestWakeLock(),startTime=Date.now(),metadataInfo.style.display="block",transmissionTimer=setInterval(updateTransmissionStats,1e3);const e=1e3/parseInt(speedSlider.value);let t=e;const n=async()=>{displayPreGeneratedQR(currentFrame,isFullscreen);const a=fountainPackets[currentFrame];0===currentFrame||a&&a.metaString?(t=Math.max(3*e,3e3),console.log(`📋 Metadata QR displayed for ${t}ms (3x longer)`)):t=e,totalFrames>0?(currentFrame=(currentFrame+1)%totalFrames,console.log(`📍 Frame updated: ${currentFrame}/${totalFrames}`),displayInterval=setTimeout(n,t)):console.error(`❌ totalFrames is ${totalFrames}, stopping display`)};n()}async function preGenerateAllQRCodes(){if(console.log("🏭 ENTERPRISE: Starting pre-generation with full error handling and validation"),preGeneratedQRs=[],!fountainPackets||0===fountainPackets.length)throw new Error("ENTERPRISE ERROR: No fountain packets available for QR generation");if(!errorCorrectionSelect||!errorCorrectionSelect.value)throw new Error("ENTERPRISE ERROR: Error correction level not set");let e=0,t=0;const n=performance.now();for(let n=0;n<fountainPackets.length;n++){const a=fountainPackets[n];try{if(!a)throw new Error(`Packet ${n} is null or undefined`);let t;if(a.metaString){if(t=a.metaString,"string"!=typeof t||0===t.length)throw new Error(`Invalid metadata string in packet ${n}`)}else{if(!a.dataString)throw new Error(`Packet ${n} has no valid data (no metaString or dataString)`);if(t=a.dataString,"string"!=typeof t||0===t.length)throw new Error(`Invalid data string in packet ${n}`)}t.length>4e3&&console.warn(`⚠️ ENTERPRISE WARNING: Frame ${n} data length ${t.length} may exceed QR capacity`);const s=await new Promise(((e,a)=>{const s=setTimeout((()=>{a(new Error(`QR generation timeout for frame ${n} after 5 seconds`))}),5e3);QRCode.toDataURL(t,{errorCorrectionLevel:errorCorrectionSelect.value,width:qrSize,margin:2,color:{dark:"#333333",light:"#FFFFFF"}},((t,r)=>{clearTimeout(s),t?a(new Error(`QRCode.toDataURL failed for frame ${n}: ${t.message}`)):r&&"string"==typeof r?e(r):a(new Error(`Invalid QR data URL returned for frame ${n}`))}))}));if(preGeneratedQRs[n]=s,e++,(n+1)%10==0||0===n||a.metaString){const e=a.metaString?"METADATA":"DATA";console.log(`🎨 ENTERPRISE: Pre-generated QR ${n+1}/${fountainPackets.length} (${e}) - Data length: ${t.length}`)}}catch(e){t++,console.error(`❌ ENTERPRISE ERROR: Frame ${n} generation failed:`,e.message),console.error(`❌ ENTERPRISE CONTEXT: Packet type=${a.metaString?"metadata":a.dataString?"data":"unknown"}, qrSize=${qrSize}, errorLevel=${errorCorrectionSelect.value}`);try{const e=await new Promise(((e,t)=>{QRCode.toDataURL(`ENTERPRISE_ERROR_FRAME_${n}`,{errorCorrectionLevel:"M",width:qrSize,color:{dark:"#FF0000",light:"#FFFFFF"}},((n,a)=>{n?t(n):e(a)}))}));preGeneratedQRs[n]=e,console.log(`🔧 ENTERPRISE RECOVERY: Created error QR for frame ${n}`)}catch(e){console.error(`❌ ENTERPRISE CRITICAL: Even fallback QR failed for frame ${n}:`,e),preGeneratedQRs[n]=null}}}const a=performance.now()-n;if(console.log(`✅ ENTERPRISE: Pre-generation complete in ${a.toFixed(0)}ms`),console.log(`📊 ENTERPRISE STATS: ${e} success, ${t} errors, ${preGeneratedQRs.filter((e=>null!==e)).length} total usable QRs`),0===e)throw new Error("ENTERPRISE CRITICAL: No QR codes could be generated");t>.1*e&&console.warn(`⚠️ ENTERPRISE WARNING: High error rate ${t}/${fountainPackets.length} (${(t/fountainPackets.length*100).toFixed(1)}%)`)}function displayPreGeneratedQR(e,t=!1){try{if("number"!=typeof e||e<0)throw new Error(`Invalid frame index: ${e}`);if(e>=preGeneratedQRs.length)throw new Error(`Frame index ${e} exceeds pre-generated array length ${preGeneratedQRs.length}`);const n=preGeneratedQRs[e];if(!n)throw new Error(`No pre-generated QR data for frame ${e}`);if("string"!=typeof n||!n.startsWith("data:image/"))throw new Error(`Invalid QR data URL format for frame ${e}`);if(console.log(`📱 ENTERPRISE: Displaying pre-generated QR for frame ${e}`),t){if(!fullscreenQR)throw new Error("Fullscreen QR element not found");fullscreenQR.src=n,fullscreenQR.onerror=()=>{console.error(`❌ ENTERPRISE ERROR: Failed to load QR image for frame ${e} in fullscreen`)}}else{if(!qrDisplay)throw new Error("QR display element not found");qrDisplay.innerHTML=`<img src="${n}" alt="QR Code" style="max-width: 100%; max-height: 100%;" onerror="console.error('QR image load failed for frame ${e}')">`}try{frameCounter&&(frameCounter.textContent=`Frame: ${e+1} / ${totalFrames}`);try{updateFrameMetadata(e)}catch(t){console.warn(`⚠️ ENTERPRISE WARNING: Frame metadata update failed for frame ${e}:`,t.message)}const t=(e+1)/totalFrames*100;progressBar&&(progressBar.style.width=`${t}%`),fullscreenProgressBar&&(fullscreenProgressBar.style.width=`${t}%`)}catch(t){console.warn(`⚠️ ENTERPRISE WARNING: UI update failed for frame ${e}:`,t.message)}}catch(n){console.error(`❌ ENTERPRISE ERROR: Display failed for frame ${e}:`,n.message),console.error(`❌ ENTERPRISE CONTEXT: forFullscreen=${t}, totalFrames=${totalFrames}, preGeneratedQRs.length=${preGeneratedQRs.length}`),console.log("🔧 ENTERPRISE RECOVERY: Attempting to continue to next frame")}}function startPlayingFromCurrentFrame(){console.log(`🎬 Starting QR sequence from frame ${currentFrame}`),isPlaying=!0,startBtn.disabled=!0,stopBtn.disabled=!1;const e=1e3/parseInt(speedSlider.value),t=async()=>{displayPreGeneratedQR(currentFrame,isFullscreen);const n=fountainPackets[currentFrame];let a;n&&n.metaString?(a=Math.max(3*e,3e3),console.log(`📋 Metadata QR displayed for ${a}ms (3x longer)`)):a=e,totalFrames>0?(currentFrame=(currentFrame+1)%totalFrames,console.log(`📍 Frame updated: ${currentFrame}/${totalFrames}`),displayInterval=setTimeout(t,a)):console.error(`❌ totalFrames is ${totalFrames}, stopping display`)};t()}function stopPlaying(){countdownTimer&&(clearInterval(countdownTimer),countdownTimer=null,countdownDisplay.style.display="none",isFullscreen&&(fsCountdownDisplay.style.display="none")),displayInterval&&(clearTimeout(displayInterval),displayInterval=null),transmissionTimer&&(clearInterval(transmissionTimer),transmissionTimer=null),releaseWakeLock(),isPlaying=!1,startBtn.disabled=!1,stopBtn.disabled=!0}function enterFullscreenMode(){isFullscreen=!0,fullscreenDisplay.style.display="flex",isPlaying&&stopPlaying(),setTimeout((()=>{currentFrame>=0&&preGeneratedQRs.length>0&&displayPreGeneratedQR(currentFrame,!0)}),100)}function updateTransmissionStats(){if(!isPlaying||!startTime)return;const e=(Date.now()-startTime)/1e3,t=formatTime(e);elapsedTime.textContent=t;const n=fileSizeBytes*Math.min(currentFrame/totalFrames,1)/e;transmissionSpeed.textContent=`${formatFileSize(n)}/s`}function formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}function calculateFullscreenQRSize(){const e=window.innerWidth-80,t=window.innerHeight-80-100,n=Math.min(e,t);return Math.floor(.9*n)}async function generateQRCodeForFrame(e,t=!1){try{if(console.log(`🎯 Generating QR for frame ${e} (fullscreen: ${t})`),!fountainPackets[e])return void console.error(`❌ No packet found for frame ${e}`);const n=fountainPackets[e];let a;console.log("📦 Packet type: "+(n.metaString?"metadata":"data")),0===e&&n.metaString?a=n.metaString:n.dataString&&(a=n.dataString);const s={errorCorrectionLevel:errorCorrectionSelect.value,margin:1,width:t?calculateFullscreenQRSize():qrSize,color:{dark:"#000000",light:"#FFFFFF"}},r=await new Promise(((e,t)=>{QRCode.toDataURL(a,s,((n,a)=>{n?t(n):e(a)}))}));if((t||isFullscreen)&&(fullscreenQR.src=r,fullscreenCounter.textContent=`Frame: ${e+1} / ${totalFrames}`,enableTransitionsCheckbox.checked&&fullscreenQR.classList.add("qr-image"),"block"===countdownDisplay.style.display?(fsCountdownDisplay.style.display="block",fsCountdownDisplay.textContent=countdownDisplay.textContent):fsCountdownDisplay.style.display="none"),qrDisplay.innerHTML=`<img src="${r}" alt="QR Code" style="max-width: 100%; max-height: 100%;">`,enableTransitionsCheckbox.checked){const e=qrDisplay.querySelector("img");e&&e.classList.add("qr-image")}if(showGuidesCheckbox.checked){const e=document.createElement("div");e.className="alignment-guide",e.style="width: 90%; height: 90%; top: 5%; left: 5%;";const t=document.createElement("div");t.className="alignment-guide",t.style="width: 70%; height: 70%; top: 15%; left: 15%;";const n=document.createElement("div");n.className="guide-label",n.style="top: 2%; left: 50%; transform: translateX(-50%);",n.textContent="Keep QR code within this area",qrDisplay.appendChild(e),qrDisplay.appendChild(t),qrDisplay.appendChild(n),showGuidesCheckbox.checked&&qrDisplay.classList.add("show-guides")}"block"===countdownDisplay.style.display&&qrDisplay.appendChild(countdownDisplay),frameCounter.textContent=`Frame: ${e+1} / ${totalFrames}`,updateFrameMetadata(e);const l=(e+1)/totalFrames*100;progressBar.style.width=`${l}%`,fullscreenProgressBar.style.width=`${l}%`}catch(n){console.error(`Error generating QR code for frame ${e}:`,n),console.error(`Packet data length: ${packetData?packetData.length:"null"}`),console.error("Packet type: "+(packet.metaString?"metadata":"data"));try{const n=await new Promise(((t,n)=>{QRCode.toDataURL(`ERROR: Frame ${e} failed to generate`,{errorCorrectionLevel:"M",width:400,color:{dark:"#FF0000",light:"#FFFFFF"}},((e,a)=>{e?n(e):t(a)}))}));t&&fullscreenQR?fullscreenQR.src=n:qrDisplay&&(qrDisplay.innerHTML=`<img src="${n}" alt="Error QR Code" style="max-width: 100%; max-height: 100%;">`),console.log(`⚠️ Displayed error QR for frame ${e}`)}catch(e){console.error("Even error QR generation failed:",e)}}}function updateFrameMetadata(e){try{const t=fountainPackets[e];if(!t)return void console.warn(`⚠️ ENTERPRISE: No packet found for frame ${e} metadata update`);let n,a="";if(t.metaString){n=0===e?"Handshake (Setup Data)":"File Metadata",currentChunkInfo&&(currentChunkInfo.style.display="none");const s=t.metaString.length;a=` (${s} bytes)`,console.log(`📋 ENTERPRISE: Frame ${e} is metadata packet (${s} bytes)`)}else{if(!t.dataString)throw new Error(`Frame ${e} packet has no valid data (no metaString or dataString)`);{if("string"!=typeof t.dataString)throw new Error(`Invalid dataString type for frame ${e}: ${typeof t.dataString}`);const s=t.dataString.split(":");if(!(s.length>=6))throw new Error(`Invalid dataString format for frame ${e}: insufficient parts (${s.length})`);{const e=s[1],r=s[5];n=`Data Packet (Degree: ${r})`,currentChunkInfo&&(currentChunkInfo.style.display="block"),chunkId&&(chunkId.textContent=`${e} (contains ${r} chunk${r>1?"s":""})`),a=` (${t.dataString.length} bytes)`}}}frameType?frameType.textContent=n+a:console.warn(`⚠️ ENTERPRISE: frameType element not found for frame ${e}`)}catch(t){console.error(`❌ ENTERPRISE ERROR: updateFrameMetadata failed for frame ${e}:`,t.message),console.error("❌ ENTERPRISE CONTEXT: packet structure:",{hasMetaString:!!fountainPackets[e]?.metaString,hasDataString:!!fountainPackets[e]?.dataString,packetKeys:fountainPackets[e]?Object.keys(fountainPackets[e]):"null"});try{frameType&&(frameType.textContent=`Frame ${e+1} (metadata parsing failed)`)}catch(e){console.error("❌ ENTERPRISE CRITICAL: Even fallback frame type update failed:",e)}}}function updateProgress(){const e=(currentFrame+1)/totalFrames*100;progressBar.style.width=`${e}%`,isFullscreen&&(fullscreenProgressBar.style.width=`${e}%`)}function readFileAsBinary(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=()=>{const e=a.result;t(new Uint8Array(e))},a.onerror=n,a.readAsArrayBuffer(e)}))}function chunkFileBinary(e,t){const n=[];for(let a=0;a<e.length;a+=t){const s=e.slice(a,a+t);n.push(s)}return n}function readFileAsBase64(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=n,a.readAsDataURL(e)}))}function chunkFile(e,t){const n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}function formatFileSize(e){return e<1024?e+" bytes":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}fileInput.addEventListener("change",(()=>{fileInput.files.length>0&&(fileList=[],Array.from(fileInput.files).forEach(((e,t)=>{fileList.push({id:Date.now()+t,file:e,name:e.name,size:e.size,selected:!0,status:"pending"})})),updateFileListDisplay(),updateFileLabel(),generateBtn.disabled=!1,generateAndStartBtn.disabled=!1,displayInterval&&(clearInterval(displayInterval),displayInterval=null),isPlaying=!1,startBtn.disabled=!0,stopBtn.disabled=!0,fullscreenBtn.disabled=!0,applyOptimalSettings())})),document.getElementById("selectAllBtn").addEventListener("click",(()=>{fileList.forEach((e=>e.selected=!0)),updateFileListDisplay(),updateFileLabel()})),document.getElementById("clearAllBtn").addEventListener("click",(()=>{fileList.forEach((e=>e.selected=!1)),updateFileListDisplay(),updateFileLabel()})),generateAndStartBtn.addEventListener("click",(async()=>{const e=fileList.filter((e=>e.selected));if(0!==e.length){generateAndStartBtn.disabled=!0,generateAndStartBtn.textContent="Processing Batch...";try{await processBatchFiles(e,!0)}catch(e){alert("Error during batch processing: "+e.message)}finally{generateAndStartBtn.textContent="Generate & Start Display",generateAndStartBtn.disabled=!1}}else alert("Please select at least one file to process")})),generateBtn.addEventListener("click",(async()=>{const e=fileList.filter((e=>e.selected));if(0!==e.length){generateBtn.disabled=!0,generateBtn.textContent="Generating Batch...";try{await processBatchFiles(e,!1),startBtn.disabled=!1,fullscreenBtn.disabled=!1}catch(e){alert("Error generating QR codes: "+e.message)}finally{generateBtn.textContent="Generate QR Codes",generateBtn.disabled=!1}}else alert("Please select at least one file to generate QR codes")})),startBtn.addEventListener("click",(()=>{0!==fountainPackets.length&&(countdownSeconds>0?startCountdown():startPlaying())})),stopBtn.addEventListener("click",(()=>{stopPlaying()})),fullscreenBtn.addEventListener("click",(()=>{enterFullscreenMode(),countdownSeconds>0?startCountdown():startPlaying()})),exitFullscreenBtn.addEventListener("click",(()=>{isFullscreen=!1,fullscreenDisplay.style.display="none",stopPlaying()})),window.addEventListener("resize",(()=>{isFullscreen&&currentFrame>=0&&preGeneratedQRs.length>0&&setTimeout((()=>{displayPreGeneratedQR(currentFrame,!0)}),100)}));class SystematicLTEncoder{constructor(e,t=Date.now()){this.originalChunks=e,this.numChunks=e.length,this.seedBase=t,this.packetCounter=0,this.avgChunkSize=this.calculateAverageChunkSize(),this.systematicPhase=!0,this.currentSystematicIndex=0,this.systematicChunksPerQR=2,this.fountainMaxDegree=3,this.c=.03,this.delta=.5}calculateAverageChunkSize(){let e=0;const t=Math.min(10,this.numChunks);for(let n=0;n<t;n++)e+=this.originalChunks[n].length;return Math.ceil(e/t)}calculateTotalPackets(){let e;e=this.systematicChunksPerQR>=2?Math.ceil(this.numChunks/this.systematicChunksPerQR):this.numChunks;const t=parseInt(document.getElementById("redundancySlider").value)/100;return e+Math.ceil(this.numChunks*t)+(this.systematicChunksPerQR>=2?Math.ceil(.1*this.numChunks):0)}generatePacket(){if(this.systematicPhase){document.getElementById("highDensityCheckbox").checked;if(this.systematicChunksPerQR>=2&&this.currentSystematicIndex<this.numChunks&&this.numChunks-1-this.currentSystematicIndex>=0){const e=this.createDualSystematicPacket(this.currentSystematicIndex,this.numChunks-1-this.currentSystematicIndex);return this.currentSystematicIndex++,this.currentSystematicIndex>=this.numChunks&&(this.systematicPhase=!1),e}{const e=this.createSystematicPacket(this.currentSystematicIndex);return this.currentSystematicIndex++,this.currentSystematicIndex>=this.numChunks&&(this.systematicPhase=!1),e}}return this.createLTPacket()}createSystematicPacket(e){const t=this.originalChunks[e],n=this.seedBase+this.packetCounter,a=this.arrayBufferToBase64(t),s=`${e}:${a}`,r=`D:${this.packetCounter}:${n}:${this.seedBase}:${this.numChunks}:1:${s}`;debugMode&&(console.log(`🔍 ENCODER DEBUG - Single systematic packet ${this.packetCounter}:`),console.log(`  Chunk ${e}: ${t.length} bytes`),console.log(`  Chunk type: ${t.constructor.name}`),console.log(`  First 4 bytes: [${Array.from(t.slice(0,4)).join(", ")}]`),console.log(`  Base64 length: ${a.length} chars`),console.log(`  Base64 preview: ${a.substring(0,20)}...`),console.log(`  Base64 valid: ${/^[A-Za-z0-9+/]*={0,2}$/.test(a)}`),console.log(`  Combined data length: ${s.length} chars`),console.log(`  Combined preview: ${s.substring(0,30)}...`),console.log(`  Final packet length: ${r.length} chars`),console.log(`  Final packet preview: ${r.substring(0,80)}...`));const l={format:"compact",dataString:r,s:n,d:1,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!0};return this.checkAndHandlePacketSize(l),l}createDualSystematicPacket(e,t){const n=this.originalChunks[e],a=this.originalChunks[t];debugMode&&(console.log(`🔍 ENCODER DEBUG - Dual systematic packet ${this.packetCounter}:`),console.log(`  Chunk ${e}: ${n.length} bytes, type: ${n.constructor.name}`),console.log(`  Chunk ${t}: ${a.length} bytes, type: ${a.constructor.name}`),console.log(`  First chunk first 4 bytes: [${Array.from(n.slice(0,4)).join(", ")}]`),console.log(`  Second chunk first 4 bytes: [${Array.from(a.slice(0,4)).join(", ")}]`));const s=this.seedBase+this.packetCounter,r=this.arrayBufferToBase64(n),l=this.arrayBufferToBase64(a),o=`${e}:${r}|${t}:${l}`,i=`D:${this.packetCounter}:${s}:${this.seedBase}:${this.numChunks}:2:${o}`;debugMode&&(console.log(`  First base64: ${r.length} chars, preview: ${r.substring(0,20)}...`),console.log(`  First base64 valid: ${/^[A-Za-z0-9+/]*={0,2}$/.test(r)}`),console.log(`  Second base64: ${l.length} chars, preview: ${l.substring(0,20)}...`),console.log(`  Second base64 valid: ${/^[A-Za-z0-9+/]*={0,2}$/.test(l)}`),console.log(`  Combined data length: ${o.length} chars`),console.log(`  Combined preview: ${o.substring(0,50)}...`),console.log(`  Contains invalid chars: ${/[^A-Za-z0-9+/=:|]/.test(o)}`),console.log(`  Final packet length: ${i.length} chars`),console.log(`  Final packet preview: ${i.substring(0,100)}...`));const c={format:"compact",dataString:i,s:s,d:2,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!0};return this.checkAndHandlePacketSize(c),c}createLTPacket(){const e=this.seedBase+this.packetCounter,t=this.createPRNG(e),n=this.getRobustSolitonDegree(t),a=this.selectChunksLT(n,t),s=this.xorChunks(a),r=a.join(","),l=this.arrayBufferToBase64(s),o={format:"enhanced",dataString:`D:${this.packetCounter}:${e}:${this.seedBase}:${this.numChunks}:1:${r}:${l}`,s:e,d:n,p:this.packetCounter++,n:this.numChunks,b:this.seedBase,systematic:!1,sourceIndices:a,fountainData:s};return this.checkAndHandlePacketSize(o),o}checkAndHandlePacketSize(e){const t=document.getElementById("highDensityCheckbox").checked?5e3:3500;e.dataString.length>.9*t&&this.truncatePacket(e,.9*t)}truncatePacket(e,t){const n=e.dataString.split(":",6).slice(0,6).join(":"),a=n.length+1,s=t-a,r=e.dataString.substring(a),l=r.length,o=r.substring(0,s);e.dataString=`${n}:${o}`,e.truncated=!0,e.dataString=`${e.dataString}:t:${l}`}createPRNG(e){let t=e;return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}}getRobustSolitonDegree(e){if(this.numChunks<=1)return 1;const t=this.c,n=this.delta,a=t*Math.log(this.numChunks/n)*Math.sqrt(this.numChunks),s=Math.min(this.fountainMaxDegree,this.numChunks),r=e();let l=0;if(l+=1/this.numChunks+a/this.numChunks,r<l)return 1;for(let e=2;e<=s;e++){let t=1/(e*(e-1)),s=0;if(e<=Math.floor(this.numChunks/a)?s=a/(e*this.numChunks):e===Math.floor(this.numChunks/a)&&(s=a*Math.log(a/n)/this.numChunks),l+=t+s,r<l)return e}return s}selectChunksLT(e,t){const n=[],a=Math.min(e,this.numChunks);for(;n.length<a;){const e=Math.floor(t()*this.numChunks);n.includes(e)||n.push(e)}return n}combineChunks(e){if(0===e.length)return"";const t=e.map((e=>`${e}:${this.originalChunks[e]}`)).join("|");this.xorChunks(e);return t}xorChunks(e){if(0===e.length)return new Uint8Array(0);const t=this.ensureUint8Array(this.originalChunks[e[0]]);if(1===e.length)return t;let n=t.length;for(let t=1;t<e.length;t++){const a=this.ensureUint8Array(this.originalChunks[e[t]]);n=Math.max(n,a.length)}const a=new Uint8Array(n);a.set(t);for(let t=1;t<e.length;t++){const n=e[t],s=this.ensureUint8Array(this.originalChunks[n]);for(let e=0;e<Math.min(a.length,s.length);e++)a[e]^=s[e]}return a}stringToUint8Array(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}ensureUint8Array(e){return e instanceof Uint8Array?e:"string"==typeof e?this.stringToUint8Array(e):new Uint8Array(e)}arrayBufferToBase64(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return btoa(t)}generateMetadataPacket(){const e=this.currentFileName||document.getElementById("fileName").textContent,t=this.currentFileSize||(fileInput.files[0]?fileInput.files[0].size:0),n=this.currentFileType||(fileInput.files[0]?fileInput.files[0].type:""),a=parseInt(document.getElementById("speedSlider").value),s=parseInt(document.getElementById("systematicChunksSlider").value),r=parseInt(document.getElementById("fountainDegreeSlider").value),l=parseInt(document.getElementById("chunkSlider").value),o=parseInt(document.getElementById("redundancySlider").value),i=document.getElementById("highDensityCheckbox").checked?1:0,c=document.getElementById("errorCorrectionSelect").value,d=this.calculateFileChecksumFromChunks(this.originalChunks),u=`${e}:${t}:${this.numChunks}`,h=this.simpleChecksum(u),m=`${this.c}:${this.delta}`,g=`M:3.0:${encodeURIComponent(e)}:${encodeURIComponent(n)}:${t}:${this.numChunks}:${this.calculateTotalPackets()}:${s}:${i}:${a}:${l}:${o}:${c}:${h}:${d}:${m}:${r}`;console.log("📋 METADATA DEBUG:"),console.log(`  fileName: "${e}"`),console.log(`  fileType: "${n}"`),console.log(`  fileSize: ${t}`),console.log(`  metadata string: ${g.substring(0,100)}...`);return{format:"compact",metaString:g,s:this.seedBase,p:this.packetCounter++,n:this.numChunks,b:this.seedBase}}calculateFileChecksum(e){if(!e)return console.warn("calculateFileChecksum: binaryData is null, returning default"),"nullchk";let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e[n],t|=0;return Math.abs(t).toString(36).substring(0,8)}calculateFileChecksumFromChunks(e){if(!e||0===e.length)return console.warn("calculateFileChecksumFromChunks: chunks is null/empty, returning default"),"nochunk";let t=0;for(const n of e)for(let e=0;e<n.length;e++)t=(t<<5)-t+n[e],t|=0;return Math.abs(t).toString(36).substring(0,8)}simpleChecksum(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36).substring(0,6)}}</script></body></html>