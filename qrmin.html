<html><head><meta charset="UTF-8"><title>QR Scan</title><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;font-family:sans-serif}#c{display:none}#l{background:black;color:lime;overflow-y:auto;white-space:pre;font-family:monospace;margin-top:5px;padding:5px;flex:1}#g{display:grid;gap:2px;flex:0 0 30%}#g div{background:darkred;aspect-ratio:3/4;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:1.5vh;color:#fff}#g .r{background:green}#g .b{background:yellow!important;color:black}#v{width:100%;height:auto;display:none;background:black}#r{position:absolute;border:2px solid red;width:80px;height:80px;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}</style></head><body><div style="display:flex;width:100%;height:100%"><div style="width:60%;display:flex;flex-direction:column;align-items:center;background:#222;position:relative;padding:5px"><div><button id="b1">Start</button><button id="b2" disabled>Stop</button></div><video id="v"></video><div id="r"></div></div><div style="width:40%;display:flex;flex-direction:column;padding:5px;background:#f0f0f0"><div id="g"></div><div id="l"></div></div></div><canvas id="c"></canvas><script>let v=document.getElementById('v'),c=document.getElementById('c'),x=c.getContext('2d'),lDiv=document.getElementById('l'),b1=document.getElementById('b1'),b2=document.getElementById('b2'),gDiv=document.getElementById('g'),s=null,scan=0,g,e,f=[],q,t,n,o,h=[],z=[];const log=m=>{z.push(m);lDiv.textContent=z.join('\n');lDiv.scrollTop=lDiv.scrollHeight},reset=_=>{g=0;e=0;f=[];h=[];q=null;t=0;n='';o=0;z=[];lDiv.textContent='';scan=0;b2.disabled=1;b1.disabled=0;v.style.display='none';gDiv.innerHTML=''},stopCam=_=>{if(s){s.getTracks().forEach(t=>t.stop());s=null}log('Stopped');reset()},updGrid=_=>{gDiv.innerHTML='';let col=Math.ceil(Math.sqrt(e*4/3));gDiv.style.gridTemplateColumns=`repeat(${col},1fr)`;for(let i=0;i<e;i++){let d=document.createElement('div');d.textContent=i+1;if(h[i])d.className='r';gDiv.appendChild(d)}},blink=i=>{let d=gDiv.children;if(d[i]){d[i].classList.add('b');setTimeout(()=>{d[i].classList.remove('b');if(h[i])d[i].classList.add('r')},300)}},start=async()=>{try{s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});v.srcObject=s;v.setAttribute('playsinline',1);v.play();v.style.display='block';scan=1;b1.disabled=1;b2.disabled=0;log('Started');requestAnimationFrame(loop)}catch(e){log(e)}},loop=_=>{if(!scan)return;if(v.readyState===v.HAVE_ENOUGH_DATA){c.width=v.videoWidth;c.height=v.videoHeight;x.drawImage(v,0,0);try{let qr=jsQR(x.getImageData(0,0,c.width,c.height).data,c.width,c.height,{inversionAttempts:"dontInvert"});if(qr){let w=Date.now();if(qr.data!==q||w-t>500){q=qr.data;t=w;try{let j;try{j=JSON.parse(qr.data)}catch{j=null}if(j&&j.marker=="###QRSTART###"&&!g){g=1;e=j.frames;n=j.file;o=j.size||0;f=Array(e).fill('');h=Array(e).fill(0);log(`Start:${n},Frames:${e}`);updGrid()}else if(j&&j.marker=="#DATA#"&&g){let p=j.current-1;blink(p);if(p<f.length&&!h[p]){f[p]=j.contents;h[p]=1;log(`Frame ${p+1}/${e}`);updGrid()}}if(g&&h.every(v=>v)){let b64=f.join(''),raw=atob(b64);log(`Decoded:${raw.length}`);let bytes=new Uint8Array(raw.length);for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);let b=new Blob([bytes],{type:'application/octet-stream'});let a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n.replace(/\.b64$/,'');a.click();URL.revokeObjectURL(a.href);log(`Done:${n}`);stopCam()}}catch(e){log(e)}}}}catch(e){}}requestAnimationFrame(loop)};b1.onclick=start;b2.onclick=stopCam;log('Ready')</script></body></html>
