<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Ultra Minimal QR Decoder v3.0</title>
<style>
body{font-family:Arial,sans-serif;padding:10px;max-width:600px;margin:0 auto;background:#f9fafb}
.box{border:1px solid #ccc;padding:15px;margin:10px 0;border-radius:6px;background:white}
textarea{width:100%;height:80px;margin:8px 0;border:1px solid #ddd;border-radius:4px;padding:8px}
button{background:#2563eb;color:white;border:none;padding:10px 18px;margin:4px;border-radius:4px;cursor:pointer;font-weight:600}
button:hover{background:#1d4ed8}
button:disabled{background:#94a3b8;cursor:not-allowed}
.success{background:#dcfce7;color:#16a34a;border-color:#22c55e}
.error{background:#fef2f2;color:#dc2626;border-color:#ef4444}
.warning{background:#fffbeb;color:#d97706;border-color:#f59e0b}
.progress{width:100%;height:12px;background:#e5e7eb;margin:8px 0;border-radius:6px;overflow:hidden}
.bar{height:100%;background:#2563eb;width:0%;transition:width 0.3s;border-radius:6px}
.file-info{display:none;background:#f0f9ff;border:1px solid #0ea5e9;margin:10px 0;padding:12px;border-radius:6px}
.chunk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(20px,1fr));gap:2px;margin:10px 0}
.chunk{width:20px;height:20px;border-radius:2px;background:#e5e7eb}
.chunk.received{background:#22c55e}
.stats{font-size:12px;color:#6b7280;margin-top:8px}
</style></head>
<body>
<h2>üì± Ultra Minimal QR Decoder v3.0</h2>
<p><small>Compatible with fountain coding and v3.0 encoder format</small></p>

<div class="box">
<b>üìã Scan QR ‚Üí Paste Here ‚Üí Click Add:</b><br>
<textarea id="qr" placeholder="Paste QR text here..."></textarea>
<button onclick="add()">Add QR</button>
<button onclick="clear()">Clear</button>
<button onclick="reset()">Reset All</button>
</div>

<div id="msg" class="box">Ready! Use phone camera/QR app ‚Üí scan ‚Üí paste ‚Üí add</div>
<div class="progress"><div id="bar" class="bar"></div></div>

<div id="info" class="file-info">
<div id="file-details"></div>
<div class="chunk-grid" id="chunks"></div>
<div class="stats" id="stats"></div>
</div>

<div id="down" style="display:none">
<button onclick="download()" style="background:#16a34a;font-size:18px;padding:15px 30px">üì• Download File</button>
</div>

<script>
let files={},curr='',chunks={},sourceChunks={},codedPackets=[],total=0,got=0,fileData=null,metadata=null;

function add(){
const d=document.getElementById('qr').value.trim();
if(!d){msg('‚ö†Ô∏è Paste QR data first','error');return}

try{
if(d.startsWith('M:')){
// Parse v3.0 metadata format
// M:3.0:filename:filetype:filesize:chunks:packets:systematicchunks:density:fps:chunksize:redund:ecl:metachecksum:filechecksum:ltparams:fountainmaxdegree
const p=d.split(':');
if(p.length<17){msg('‚ö†Ô∏è Invalid metadata format','error');return}

curr=decodeURIComponent(p[2]);
const fileSize=parseInt(p[4]);
total=parseInt(p[5]);
const totalPackets=parseInt(p[6]);

metadata={
fileName:curr,
fileSize:fileSize,
chunksCount:total,
totalPackets:totalPackets,
chunkSize:parseInt(p[10]),
redundancy:parseInt(p[11])
};

chunks={};sourceChunks={};codedPackets=[];got=0;fileData=null;
files[curr]={name:curr,size:fileSize,total:total,chunks:{},sourceChunks:{}};

document.getElementById('file-details').innerHTML=`<b>üìÑ ${curr}</b><br>Size: ${fmt(fileSize)}<br>Chunks: 0/${total}<br>Packets: 0/${totalPackets}`;
document.getElementById('info').style.display='block';
initChunkGrid(total);
msg(`üìÅ File: ${curr} (${total} chunks)`,'success');

}else if(d.startsWith('D:')&&curr){
// Parse v3.0 data format
// D:packetId:seed:seedBase:numChunks:degree:data
const p=d.split(':');
if(p.length<7){msg('‚ö†Ô∏è Invalid data format','error');return}

const degree=parseInt(p[5]);
const dataField=p.slice(6).join(':');

if(degree===1){
// Systematic packet (single chunk)
const chunkIndex=parseInt(dataField.split(':')[0]);
const chunkData=dataField.split(':')[1];

if(!sourceChunks[chunkIndex]){
sourceChunks[chunkIndex]=base64ToBytes(chunkData);
got++;
updateChunkGrid(chunkIndex);
msg(`‚úÖ Chunk ${chunkIndex+1}/${total} (${got}/${total})`,got===total?'success':'warning');
}

}else if(degree===2){
// Systematic packet (two chunks)  
const parts=dataField.split('|');
for(const part of parts){
const [chunkIndex,chunkData]=part.split(':');
const idx=parseInt(chunkIndex);
if(!sourceChunks[idx]){
sourceChunks[idx]=base64ToBytes(chunkData);
got++;
updateChunkGrid(idx);
}
}
msg(`‚úÖ Multi-chunk packet: ${got}/${total}`,got===total?'success':'warning');

}else{
// Fountain coded packet - store for later processing
const sourceIndices=p[6].split(',').map(x=>parseInt(x));
const xorData=base64ToBytes(p[7]);
codedPackets.push({sourceIndices,xorData});
msg(`üì¶ Fountain packet (degree ${degree}): ${codedPackets.length} stored`,'warning');
}

// Try fountain decoding after each packet
if(got<total)fountainDecode();

// Check completion
if(got===total){
const result=new Uint8Array(metadata.fileSize);
let offset=0;
for(let i=0;i<total;i++){
if(sourceChunks[i]){
const chunkBytes=sourceChunks[i];
const copyLen=Math.min(chunkBytes.length,metadata.fileSize-offset);
result.set(chunkBytes.slice(0,copyLen),offset);
offset+=copyLen;
}
}
fileData=result;
document.getElementById('down').style.display='block';
msg(`üéâ File complete! ${got}/${total} chunks recovered`,'success');
}

updateStats();

}else{
msg('‚ö†Ô∏è Unknown format or no active file','error');
}

document.getElementById('qr').value='';
document.getElementById('bar').style.width=(got/total*100)+'%';

}catch(e){
msg('‚ùå Error: '+e.message,'error');
console.error(e);
}
}

// Simple fountain decoder
function fountainDecode(){
let progress=true;
while(progress&&got<total){
progress=false;
for(let i=codedPackets.length-1;i>=0;i--){
const packet=codedPackets[i];
const missing=packet.sourceIndices.filter(idx=>!sourceChunks[idx]);

if(missing.length===0){
// All chunks known, remove packet
codedPackets.splice(i,1);
continue;
}

if(missing.length===1){
// Can recover one chunk
const missingIdx=missing[0];
const result=new Uint8Array(packet.xorData);

// XOR with known chunks
for(const idx of packet.sourceIndices){
if(idx!==missingIdx&&sourceChunks[idx]){
xorArrays(result,sourceChunks[idx]);
}
}

sourceChunks[missingIdx]=result;
got++;
updateChunkGrid(missingIdx);
codedPackets.splice(i,1);
progress=true;
}
}
}
}

function xorArrays(a,b){
for(let i=0;i<Math.min(a.length,b.length);i++){
a[i]^=b[i];
}
}

function base64ToBytes(base64){
const binary=atob(base64);
const bytes=new Uint8Array(binary.length);
for(let i=0;i<binary.length;i++){
bytes[i]=binary.charCodeAt(i);
}
return bytes;
}

function initChunkGrid(total){
const grid=document.getElementById('chunks');
grid.innerHTML='';
for(let i=0;i<total;i++){
const chunk=document.createElement('div');
chunk.className='chunk';
chunk.id='chunk-'+i;
chunk.title='Chunk '+(i+1);
grid.appendChild(chunk);
}
}

function updateChunkGrid(index){
const chunk=document.getElementById('chunk-'+index);
if(chunk)chunk.classList.add('received');
}

function updateStats(){
const stats=document.getElementById('stats');
stats.innerHTML=`Recovered: ${got}/${total} chunks | Fountain packets: ${codedPackets.length} | Recovery rate: ${(got/total*100).toFixed(1)}%`;
}

function clear(){
document.getElementById('qr').value='';
msg('Cleared input','success');
}

function reset(){
files={};curr='';chunks={};sourceChunks={};codedPackets=[];total=0;got=0;fileData=null;metadata=null;
document.getElementById('info').style.display='none';
document.getElementById('down').style.display='none';
document.getElementById('bar').style.width='0%';
msg('Reset complete - ready for new file','success');
}

function download(){
if(!fileData||!metadata){msg('‚ùå No file to download','error');return}
const blob=new Blob([fileData]);
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=metadata.fileName||'decoded-file.bin';
a.click();
URL.revokeObjectURL(url);
msg('üì• Download started','success');
}

function msg(text,type){
const el=document.getElementById('msg');
el.textContent=text;
el.className='box '+(type||'');
}

function fmt(bytes){
if(bytes<1024)return bytes+' B';
if(bytes<1048576)return Math.round(bytes/1024)+' KB';
return Math.round(bytes/1048576)+' MB';
}
</script>
</body></html>